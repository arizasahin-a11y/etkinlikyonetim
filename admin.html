<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Admin - Veri YÃ¶netimi</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            max-width: 900px;
            margin: auto;
            background-color: #f4f6f8;
        }

        .kutu {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h2 {
            color: #2c3e50;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #eee;
            color: #555;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            margin-right: 5px;
            transition: 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-blue {
            background: #3498db;
        }

        .btn-green {
            background: #2ecc71;
        }

        .btn-red {
            background: #e74c3c;
        }

        .btn-orange {
            background: #f39c12;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            color: white;
        }

        .bg-active {
            background: #2ecc71;
        }

        .bg-archived {
            background: #95a5a6;
        }

        .upload-area {
            border: 2px dashed #ccc;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }
    </style>
</head>

<body>
    <h2>ğŸš€ VeritabanÄ± YÃ¶netimi (Admin)</h2>

    <div class="kutu">
        <h3>â¬†ï¸ Dosya YÃ¼kle (PostgreSQL'e Aktar)</h3>
        <p style="font-size:0.9em; color:#666; margin-top:-10px; margin-bottom:15px;">
            Ã–zellikle <b>veritabani.json</b> dosyanÄ±zÄ± buradan yÃ¼klemeyi unutmayÄ±nÄ±z.
        </p>
        <div class="upload-area" onclick="document.getElementById('f').click()">
            ğŸ“‚ DosyalarÄ± seÃ§mek iÃ§in tÄ±klayÄ±n (Ã‡oklu seÃ§im yapÄ±labilir)
            <input type="file" id="f" accept=".json" multiple style="display:none" onchange="yukle()">
        </div>
    </div>

    <div class="kutu">
        <h3>ğŸ“‚ VeritabanÄ±ndaki Dosyalar <button onclick="sunucuyuYenidenBaslat()" class="btn btn-red"
                style="float:right">Sunucuyu Yeniden BaÅŸlat</button></h3>
        <table>
            <thead>
                <tr>
                    <th style="width: 50%;">Dosya AdÄ±</th>
                    <th>Durum</th>
                    <th style="text-align: right;">Ä°ÅŸlemler</th>
                </tr>
            </thead>
            <tbody id="liste"></tbody>
        </table>
    </div>

    <script>
        window.onload = listele;

        async function listele() {
            try {
                const res = await fetch('/yonetimDosyaListesi');
                const dosyalar = await res.json();
                const tbody = document.getElementById('liste');
                tbody.innerHTML = "";

                if (dosyalar.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#777;">VeritabanÄ±nda kayÄ±tlÄ± dosya yok.</td></tr>';
                    return;
                }

                dosyalar.forEach(d => {
                    const badge = d.arsivde ?
                        '<span class="badge bg-archived">ArÅŸivde</span>' :
                        '<span class="badge bg-active">Aktif</span>';

                    const safeName = d.dosya_adi.replace(/'/g, "\\'");

                    const arsivBtn = d.arsivde ?
                        `<button onclick="arsivle('${safeName}', false)" class="btn btn-green">Aktif Et</button>` :
                        `<button onclick="arsivle('${safeName}', true)" class="btn btn-orange">ArÅŸivle</button>`;

                    tbody.innerHTML += `
                        <tr>
                            <td><b>${d.dosya_adi}</b></td>
                            <td>${badge}</td>
                            <td style="text-align: right;">
                                <button class="btn btn-blue" onclick="indir('${safeName}')">â¬‡ï¸ Ä°ndir</button>
                                ${arsivBtn}
                                <button class="btn btn-red" onclick="sil('${safeName}')">ğŸ—‘ï¸ Sil</button>
                            </td>
                        </tr>`;
                });
            } catch (e) { console.error("Listeleme hatasÄ±:", e); }
        }

        async function indir(isim) {
            try {
                const res = await fetch(`/calismaGetir?isim=${encodeURIComponent(isim)}`);
                if (!res.ok) throw new Error("Dosya alÄ±namadÄ±.");
                const data = await res.json();
                const blob = new Blob([JSON.stringify(data, null, 4)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = isim;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (e) { alert("Hata: " + e.message); }
        }

        async function yukle() {
            const files = document.getElementById('f').files;
            if (files.length === 0) return alert("Dosya seÃ§ilmedi!");

            let sayac = 0;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = JSON.parse(e.target.result);
                        await fetch('/kaydet', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ dosyaAdi: file.name, veri: content })
                        });
                        sayac++;
                        if (sayac === files.length) {
                            alert("YÃ¼klendi!"); listele();
                        }
                    } catch (err) {
                        alert(file.name + " hatasÄ±: JSON formatÄ± bozuk olabilir.");
                    }
                };
                reader.readAsText(file);
            }
        }

        async function sil(isim) {
            if (!confirm(`"${isim}" dosyasÄ±nÄ± KALICI OLARAK silmek istediÄŸinize emin misiniz?`)) return;
            await fetch('/calismaSil', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ calismaIsmi: isim })
            });
            listele();
        }

        async function arsivle(isim, durum) {
            await fetch('/arsivGuncelle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dosyaIsmi: isim, durum: durum })
            });
            listele();
        }
        async function sunucuyuYenidenBaslat() {
            if (!confirm("Sunucu yeniden baÅŸlatÄ±lacak. Emin misiniz?")) return;
            try {
                await fetch('/restart', { method: 'POST' });
                alert("Sunucu yeniden baÅŸlatÄ±lÄ±yor... LÃ¼tfen 5-10 saniye bekleyip sayfayÄ± yenileyin.");
                setTimeout(() => location.reload(), 5000);
            } catch (e) {
                alert("Hata: " + e.message);
            }
        }
    </script>
</body>

</html>