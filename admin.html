<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Admin - Veri YÃ¶netimi</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 30px;
            max-width: 1100px;
            margin: auto;
            background-color: #f0f4f8;
            color: #333;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 24px;
        }

        /* Modern Grid Layout */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .kutu {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .kutu h3 {
            margin-top: 0;
            color: #34495e;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Buttons */
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-blue {
            background: #3498db;
        }

        .btn-green {
            background: #2ecc71;
        }

        .btn-red {
            background: #e74c3c;
        }

        .btn-orange {
            background: #f39c12;
        }

        .btn-dark {
            background: #34495e;
        }

        /* Drag & Drop Area */
        .upload-area {
            border: 2px dashed #bdc3c7;
            padding: 40px 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fdfdfd;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #3498db;
            background: #ebf5fb;
        }

        .upload-icon {
            font-size: 36px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #7f8c8d;
            font-size: 15px;
            margin-bottom: 15px;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #ecf0f1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 15px;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #fcfcfc;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .bg-active {
            background: #e8f8f5;
            color: #1abc9c;
        }

        .bg-archived {
            background: #f2f4f4;
            color: #7f8c8d;
        }

        .file-icon {
            font-size: 18px;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* Full width card for list */
        .full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h2>ğŸš€ VeritabanÄ± YÃ¶netimi Merkezi</h2>
        <button onclick="sunucuyuYenidenBaslat()" class="btn btn-red">ğŸ”„ Sunucuyu Yeniden BaÅŸlat</button>
    </div>

    <div class="grid-container">
        <!-- Yedekleme KartÄ± -->
        <div class="kutu">
            <h3>â˜ï¸ Sistemi Yedekle / Kurtar</h3>
            <p style="font-size:14px; color:#7f8c8d; margin-bottom:20px; line-height:1.5;">
                TÃ¼m veritabanÄ± kayÄ±tlarÄ±nÄ±zÄ± tek bir ZIP dosyasÄ± olarak indirebilirsiniz.
                Geri yÃ¼kleme iÅŸlemi yapmadan Ã¶nce yedek almanÄ±z ÅŸiddetle tavsiye edilir.
            </p>

            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button onclick="location.href='/yedekAl'" class="btn btn-blue"
                    style="width: 100%; padding: 12px; font-size: 15px;">
                    â¬‡ï¸ TÃ¼m Sistemi Ä°ndir (ZIP)
                </button>

                <div style="position: relative; border-top: 1px dashed #ddd; margin: 5px 0;"></div>

                <input type="file" id="yedekInput" accept=".zip" style="display:none" onchange="yedekYukle()">
                <button onclick="document.getElementById('yedekInput').click()" class="btn btn-orange"
                    style="width: 100%; padding: 12px; font-size: 15px;" id="btnRestore">
                    â¬†ï¸ Sistem YedeÄŸi YÃ¼kle (Restore)
                </button>
            </div>
        </div>

        <!-- Tekil Ekleme KartÄ± -->
        <div class="kutu">
            <h3>â• JSON Veri DosyasÄ± YÃ¼kle</h3>
            <p style="font-size:14px; color:#7f8c8d; margin-bottom:15px;">
                Ã‡alÄ±ÅŸma, grup veya atama JSON dosyalarÄ±nÄ±zÄ± buraya sÃ¼rÃ¼kleyip bÄ±rakarak sisteme veri halinde
                kaydedebilirsiniz.
            </p>

            <input type="file" id="f" accept=".json" multiple style="display:none" onchange="yukle()">
            <div class="upload-area" id="dropZone" onclick="document.getElementById('f').click()">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">DosyalarÄ± seÃ§mek iÃ§in tÄ±klayÄ±n veya<br>sÃ¼rÃ¼kleyip buraya bÄ±rakÄ±n</div>
                <button class="btn btn-dark">Dosya SeÃ§</button>
            </div>
        </div>

        <!-- Dosya Listesi KartÄ± -->
        <div class="kutu full-width">
            <h3>ğŸ“‚ VeritabanÄ± KayÄ±tlarÄ±</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50%;">KayÄ±t AdÄ±</th>
                            <th style="width: 15%;">Durum</th>
                            <th style="text-align: right;">Aksiyonlar</th>
                        </tr>
                    </thead>
                    <tbody id="liste">
                        <tr>
                            <td colspan="3" style="text-align:center; padding:30px; color:#7f8c8d;">YÃ¼kleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // DRAG & DROP LOGIC
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('f');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files; // Assign files to input
                yukle(); // Trigger upload function
            }
        });

        // TÄ°PE GÃ–RE Ä°KON SEÃ‡Ä°CÄ°
        function getFileIcon(filename) {
            if (filename.startsWith('qwx')) return 'ğŸ“'; // Ã‡alÄ±ÅŸma/GÃ¶rev
            if (filename.startsWith('qqq')) return 'ğŸ¯'; // Atama
            if (filename.startsWith('www_')) return 'ğŸ“Š'; // DeÄŸerlendirme/Cevap
            if (filename.startsWith('ggg') || filename.includes('GruplarÄ±')) return 'ğŸ‘¥'; // Grup
            return 'ğŸ“„'; // DiÄŸer
        }

        window.onload = listele;

        async function listele() {
            try {
                const res = await fetch('/yonetimDosyaListesi');
                const dosyalar = await res.json();
                const tbody = document.getElementById('liste');
                tbody.innerHTML = "";

                if (dosyalar.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:30px; color:#7f8c8d;">VeritabanÄ±nda kayÄ±tlÄ± veri bulunmuyor.</td></tr>';
                    return;
                }

                dosyalar.sort((a, b) => a.dosya_adi.localeCompare(b.dosya_adi));

                dosyalar.forEach(d => {
                    const badge = d.arsivde ?
                        '<span class="badge bg-archived">ArÅŸivde</span>' :
                        '<span class="badge bg-active">Aktif</span>';

                    const safeName = d.dosya_adi.replace(/'/g, "\\'");
                    const icon = getFileIcon(d.dosya_adi);

                    const arsivBtn = d.arsivde ?
                        `<button onclick="arsivle('${safeName}', false)" class="btn btn-green">ğŸ‘ï¸ Aktif Et</button>` :
                        `<button onclick="arsivle('${safeName}', true)" class="btn btn-orange">ğŸ“¦ ArÅŸivle</button>`;

                    tbody.innerHTML += `
                    <tr>
                        <td><span class="file-icon">${icon}</span><b>${d.dosya_adi}</b></td>
                        <td>${badge}</td>
                        <td style="text-align: right;">
                            <button class="btn btn-blue" onclick="indir('${safeName}')">â¬‡ï¸ Ä°ndir</button>
                            ${arsivBtn}
                            <button class="btn btn-red" onclick="sil('${safeName}')">ğŸ—‘ï¸ Sil</button>
                        </td>
                    </tr>`;
                });
            } catch (e) {
                console.error("Listeleme hatasÄ±:", e);
                document.getElementById('liste').innerHTML = `<tr><td colspan="3" style="color:red; text-align:center;">Veriler yÃ¼klenirken hata oluÅŸtu!</td></tr>`;
            }
        }

        async function indir(isim) {
            try {
                const res = await fetch(`/calismaGetir?isim=${encodeURIComponent(isim)}`);
                if (!res.ok) throw new Error("Dosya veritabanÄ±ndan alÄ±namadÄ±.");
                const data = await res.json();
                const blob = new Blob([JSON.stringify(data, null, 4)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = isim;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (e) { alert("Hata: " + e.message); }
        }

        async function yedekYukle() {
            const fileInput = document.getElementById('yedekInput');
            const restoreBtn = document.getElementById('btnRestore');
            if (fileInput.files.length === 0) return;
            const file = fileInput.files[0];

            if (!confirm(`DÄ°KKAT! "${file.name}" yedeÄŸini geri yÃ¼klemek Ã¼zeresiniz.\n\nBu iÅŸlem mevcut sistemi ve verileri gÃ¼ncelleyecektir.\n\nEmin misiniz?`)) {
                fileInput.value = "";
                return;
            }

            const formData = new FormData();
            formData.append('yedekDosyasi', file);

            try {
                restoreBtn.innerHTML = "â³ YÃ¼kleniyor... LÃ¼tfen bekleyin";
                restoreBtn.disabled = true;

                const res = await fetch('/yedekYukle', {
                    method: 'POST',
                    body: formData
                });

                const result = await res.json();

                if (result.status === "ok") {
                    alert(`âœ… Geri YÃ¼kleme BaÅŸarÄ±lÄ±!\n\nÃ–zet:\n${result.message}`);
                    listele();
                } else {
                    alert("âŒ Hata: " + result.message);
                }
            } catch (err) {
                alert("YÃ¼kleme HatasÄ±: " + err.message);
            } finally {
                fileInput.value = "";
                restoreBtn.innerHTML = "â¬†ï¸ Sistem YedeÄŸi YÃ¼kle (Restore)";
                restoreBtn.disabled = false;
            }
        }

        async function yukle() {
            const files = document.getElementById('f').files;
            if (files.length === 0) return alert("Dosya seÃ§ilmedi!");

            let sayac = 0;
            let errors = [];

            const dropZone = document.getElementById('dropZone');
            const originalHTML = dropZone.innerHTML;
            dropZone.innerHTML = `<div class="upload-icon">â³</div><div class="upload-text">YÃ¼kleniyor (${files.length} dosya)...</div>`;
            dropZone.style.pointerEvents = "none";

            for (let file of files) {
                const reader = new FileReader();
                await new Promise((resolve) => {
                    reader.onload = async (e) => {
                        try {
                            const content = JSON.parse(e.target.result);
                            const res = await fetch('/kaydet', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ dosyaAdi: file.name, veri: content })
                            });
                            if (!res.ok) throw new Error("Sunucu hatasÄ±");
                            sayac++;
                        } catch (err) {
                            errors.push(file.name);
                        }
                        resolve();
                    };
                    reader.onerror = () => {
                        errors.push(file.name + " (Okuma hatasÄ±)");
                        resolve();
                    };
                    reader.readAsText(file);
                });
            }

            dropZone.innerHTML = originalHTML;
            dropZone.style.pointerEvents = "auto";
            document.getElementById('f').value = ""; // reset input

            if (errors.length > 0) {
                alert(`âš ï¸ YÃ¼kleme tamamlandÄ± but bazÄ± hatalar oluÅŸtu!\n\nBaÅŸarÄ±lÄ±: ${sayac}\nHatalÄ±:\n${errors.join('\n')}\n\nNot: JSON formatÄ± bozuk olabilir.`);
            } else {
                alert(`âœ… ${sayac} adet dosya baÅŸarÄ±yla veritabanÄ±na eklendi/gÃ¼ncellendi!`);
            }

            listele();
        }

        async function sil(isim) {
            if (!confirm(`"${isim}" kaydÄ±nÄ± veritabanÄ±ndan KALICI OLARAK silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`)) return;
            await fetch('/calismaSil', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ calismaIsmi: isim })
            });
            listele();
        }

        async function arsivle(isim, durum) {
            await fetch('/arsivGuncelle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dosyaIsmi: isim, durum: durum })
            });
            listele();
        }

        async function sunucuyuYenidenBaslat() {
            if (!confirm("Sunucuyu yeniden baÅŸlatmak Ã¼zeresiniz. Ä°ÅŸlemi onaylÄ±yor musunuz?")) return;
            try {
                await fetch('/restart', { method: 'POST' });
                alert("Sunucu yeniden baÅŸlatÄ±lÄ±yor... LÃ¼tfen 5-10 saniye bekleyip sayfayÄ± yenileyin.");
                setTimeout(() => location.reload(), 5000);
            } catch (e) {
                alert("Hata: " + e.message);
            }
        }
    </script>
</body>

</html>