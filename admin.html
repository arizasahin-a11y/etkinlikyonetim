<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Admin - Veri Y√∂netimi</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            max-width: 900px;
            margin: auto;
            background-color: #f4f6f8;
        }

        .kutu {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h2 {
            color: #2c3e50;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #eee;
            color: #555;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            margin-right: 5px;
            transition: 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-blue {
            background: #3498db;
        }

        .btn-green {
            background: #2ecc71;
        }

        .btn-red {
            background: #e74c3c;
        }

        .btn-orange {
            background: #f39c12;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            color: white;
        }

        .bg-active {
            background: #2ecc71;
        }

        .bg-archived {
            background: #95a5a6;
        }

        .upload-area {
            border: 2px dashed #ccc;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }
    </style>
</head>

<body>
    <h2>üöÄ Veritabanƒ± Y√∂netimi (Admin)</h2>

    <div class="kutu">
        <h3>‚òÅÔ∏è Yedekleme ve Geri Y√ºkleme</h3>
        <p style="font-size:0.9em; color:#666;">Verilerinizi d√ºzenli olarak yedekleyin. Geri y√ºkleme i≈ülemi mevcut
            verilerin √ºzerine yazabilir!</p>

        <div style="display:flex; gap:20px; align-items:center;">
            <button onclick="location.href='/yedekAl'" class="btn btn-green"
                style="padding:15px 30px; font-size:1.1em;">
                ‚¨áÔ∏è YEDEK ƒ∞NDƒ∞R (ZIP)
            </button>

            <div style="border-left:1px solid #ddd; padding-left:20px;">
                <input type="file" id="yedekInput" accept=".zip" style="display:none" onchange="yedekYukle()">
                <button onclick="document.getElementById('yedekInput').click()" class="btn btn-red"
                    style="padding:15px 30px; font-size:1.1em;">
                    ‚¨ÜÔ∏è YEDEK Y√úKLE (Restore)
                </button>
            </div>
        </div>
    </div>

    <div class="kutu">
        <h3>‚¨ÜÔ∏è Dosya Y√ºkle (Tekil JSON)</h3>

        <div class="kutu">
            <h3>üìÇ Veritabanƒ±ndaki Dosyalar <button onclick="sunucuyuYenidenBaslat()" class="btn btn-red"
                    style="float:right">Sunucuyu Yeniden Ba≈ülat</button></h3>
            <table>
                <thead>
                    <tr>
                        <th style="width: 50%;">Dosya Adƒ±</th>
                        <th>Durum</th>
                        <th style="text-align: right;">ƒ∞≈ülemler</th>
                    </tr>
                </thead>
                <tbody id="liste"></tbody>
            </table>
        </div>

        <script>
            window.onload = listele;

            async function listele() {
                try {
                    const res = await fetch('/yonetimDosyaListesi');
                    const dosyalar = await res.json();
                    const tbody = document.getElementById('liste');
                    tbody.innerHTML = "";

                    if (dosyalar.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#777;">Veritabanƒ±nda kayƒ±tlƒ± dosya yok.</td></tr>';
                        return;
                    }

                    dosyalar.forEach(d => {
                        const badge = d.arsivde ?
                            '<span class="badge bg-archived">Ar≈üivde</span>' :
                            '<span class="badge bg-active">Aktif</span>';

                        const safeName = d.dosya_adi.replace(/'/g, "\\'");

                        const arsivBtn = d.arsivde ?
                            `<button onclick="arsivle('${safeName}', false)" class="btn btn-green">Aktif Et</button>` :
                            `<button onclick="arsivle('${safeName}', true)" class="btn btn-orange">Ar≈üivle</button>`;

                        tbody.innerHTML += `
                        <tr>
                            <td><b>${d.dosya_adi}</b></td>
                            <td>${badge}</td>
                            <td style="text-align: right;">
                                <button class="btn btn-blue" onclick="indir('${safeName}')">‚¨áÔ∏è ƒ∞ndir</button>
                                ${arsivBtn}
                                <button class="btn btn-red" onclick="sil('${safeName}')">üóëÔ∏è Sil</button>
                            </td>
                        </tr>`;
                    });
                } catch (e) { console.error("Listeleme hatasƒ±:", e); }
            }

            async function indir(isim) {
                try {
                    const res = await fetch(`/calismaGetir?isim=${encodeURIComponent(isim)}`);
                    if (!res.ok) throw new Error("Dosya alƒ±namadƒ±.");
                    const data = await res.json();
                    const blob = new Blob([JSON.stringify(data, null, 4)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = isim;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (e) { alert("Hata: " + e.message); }
            }

            async function yedekYukle() {
                const fileInput = document.getElementById('yedekInput');
                if (fileInput.files.length === 0) return;
                const file = fileInput.files[0];

                if (!confirm(`Dƒ∞KKAT! "${file.name}" yedeƒüini geri y√ºklemek √ºzeresiniz.\n\nBu i≈ülem mevcut verilerin g√ºncellenmesine veya deƒüi≈ümesine neden olabilir.\n\nEmin misiniz?`)) {
                    fileInput.value = "";
                    return;
                }

                const formData = new FormData();
                formData.append('yedekDosyasi', file);

                try {
                    // Show loading
                    const originalText = fileInput.nextElementSibling.innerText;
                    fileInput.nextElementSibling.innerText = "Y√ºkleniyor...";
                    fileInput.nextElementSibling.disabled = true;

                    const res = await fetch('/yedekYukle', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await res.json();

                    if (result.status === "ok") {
                        alert(`‚úÖ Geri Y√ºkleme Ba≈üarƒ±lƒ±!\n\n√ñzet:\n${result.message}`);
                        listele();
                    } else {
                        alert("‚ùå Hata: " + result.message);
                    }
                } catch (err) {
                    alert("Y√ºkleme Hatasƒ±: " + err.message);
                } finally {
                    fileInput.value = "";
                    fileInput.nextElementSibling.innerText = "‚¨ÜÔ∏è YEDEK Y√úKLE (Restore)";
                    fileInput.nextElementSibling.disabled = false;
                }
            }

            async function yukle() {
                const files = document.getElementById('f').files;
                if (files.length === 0) return alert("Dosya se√ßilmedi!");

                let sayac = 0;
                for (let file of files) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const content = JSON.parse(e.target.result);
                            await fetch('/kaydet', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ dosyaAdi: file.name, veri: content })
                            });
                            sayac++;
                            if (sayac === files.length) {
                                alert("Y√ºklendi!"); listele();
                            }
                        } catch (err) {
                            alert(file.name + " hatasƒ±: JSON formatƒ± bozuk olabilir.");
                        }
                    };
                    reader.readAsText(file);
                }
            }

            async function sil(isim) {
                if (!confirm(`"${isim}" dosyasƒ±nƒ± KALICI OLARAK silmek istediƒüinize emin misiniz?`)) return;
                await fetch('/calismaSil', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ calismaIsmi: isim })
                });
                listele();
            }

            async function arsivle(isim, durum) {
                await fetch('/arsivGuncelle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dosyaIsmi: isim, durum: durum })
                });
                listele();
            }
            async function sunucuyuYenidenBaslat() {
                if (!confirm("Sunucu yeniden ba≈ülatƒ±lacak. Emin misiniz?")) return;
                try {
                    await fetch('/restart', { method: 'POST' });
                    alert("Sunucu yeniden ba≈ülatƒ±lƒ±yor... L√ºtfen 5-10 saniye bekleyip sayfayƒ± yenileyin.");
                    setTimeout(() => location.reload(), 5000);
                } catch (e) {
                    alert("Hata: " + e.message);
                }
            }
        </script>
</body>

</html>