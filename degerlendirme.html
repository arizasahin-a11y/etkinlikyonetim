<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deƒüerlendirme Paneli</title>
    <style>
        :root {
            --ana: #2E8B57;
            --yesil: #2e7d32;
            --kirmizi: #d32f2f;
            --gri: #607d8b;
            --zemin: #f5f5f5;
            --turuncu: #FF9800;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--zemin);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: var(--ana);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            height: 50px;
            flex-shrink: 0;
        }

        .header h1 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .header-left {
            position: absolute;
            left: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 10px;
            border-radius: 6px;
        }

        .header-right {
            position: absolute;
            right: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
        }

        .teacher-bar {
            background: #fff;
            padding: 10px;
            border-bottom: 2px solid var(--ana);
            display: none;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        .teacher-bar select {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            min-width: 150px;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
        }

        .card {
            background: white;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: row;
            flex: 1;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .soru-bolumu {
            background: #e8f5e9;
            padding: 15px;
            border-right: 1px solid #c8e6c9;
            color: #1b5e20;
            overflow-y: auto;
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
        }

        .soru-baslik {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--ana);
            margin-bottom: 8px;
            display: block;
        }

        .soru-icerik {
            font-size: 1.05rem;
            line-height: 1.4;
            font-weight: 600;
        }

        .cevap-bolumu {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            background: #fff;
        }

        .cevap-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            padding: 10px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
        }

        .cevap-metin {
            flex: 1;
            font-size: 0.95rem;
            color: #333;
            white-space: pre-wrap;
            line-height: 1.4;
            margin-top: 4px;
        }

        .cevap-puan-btn {
            border: 1px solid #ccc;
            background: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #666;
            flex-shrink: 0;
        }

        .btn-dogru-aktif {
            background: var(--yesil) !important;
            color: white !important;
            border-color: var(--yesil) !important;
            transform: scale(1.1);
        }

        .btn-yanlis-aktif {
            background: var(--kirmizi) !important;
            color: white !important;
            border-color: var(--kirmizi) !important;
            transform: scale(1.1);
        }

        .controls {
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        button.nav-btn {
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            flex: 1;
        }

        .btn-geri {
            background: var(--gri);
        }

        .btn-ileri {
            background: var(--ana);
        }

        .btn-bitir {
            background: #d84315;
            flex: 2;
            display: none;
        }

        .sonuc-kutusu {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 100;
            border-top: 5px solid var(--ana);
        }

        .sonuc-puan {
            font-size: 3.5rem;
            color: #333;
            font-weight: bold;
            margin: 10px 0;
            display: block;
        }

        #sonuc_detay {
            text-align: left;
            margin: 15px 0;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #eee;
            font-size: 0.95rem;
        }

        .tamamlandi-uyari {
            display: none;
            background: #fff;
            border: 2px solid #2E7D32;
            color: #2E7D32;
            padding: 40px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 500px;
            z-index: 200;
        }
    </style>
</head>

<body>

    <div class="header">
        <div id="header_info" class="header-left">--</div>
        <h1>Deƒüerlendirme Sistemi</h1>
        <div class="header-right">PUAN: <span id="h_puan">0</span></div>
    </div>

    <div id="teacher_bar" class="teacher-bar">
        <select id="sel_calisma">
            <option value="">√áalƒ±≈üma Se√ß</option>
        </select>
        <select id="sel_sinif">
            <option value="">Sƒ±nƒ±f Se√ß</option>
        </select>
        <button onclick="TeacherApp.baslat()"
            style="background:var(--ana); color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-weight:bold;">GETƒ∞R</button>
    </div>

    <div class="container">
        <div id="tamamlandi_panel" class="tamamlandi-uyari">
            ‚úÖ BU SINIF DEƒûERLENDƒ∞Rƒ∞LMƒ∞≈ûTƒ∞R
            <br><span style="font-size:1rem; color:#555; font-weight:normal; display:block; margin-top:10px;">Bu sƒ±nƒ±fƒ±n
                deƒüerlendirmesi tamamlanmƒ±≈ü veya listede kaydƒ± yok.</span>
            <button onclick="TeacherApp.resetSelection()"
                style="margin-top:20px; padding:8px 20px; background:#607d8b; color:white; border:none; border-radius:4px; cursor:pointer; font-size:1rem;">Tamam</button>
        </div>

        <div id="main_content" class="card" style="display:none;">
            <div class="soru-bolumu">
                <span class="soru-baslik">SORU <span id="s_no">1</span></span>
                <div id="s_metin" class="soru-icerik"></div>
            </div>
            <div class="cevap-bolumu">
                <div id="cevap_listesi"></div>
            </div>
        </div>

        <div id="controls_area" class="controls" style="display:none;">
            <button class="nav-btn btn-geri" id="btn_geri" onclick="App.nav(-1)">‚ùÆ Geri</button>
            <button class="nav-btn btn-ileri" id="btn_ileri" onclick="App.nav(1)">ƒ∞leri ‚ùØ</button>
            <button class="nav-btn btn-bitir" id="btn_bitir" onclick="App.bitir()">üíæ Kaydet ve Bitir</button>
        </div>

        <div id="sonuc_ekrani" class="sonuc-kutusu">
            <h2 style="color:var(--ana); margin-top:0;">Deƒüerlendirme Tamamlandƒ±</h2>
            <div id="sonuc_detay"></div>
            <p style="margin-bottom:0; font-weight:bold; color:#555;">TOPLAM PUAN</p>
            <span class="sonuc-puan" id="sonuc_puan_goster">0</span>
            <button onclick="isTeacher ? location.reload() : window.close()" class="nav-btn btn-geri"
                style="width:100%;">Kapat</button>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        let isTeacher = false;

        const State = {
            sorular: [], activeVeri: null, sIdx: 0, anlikPuanlar: {},
            pSinif: params.get('sinif'), pOgrenci: params.get('ogrenci'), pCalisma: params.get('calisma'),
            kuyruk: [], kuyrukIdx: 0, grupCalismasi: false, grupUyeleri: null, grupAdi: ""
        };

        function guncelleToplamPuan() {
            let t = 0;
            if (State.anlikPuanlar) {
                Object.values(State.anlikPuanlar).forEach(arr => {
                    if (Array.isArray(arr)) arr.forEach(p => { if (Number(p) === 1) t++; });
                });
            }
            document.getElementById('h_puan').textContent = t;
            document.getElementById('sonuc_puan_goster').textContent = t;
        }

        const App = {
            init: async () => {
                if (State.pCalisma) {
                    try {
                        const rRaw = await fetch(`/calismaGetir?isim=www_${State.pCalisma}`);
                        if (rRaw.ok) {
                            const data = await rRaw.json();
                            const ayar = data.find(x => x.ogrenciNo === "AYARLAR");
                            if (ayar && ayar.izin) isTeacher = true;
                        }
                    } catch (e) { }
                } else {
                    const kayitliCalisma = sessionStorage.getItem('deg_calisma');
                    if (kayitliCalisma) {
                        State.pCalisma = kayitliCalisma;
                        State.pSinif = sessionStorage.getItem('deg_sinif');
                        isTeacher = true;
                    }
                }

                if (isTeacher) {
                    document.getElementById('teacher_bar').style.display = 'flex';
                    await TeacherApp.setup();

                    if (State.pCalisma && State.pSinif) {
                        const cSel = document.getElementById('sel_calisma');
                        const sSel = document.getElementById('sel_sinif');

                        cSel.value = State.pCalisma;

                        await TeacherApp.siniflariGetir();

                        // Eƒüer sƒ±nƒ±f listede yoksa (yani bitmi≈ü veya hi√ß ba≈ülamamƒ±≈üsa) se√ßim yapma
                        if (![...sSel.options].some(o => o.value === State.pSinif)) {
                            // Sƒ±nƒ±f filtrelendiƒüi i√ßin listeye eklenmedi, bu y√ºzden se√ßilmiyor.
                            // baslat() fonksiyonu bu durumu kontrol edecek.
                        } else {
                            sSel.value = State.pSinif;
                        }

                        TeacherApp.baslat();
                    }
                } else {
                    StudentApp.init();
                }
            },
            renderSoru: () => {
                document.getElementById('s_no').textContent = State.sIdx + 1;
                document.getElementById('s_metin').textContent = State.sorular[State.sIdx];
                const cObj = (State.activeVeri.cevaplar || []).find(c => c.soruIndex === State.sIdx);
                const liste = cObj ? cObj.cevaplar : [];
                const puanlar = State.anlikPuanlar[State.sIdx] || [];

                // Deƒüerlendirme bitti mi kontrol et
                const degerlendirmeBitti = State.activeVeri?.degerlendirme?.bitti === true;

                let h = "";
                liste.forEach((txt, i) => {
                    const p = Number(puanlar[i]);
                    const disabled = degerlendirmeBitti ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : '';
                    h += `<div class="cevap-item"><div class="cevap-metin">${txt}</div>
                    <button class="cevap-puan-btn ${p === 1 ? 'btn-dogru-aktif' : ''}" onclick="App.puanla(${i},1)" ${disabled}>D</button>
                    <button class="cevap-puan-btn ${p === 0 ? 'btn-yanlis-aktif' : ''}" onclick="App.puanla(${i},0)" ${disabled}>Y</button></div>`;
                });
                document.getElementById('cevap_listesi').innerHTML = h || "<i>Cevap yok.</i>";

                document.getElementById('btn_geri').disabled = (State.sIdx === 0);
                const son = (State.sIdx === State.sorular.length - 1);
                document.getElementById('btn_ileri').style.display = son ? "none" : "block";
                document.getElementById('btn_bitir').style.display = son ? "block" : "none";

                // Eƒüer deƒüerlendirme bittiyse bitir butonunu gizle
                if (degerlendirmeBitti) {
                    document.getElementById('btn_bitir').style.display = "none";
                }

                if (isTeacher) document.getElementById('btn_bitir').textContent = "üíæ Sƒ±radaki √ñƒürenci ‚ùØ";
            },
            puanla: async (cIdx, p) => {
                // Deƒüerlendirme bittiyse puanlama yapƒ±lamaz (hem √∂ƒürenci hem √∂ƒüretmen)
                if (State.activeVeri?.degerlendirme?.bitti) {
                    alert("‚ö†Ô∏è Bu deƒüerlendirme tamamlanmƒ±≈ü. Deƒüi≈üiklik yapmak i√ßin 'Deƒüerlendirmeyi Sƒ±fƒ±rla' butonunu kullanƒ±n.");
                    return;
                }

                if (!State.anlikPuanlar[State.sIdx]) State.anlikPuanlar[State.sIdx] = [];
                State.anlikPuanlar[State.sIdx][cIdx] = p;
                guncelleToplamPuan();
                App.renderSoru();

                await fetch("/puanKaydet", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ dosyaAdi: `www_${State.pCalisma}`, ogrenciNo: State.activeVeri.ogrenciNo, sinif: State.pSinif, soruIndex: State.sIdx, cevapIndex: cIdx, puan: p })
                });
            },
            nav: (n) => {
                let yeni = State.sIdx + n;
                if (yeni >= 0 && yeni < State.sorular.length) { State.sIdx = yeni; App.renderSoru(); }
            },
            bitir: async () => {
                if (isTeacher) {
                    let targetMembers = [];
                    const currentItem = State.kuyruk[State.kuyrukIdx];
                    if (currentItem.members && currentItem.members.length > 0) {
                        targetMembers = currentItem.members;
                    } else {
                        targetMembers = [State.activeVeri.ogrenciNo];
                    }

                    const toplamPuan = parseInt(document.getElementById('h_puan').textContent) || 0;

                    const topluVeri = targetMembers.map(no => ({
                        ogrenciNo: no,
                        sinif: State.pSinif,
                        puanlar: State.anlikPuanlar,
                        degerlendirme: { toplam: toplamPuan, bitti: true }
                    }));

                    await fetch("/kaydet", {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ dosyaAdi: `www_${State.pCalisma}`, veri: topluVeri })
                    });

                    State.kuyrukIdx++;
                    TeacherApp.yukle();

                } else {
                    await fetch("/degerlendirmeBitir", {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ dosyaAdi: `www_${State.pCalisma}`, ogrenciNo: State.activeVeri.ogrenciNo, sinif: State.pSinif })
                    });
                    location.reload();
                }
            },
            bitisGoster: async () => {
                const detayDiv = document.getElementById('sonuc_detay');
                let infoHtml = `<div style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:5px;">
                                <strong>SINIF:</strong> ${State.pSinif || 'Belirsiz'}
                            </div>`;

                if (State.grupCalismasi && State.grupUyeleri) {
                    let l = "<strong>GRUP √úYELERƒ∞:</strong><ul style='margin:5px 0; padding-left:20px; font-size:0.9em;'>";
                    State.grupUyeleri.forEach(u => l += `<li>${u["Okul Numaranƒ±z"]} - ${u["Adƒ±nƒ±z Soyadƒ±nƒ±z"]}</li>`);
                    infoHtml += l + "</ul>";
                } else {
                    infoHtml += `<strong>√ñƒûRENCƒ∞:</strong><br>${State.activeVeri.ogrenciNo} - ${State.activeVeri.adSoyad}`;
                }

                detayDiv.innerHTML = infoHtml;
                document.getElementById('main_content').style.display = "none";
                document.getElementById('controls_area').style.display = "none";
                document.getElementById('sonuc_ekrani').style.display = "block";
            }
        };

        const StudentApp = {
            init: async () => {
                const qqqName = "qqq" + (State.pSinif || "").replace(/\s/g, '') + (State.pCalisma || "");
                const [rQ, rS, rD, rV] = await Promise.all([
                    fetch(`/calismaGetir?isim=${qqqName}`),
                    fetch(`/calismaGetir?isim=qwx${State.pCalisma}`),
                    fetch(`/calismaGetir?isim=www_${State.pCalisma}`),
                    fetch('/veritabani.json')
                ]);

                const qqqData = await rQ.json().catch(() => ({}));
                State.grupCalismasi = (qqqData.yontem === "Grup");

                const qwxData = await rS.json();
                State.sorular = qwxData.sorular || [];

                const tum = await rD.json();
                const db = await rV.json().catch(() => ({}));

                // SQL'den gelen veri zaten doƒüru formatta
                let tumOgrenciler = [];
                if (Array.isArray(db)) {
                    tumOgrenciler = db;
                } else if (db && typeof db === 'object') {
                    // Legacy format: { "className": [students], ... }
                    tumOgrenciler = Object.values(db).flat().filter(x => x);
                }

                State.activeVeri = null;

                if (State.grupCalismasi && State.pSinif) {
                    try {
                        const rG = await fetch(`/grupListesiGetir?sinif=${State.pSinif}`);
                        const gruplar = await rG.json();

                        const myGroupIndex = gruplar.findIndex(g => g.some(u => String(u["Okul Numaranƒ±z"]) === String(State.pOgrenci)));

                        if (myGroupIndex !== -1) {
                            const myGroup = gruplar[myGroupIndex];
                            State.grupUyeleri = myGroup;
                            State.grupAdi = `${myGroupIndex + 1}. GRUP`;
                            const groupIds = myGroup.map(u => String(u["Okul Numaranƒ±z"]));
                            State.activeVeri = tum.find(x => groupIds.includes(String(x.ogrenciNo)));
                        }
                    } catch (e) { console.log("Grup hatasƒ±:", e); }
                }

                if (!State.activeVeri) {
                    if (!State.grupCalismasi) {
                        State.activeVeri = tum.find(x => String(x.ogrenciNo) === String(State.pOgrenci));
                    }

                    if (!State.activeVeri) {
                        const ogrenciBilgi = tumOgrenciler.find(x => String(x["Okul Numaranƒ±z"]) === String(State.pOgrenci));
                        const adSoyad = ogrenciBilgi ? ogrenciBilgi["Adƒ±nƒ±z Soyadƒ±nƒ±z"] : "√ñƒürenci";

                        State.activeVeri = {
                            ogrenciNo: State.pOgrenci,
                            adSoyad: adSoyad,
                            sinif: State.pSinif,
                            puanlar: {},
                            degerlendirme: { bitti: false }
                        };
                    }
                }

                if (!State.pSinif && State.activeVeri.sinif) State.pSinif = State.activeVeri.sinif;
                State.anlikPuanlar = State.activeVeri.puanlar || {};

                let headerInfo = "";
                if (State.grupCalismasi && State.grupAdi) {
                    headerInfo = `${State.pSinif} - ${State.grupAdi}`;
                } else {
                    headerInfo = `${State.pSinif} - ${State.activeVeri.ogrenciNo} - ${State.activeVeri.adSoyad}`;
                }
                document.getElementById('header_info').textContent = headerInfo;

                if (State.activeVeri?.degerlendirme?.bitti) {
                    guncelleToplamPuan();
                    App.bitisGoster();
                    return;
                }

                document.getElementById('main_content').style.display = "flex";
                document.getElementById('controls_area').style.display = "flex";
                guncelleToplamPuan();
                App.renderSoru();
            }
        };

        const TeacherApp = {
            db: null,
            setup: async () => {
                const rDb = await fetch('veritabani.json');
                TeacherApp.db = await rDb.json();

                const r = await fetch('/listeCalismalar');
                const list = await r.json();
                const cSel = document.getElementById('sel_calisma');

                list.filter(d => d.startsWith("www_")).forEach(d => {
                    const ad = d.replace("www_", "").replace(".json", "");
                    if (![...cSel.options].some(o => o.value === ad)) cSel.add(new Option(ad, ad));
                });

                cSel.onchange = () => TeacherApp.siniflariGetir();
            },

            siniflariGetir: async () => {
                const calisma = document.getElementById('sel_calisma').value;
                const sSel = document.getElementById('sel_sinif');
                sSel.innerHTML = '<option value="">Sƒ±nƒ±f Se√ß</option>';

                if (!calisma) return;

                let wwwData = [];
                try {
                    const r = await fetch(`/calismaGetir?isim=www_${calisma}`);
                    if (r.ok) wwwData = await r.json();
                } catch (e) { }

                // Sƒ±nƒ±f listesini veritabanƒ±ndan al ve Sƒ∞STEM'i filtrele
                const tumOgrenciler = Object.values(TeacherApp.db)[0];
                const siniflar = [...new Set(tumOgrenciler.map(x => x["Sƒ±nƒ±fƒ±nƒ±z"]))].filter(s => s !== "Sƒ∞STEM");

                // --- FILTRELEME MANTIƒûI: ---
                // 1. Sƒ±nƒ±fƒ±n www_ dosyasƒ±nda hi√ß kaydƒ± yoksa EKLEME.
                // 2. Sƒ±nƒ±fƒ±n www_ dosyasƒ±ndaki t√ºm kayƒ±tlarƒ± "bitti: true" ise EKLEME.
                // 3. Sadece en az bir "bitti: false" veya "bitti: undefined" varsa EKLE.

                siniflar.forEach(sinif => {
                    // Bu sƒ±nƒ±fa ait www_ kayƒ±tlarƒ±
                    const sinifKayitlari = wwwData.filter(x => x.sinif === sinif);

                    // 1. Dosyada hi√ß kaydƒ± yoksa -> Lƒ∞STELEME
                    if (sinifKayitlari.length === 0) return;

                    // 2. T√ºm kayƒ±tlar bitmi≈ü mi?
                    const hepsiBitti = sinifKayitlari.every(k => k.degerlendirme && k.degerlendirme.bitti === true);

                    // Hepsi bitmi≈üse -> Lƒ∞STELEME
                    if (hepsiBitti) return;

                    // Hala i≈ü varsa listeye ekle
                    sSel.add(new Option(sinif, sinif));
                });
            },

            resetSelection: () => {
                sessionStorage.removeItem('deg_calisma');
                sessionStorage.removeItem('deg_sinif');
                sessionStorage.removeItem('deg_idx');
                document.getElementById('sel_calisma').value = "";
                document.getElementById('sel_sinif').innerHTML = '<option value="">Sƒ±nƒ±f Se√ß</option>';
                document.getElementById('tamamlandi_panel').style.display = "none";
                document.getElementById('header_info').textContent = "--";
            },

            baslat: async () => {
                State.pCalisma = document.getElementById('sel_calisma').value || State.pCalisma;
                State.pSinif = document.getElementById('sel_sinif').value || State.pSinif;

                if (!State.pCalisma || !State.pSinif) {
                    document.getElementById('main_content').style.display = "none";
                    document.getElementById('controls_area').style.display = "none";
                    document.getElementById('sonuc_ekrani').style.display = "none";
                    return alert("L√ºtfen √áalƒ±≈üma ve Sƒ±nƒ±f se√ßiniz.");
                }

                // Se√ßimi Kaydet
                sessionStorage.setItem('deg_calisma', State.pCalisma);
                sessionStorage.setItem('deg_sinif', State.pSinif);

                // --- EK G√úVENLƒ∞K: SINIFIN DURUMUNU TEKRAR KONTROL ET ---
                // Eƒüer URL'den zorla girildiyse veya listede yokken hafƒ±zadan geldiyse
                let wwwData = [];
                try {
                    const r = await fetch(`/calismaGetir?isim=www_${State.pCalisma}`);
                    if (r.ok) wwwData = await r.json();
                } catch (e) { }

                const sinifKayitlari = wwwData.filter(x => x.sinif === State.pSinif);

                // Eƒüer hi√ß kayƒ±t yoksa veya hepsi bitmi≈üse -> Kƒ∞Lƒ∞TLE
                let kilitli = false;
                if (sinifKayitlari.length === 0) {
                    kilitli = true; // Hi√ß ba≈ülamamƒ±≈ü (kayƒ±t yok)
                } else {
                    const hepsiBitti = sinifKayitlari.every(k => k.degerlendirme && k.degerlendirme.bitti === true);
                    if (hepsiBitti) kilitli = true;
                }

                if (kilitli) {
                    document.getElementById('main_content').style.display = "none";
                    document.getElementById('controls_area').style.display = "none";
                    document.getElementById('sonuc_ekrani').style.display = "none";
                    document.getElementById('tamamlandi_panel').style.display = "block";
                    return;
                }
                // -------------------------------------------------------------

                document.getElementById('tamamlandi_panel').style.display = "none";

                const qqqName = "qqq" + (State.pSinif || "").replace(/\s/g, '') + (State.pCalisma || "");
                const [rQ, rS, rD] = await Promise.all([
                    fetch(`/calismaGetir?isim=${qqqName}`),
                    fetch(`/calismaGetir?isim=qwx${State.pCalisma}`),
                    fetch(`/calismaGetir?isim=www_${State.pCalisma}`)
                ]);

                const qqqData = await rQ.json().catch(() => ({}));
                State.grupCalismasi = (qqqData.yontem === "Grup");

                const qwxData = await rS.json();
                State.sorular = qwxData.sorular || [];

                let grupListesi = [];
                if (State.grupCalismasi) {
                    try {
                        const rG = await fetch(`/grupListesiGetir?sinif=${State.pSinif}`);
                        grupListesi = await rG.json();
                    } catch (e) { }
                }

                const rawData = await rD.json();
                const sinifVerisi = rawData.filter(x => x.sinif === State.pSinif && x.ogrenciNo !== "AYARLAR");

                State.kuyruk = [];

                if (State.grupCalismasi && grupListesi.length > 0) {
                    grupListesi.forEach((grp, idx) => {
                        const grpIds = grp.map(u => String(u["Okul Numaranƒ±z"]));
                        const kayit = sinifVerisi.find(x => grpIds.includes(String(x.ogrenciNo)));

                        if (kayit) {
                            // Eƒüer bitmi≈üse kuyruƒüa ekleme
                            if (kayit.degerlendirme && kayit.degerlendirme.bitti) return;

                            State.kuyruk.push({
                                baslik: `${State.pSinif} - ${idx + 1}. GRUP`,
                                kayit: kayit,
                                members: grpIds
                            });
                        }
                    });
                } else {
                    sinifVerisi.forEach(kayit => {
                        // Eƒüer bitmi≈üse kuyruƒüa ekleme
                        if (kayit.degerlendirme && kayit.degerlendirme.bitti) return;

                        State.kuyruk.push({
                            baslik: `${State.pSinif} - ${kayit.ogrenciNo} - ${kayit.adSoyad}`,
                            kayit: kayit,
                            members: [kayit.ogrenciNo]
                        });
                    });
                }

                // KUYRUK BO≈ûSA HERKES Bƒ∞TMƒ∞≈û DEMEKTƒ∞R
                if (State.kuyruk.length === 0) {
                    document.getElementById('tamamlandi_panel').style.display = "block";
                    return;
                }

                // Kaldƒ±ƒüƒ±mƒ±z yerden devam etme (indeks sƒ±fƒ±rlanƒ±r √ß√ºnk√º bitenleri √ßƒ±kardƒ±k)
                State.kuyrukIdx = 0;

                TeacherApp.yukle();
            },
            yukle: () => {
                if (State.kuyrukIdx >= State.kuyruk.length) {
                    alert("Sƒ±nƒ±f Bitti!");
                    sessionStorage.removeItem('deg_calisma');
                    sessionStorage.removeItem('deg_sinif');
                    sessionStorage.removeItem('deg_idx');
                    document.getElementById('sel_calisma').value = "";
                    document.getElementById('sel_sinif').innerHTML = '<option value="">Sƒ±nƒ±f Se√ß</option>';
                    document.getElementById('main_content').style.display = "none";
                    document.getElementById('controls_area').style.display = "none";
                    document.getElementById('sonuc_ekrani').style.display = "none";
                    document.getElementById('header_info').textContent = "--";
                    return;
                }

                sessionStorage.setItem('deg_idx', State.kuyrukIdx);

                const item = State.kuyruk[State.kuyrukIdx];
                State.activeVeri = item.kayit;
                State.pOgrenci = State.activeVeri.ogrenciNo;
                State.anlikPuanlar = State.activeVeri.puanlar || {};
                State.sIdx = 0;

                document.getElementById('header_info').textContent = `[${State.kuyrukIdx + 1}/${State.kuyruk.length}] ${item.baslik}`;

                document.getElementById('main_content').style.display = "flex";
                document.getElementById('controls_area').style.display = "flex";
                document.getElementById('sonuc_ekrani').style.display = "none";
                guncelleToplamPuan();
                App.renderSoru();
            }
        };

        window.onload = App.init;
    </script>
</body>

</html>