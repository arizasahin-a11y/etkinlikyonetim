<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deƒüerlendirme Ekranƒ±</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #673AB7;
            padding-bottom: 10px;
        }

        /* UI FROM index.html */
        .deg-card {
            background: white;
            width: 100%;
            border-radius: 8px;
            display: flex;
            flex-direction: row;
            height: 500px;
            border: 1px solid #bbb;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .deg-soru-bolumu {
            background: #e8f5e9;
            padding: 20px;
            border-right: 1px solid #c8e6c9;
            color: #1b5e20;
            overflow-y: auto;
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            font-size: 1.1rem;
        }

        .deg-cevap-bolumu {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            background: #fff;
            font-size: 1rem;
        }

        .deg-cevap-item {
            position: relative;
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 12px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
            min-height: 60px;
            cursor: pointer;
        }

        .deg-cevap-metin {
            flex: 1;
            min-height: 40px;
            padding-right: 70px;
            word-wrap: break-word;
        }

        .deg-buton-grubu {
            position: absolute;
            bottom: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            z-index: 5;
        }

        .deg-btn-puan {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            color: #666;
            transition: 0.2s;
        }

        .deg-dogru.aktif {
            background: #2e7d32 !important;
            color: white !important;
            border-color: #2e7d32;
        }

        .deg-yanlis.aktif {
            background: #d32f2f !important;
            color: white !important;
            border-color: #d32f2f;
        }

        .deg-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .action {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
        }

        .blue {
            background-color: #2196F3;
        }

        .red {
            background-color: #f44336;
        }

        .gray {
            background-color: #9e9e9e;
        }

        .action:hover {
            opacity: 0.9;
        }

        .info-bar {
            background: #eee;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-radius: 6px;
            margin-bottom: 15px;
            color: #333;
        }

        /* MEDYA G√ñMME STƒ∞LLERƒ∞ */
        .embedded-wrapper {
            width: 100%;
            margin: 10px 0;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 5px;
            background: #fff;
        }

        .embedded-img {
            max-height: 250px;
            max-width: 100%;
            cursor: pointer;
            display: block;
            margin: 0 auto;
        }

        .embedded-iframe {
            width: 100%;
            height: 300px;
            border: none;
        }

        .embed-fallback {
            text-align: center;
            font-size: 12px;
            margin-top: 5px;
            background: #f1f1f1;
            padding: 5px;
            border-radius: 4px;
        }

        .embed-fallback a {
            color: #1976D2;
            text-decoration: none;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .deg-card {
                flex-direction: column;
                height: auto;
            }

            .deg-soru-bolumu {
                flex: none;
                border-right: none;
                border-bottom: 1px solid #c8e6c9;
                max-height: 200px;
            }

            .deg-cevap-bolumu {
                max-height: 400px;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>DEƒûERLENDƒ∞RME</h2>
        <div id="bilgi" class="info-bar">Y√ºkleniyor...</div>

        <div id="anaPanel" style="display:none;">
            <div class="deg-card">
                <div class="deg-soru-bolumu">
                    <div
                        style="margin-bottom:10px; font-weight:bold; color:#2e7d32; border-bottom:1px solid #c8e6c9; padding-bottom:5px;">
                        <span id="degSoruNo">1</span>. SORU
                    </div>
                    <div id="degSoruMetin"></div>
                </div>
                <div class="deg-cevap-bolumu">
                    <div id="degCevapListesi"></div>
                </div>
            </div>

            <div class="deg-controls">
                <button class="action gray" onclick="nav(-1)">‚ùÆ Geri</button>
                <button class="action blue" id="btnIleri" onclick="nav(1)">ƒ∞leri ‚ùØ</button>
                <button class="action red" id="btnBitir" onclick="bitir()" style="display:none;">üíæ KAYDET VE
                    Bƒ∞Tƒ∞R</button>
            </div>
        </div>

        <div id="msgPanel" style="text-align:center; padding:20px; display:none;"></div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const OGR_NO = params.get('ogrenci');
        const SINIF = params.get('sinif');
        const CALISMA = params.get('calisma');

        let sorular = [];
        let anlikPuanlar = {};
        let cevaplarListesi = []; // √ñƒürencinin cevaplarƒ±
        let sIdx = 0;

        function linkleriDonustur(text) {
            if (!text) return "";
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, function (url) {
                const cleanUrl = url.trim();
                const urlNoParams = cleanUrl.split('?')[0];
                const ext = urlNoParams.split('.').pop().toLowerCase();

                if (cleanUrl.includes('drive.google.com') || cleanUrl.includes('docs.google.com')) {
                    let id = cleanUrl.match(/\/d\/([a-zA-Z0-9_-]+)/) || cleanUrl.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                    if (id) {
                        let embedUrl = `https://drive.google.com/file/d/${id[1]}/preview`;
                        if (cleanUrl.includes('/document/')) embedUrl = `https://docs.google.com/document/d/${id[1]}/preview`;
                        else if (cleanUrl.includes('/spreadsheets/')) embedUrl = `https://docs.google.com/spreadsheets/d/${id[1]}/preview`;
                        else if (cleanUrl.includes('/presentation/')) embedUrl = `https://docs.google.com/presentation/d/${id[1]}/preview`;
                        return `<div class="embedded-wrapper"><iframe src="${embedUrl}" class="embedded-iframe" allow="autoplay"></iframe><div class="embed-fallback"><a href="${cleanUrl}" target="_blank">üìÑ Dosyayƒ± Yeni Sekmede A√ß</a></div></div>`;
                    }
                }
                if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return `<img src="${cleanUrl}" class="embedded-img" onclick="window.open(this.src)">`;
                if (cleanUrl.includes('youtube.com') || cleanUrl.includes('youtu.be')) {
                    let embedUrl = cleanUrl.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/');
                    if (embedUrl.includes('&')) embedUrl = embedUrl.split('&')[0];
                    return `<div class="embedded-wrapper"><iframe src="${embedUrl}" class="embedded-iframe" allowfullscreen></iframe></div>`;
                }
                return `<a href="${cleanUrl}" target="_blank">${cleanUrl}</a>`;
            });
        }

        async function yukle() {
            if (!OGR_NO || !SINIF || !CALISMA) { document.body.innerHTML = "<h3 style='text-align:center'>Hatalƒ± Link</h3>"; return; }

            try {
                // 1. Verileri √áek
                const rS = await fetch(`/calismaGetir?isim=qwx${CALISMA}`);
                const dS = await rS.json();
                sorular = Array.isArray(dS) ? dS : (dS.sorular || []);

                const rC = await fetch(`/calismaGetir?isim=www_${CALISMA}`);
                const dC = await rC.json();
                const kayit = dC.find(x => String(x.ogrenciNo) === String(OGR_NO));

                if (!kayit) { document.getElementById('bilgi').innerHTML = "Kayƒ±t bulunamadƒ±."; return; }

                // 2. Ba≈ülƒ±k Belirleme
                let baslik = `${kayit.sinif} - ${kayit.adSoyad || ''} (${OGR_NO})`;
                if (kayit.degerlendirme && kayit.degerlendirme.bitti) baslik += " - (TAMAMLANDI)";

                try {
                    const cleanSinif = SINIF.replace(/\s/g, '');
                    const rA = await fetch(`/calismaGetir?isim=qqq${cleanSinif}${CALISMA}`);
                    if (rA.ok) {
                        const dA = await rA.json();
                        if (dA.yontem === 'Grup') {
                            const rG = await fetch(`/grupListesiGetir?sinif=${SINIF}`);
                            const groups = await rG.json();
                            const myGroup = groups.find(g => Array.isArray(g) && g.some(s => s && String(s["Okul Numaranƒ±z"]) === String(OGR_NO)));
                            if (myGroup) {
                                const gIdx = groups.indexOf(myGroup) + 1;
                                baslik = `${SINIF} - Grup ${gIdx}`;
                            }
                        } else if (dA.yontem === 'Tek' || !dA.yontem) {
                            baslik = `${kayit.sinif} - ${OGR_NO} - ${kayit.adSoyad || ''}`;
                        }
                    }
                } catch (err) { console.log("Kontrol hatasƒ±:", err); }

                document.getElementById('bilgi').textContent = baslik;

                anlikPuanlar = kayit.puanlar || {};
                cevaplarListesi = kayit.cevaplar || [];

                if (sorular.length > 0) {
                    document.getElementById('anaPanel').style.display = "block";
                    sIdx = 0;
                    renderSoru();
                } else {
                    document.getElementById('msgPanel').innerHTML = "Soru bulunamadƒ±.";
                    document.getElementById('msgPanel').style.display = "block";
                }

            } catch (e) { console.error(e); alert("Veri y√ºklenemedi!"); }
        }

        function renderSoru() {
            document.getElementById("degSoruNo").textContent = sIdx + 1;

            let soruMetni = typeof sorular[sIdx] === 'object' ? sorular[sIdx].soru : sorular[sIdx];
            document.getElementById("degSoruMetin").innerHTML = linkleriDonustur(soruMetni);

            const cObj = cevaplarListesi.find(c => c.soruIndex === sIdx);
            const cevaplar = cObj ? cObj.cevaplar : [];
            const puanlar = anlikPuanlar[sIdx] || [];

            let html = "";
            if (cevaplar.length === 0) {
                html = "<div style='padding:20px; color:#999; text-align:center; font-style:italic;'>Bu soru i√ßin cevap verilmemi≈ü.</div>";
            } else {
                cevaplar.forEach((txt, i) => {
                    if (txt && txt.trim() !== "") {
                        html += `<div class="deg-cevap-item" ondblclick="hizliGec(${i}, 1)">
                        <div class="deg-cevap-metin">${linkleriDonustur(txt)}</div>
                        <div class="deg-buton-grubu">
                            <button class="deg-btn-puan deg-dogru ${puanlar[i] === 1 ? 'aktif' : ''}" onclick="puanla(${i},1)">D</button>
                            <button class="deg-btn-puan deg-yanlis ${puanlar[i] === 0 ? 'aktif' : ''}" onclick="puanla(${i},0)">Y</button>
                        </div>
                    </div>`;
                    }
                });
            }

            document.getElementById("degCevapListesi").innerHTML = html;

            const son = sIdx === sorular.length - 1;
            document.getElementById("btnIleri").style.display = son ? "none" : "inline-block";
            document.getElementById("btnBitir").style.display = son ? "inline-block" : "none";
        }

        function puanla(cIdx, p) {
            if (!anlikPuanlar[sIdx]) anlikPuanlar[sIdx] = [];
            anlikPuanlar[sIdx][cIdx] = p;
            renderSoru(); // Re-render to update classes
        }

        function hizliGec(cIdx, p) {
            puanla(cIdx, p);
            if (sIdx < sorular.length - 1) nav(1);
        }

        function nav(n) {
            let next = sIdx + n;
            if (next < 0) return;
            if (next >= sorular.length) return;
            sIdx = next;
            renderSoru();
        }

        async function bitir() {
            if (!confirm("Deƒüerlendirmeyi bitirip kaydetmek istiyor musunuz?")) return;
            const btn = document.getElementById('btnBitir');
            btn.disabled = true; btn.textContent = "Kaydediliyor...";

            const ps = [];
            Object.keys(anlikPuanlar).forEach(sIx => {
                anlikPuanlar[sIx].forEach((p, cIx) => {
                    if (p !== null && p !== undefined) {
                        ps.push(fetch("/puanKaydet", {
                            method: "POST", headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ dosyaAdi: `www_${CALISMA}`, ogrenciNo: OGR_NO, sinif: SINIF, soruIndex: parseInt(sIx), cevapIndex: cIx, puan: p })
                        }));
                    }
                });
            });

            await Promise.all(ps);
            const r = await fetch("/degerlendirmeBitir", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ dosyaAdi: `www_${CALISMA}`, ogrenciNo: OGR_NO, sinif: SINIF })
            });

            const res = await r.json();
            if (res.status === "ok") {
                alert(`Deƒüerlendirme tamamlandƒ±! Toplam Puan: ${res.toplam}`);
                window.location.href = "giris";
            } else {
                alert("Hata olu≈ütu!");
                btn.disabled = false; btn.textContent = "üíæ KAYDET VE Bƒ∞Tƒ∞R";
            }
        }

        yukle();
    </script>
</body>

</html>