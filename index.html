<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Etkinlik Y√∂netim Paneli</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* GENEL STƒ∞LLER */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            font-size: 14px;
        }

        h1 {
            text-align: center;
            padding: 15px;
            background: #673AB7;
            color: white;
            margin: 0;
            font-size: 1.2rem;
        }

        .tab-container {
            display: flex;
            flex-direction: column;
        }

        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            background: #ede7f6;
            border-bottom: 1px solid #d1c4e9;
        }

        .tab-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: bold;
            color: #5e35b1;
            transition: 0.3s;
        }

        .tab-buttons button.active {
            background: #673AB7;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 15px;
        }

        .tab-content.active {
            display: block;
        }

        /* BUTONLAR */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }

        button.action {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        button.blue {
            background-color: #2196F3;
        }

        button.red {
            background-color: #f44336;
        }

        button.orange {
            background-color: #FF9800;
        }

        select,
        input[type="number"],
        input[type="text"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #d1c4e9;
            outline: none;
            background: white;
        }

        .grup-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 25px;
            justify-content: center;
        }

        .grup {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            background: white;
            width: 300px;
        }

        .grup h3 {
            margin-top: 0;
            color: #673AB7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #f5f5f5;
            color: #333;
        }

        /* GRUP KARTLARI */
        .grup {
            border: 1px solid #e0e0e0;
            padding: 0;
            border-radius: 12px;
            background: white;
            width: 320px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .grup:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .grup h3 {
            margin: 0;
            color: #fff;
            background: linear-gradient(135deg, #673AB7, #512DA8);
            padding: 15px;
            text-align: center;
            font-size: 1.3rem;
            letter-spacing: 0.5px;
        }

        .grup ul {
            list-style: none;
            padding: 10px;
            margin: 0;
            flex: 1;
        }

        .grup li {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            color: #444;
        }

        .grup li:last-child {
            border-bottom: none;
        }

        .grup li span.no {
            font-weight: bold;
            color: #673AB7;
            background: #ede7f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
            min-width: 40px;
            text-align: center;
        }

        .grup li span.ad {
            flex: 1;
            margin-left: 10px;
            font-weight: 500;
        }

        #calismaListesi {
            list-style-type: none;
            padding: 0;
            margin-top: 15px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        #calismaListesi li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            border: 1px solid #e0e0e0;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            background: #fff;
        }

        #calismaListesi li.selected {
            background-color: #ede7f6;
            border: 2px solid #673AB7;
            color: #5e35b1;
            font-weight: bold;
        }

        .btn-archive-small {
            background: #FF9800;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .atama-panel {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #d1c4e9;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            justify-content: center;
        }

        .timer-text {
            font-family: monospace;
            font-weight: bold;
            color: #d32f2f;
            font-size: 1.1em;
        }

        .yonetim-cerceve {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #d1c4e9;
            margin-bottom: 15px;
        }

        .yonetim-toolbar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .chk-container {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            margin: 0;
        }

        .kucuk-select {
            padding: 6px;
            font-size: 12px;
            min-width: 140px;
        }

        #degerlendirmeContainer {
            display: none;
            margin-top: 15px;
            border-top: 2px solid #673AB7;
            padding-top: 15px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .deg-card {
            background: white;
            width: 100%;
            border-radius: 8px;
            display: flex;
            flex-direction: row;
            height: 450px;
            border: 1px solid #bbb;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .deg-soru-bolumu {
            background: #e8f5e9;
            padding: 20px;
            border-right: 1px solid #c8e6c9;
            color: #1b5e20;
            overflow-y: auto;
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            font-size: 0.95rem;
        }

        .deg-cevap-bolumu {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            background: #fff;
            font-size: 0.95rem;
        }

        .deg-cevap-item {
            position: relative;
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 12px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
            min-height: 60px;
            cursor: pointer;
        }

        .deg-cevap-metin {
            flex: 1;
            min-height: 40px;
            padding-right: 70px;
            word-wrap: break-word;
        }

        .deg-buton-grubu {
            position: absolute;
            bottom: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            z-index: 5;
        }

        .deg-btn-puan {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            color: #666;
        }

        .deg-dogru.aktif {
            background: #2e7d32 !important;
            color: white !important;
        }

        .deg-yanlis.aktif {
            background: #d32f2f !important;
            color: white !important;
        }

        .deg-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #eee;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 8px;
            position: relative;
            min-height: 40px;
        }

        .deg-header-left {
            text-align: left;
            font-weight: bold;
            color: #d32f2f;
            font-size: 1.1rem;
            text-transform: uppercase;
            z-index: 2;
            flex: 1;
        }

        .deg-header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-weight: bold;
            color: #000;
            font-size: 1.1rem;
            z-index: 1;
            white-space: nowrap;
        }

        .deg-header-right {
            text-align: right;
            font-weight: bold;
            color: #673AB7;
            font-size: 1.1rem;
            z-index: 2;
            flex: 1;
        }

        .deg-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .soru-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            background: #fdfdfd;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .soru-no {
            font-weight: bold;
            color: #673AB7;
            min-width: 70px;
        }

        /* MEDYA G√ñMME STƒ∞LLERƒ∞ */
        .embedded-wrapper {
            width: 100%;
            margin-top: 10px;
            margin-bottom: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 5px;
            background: #fff;
        }

        .embedded-img {
            max-height: 200px;
            max-width: 100%;
            cursor: pointer;
            transition: transform 0.2s;
            display: block;
            margin: 0 auto;
        }

        .embedded-img.hover {
            transform: scale(1.02);
        }

        .embedded-img.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-height: 100vh;
            object-fit: contain;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            box-sizing: border-box;
        }

        .embedded-video {
            max-width: 100%;
            height: auto;
            max-height: 300px;
            display: block;
            margin: 0 auto;
        }

        .embedded-audio {
            width: 100%;
        }

        .embedded-iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .embed-fallback {
            text-align: center;
            font-size: 12px;
            margin-top: 5px;
            background: #f1f1f1;
            padding: 5px;
            border-radius: 4px;
        }

        .embed-fallback a {
            color: #1976D2;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>Etkinlik Y√∂netim Paneli</h1>
    <div class="tab-container">
        <div class="tab-buttons">
            <button onclick="openTab(event,'sekme2')">√áalƒ±≈üma ƒ∞√ßeriƒüi</button>
            <button onclick="openTab(event,'sekme1')">√áalƒ±≈üma ≈ûekli</button>
            <button class="active" onclick="openTab(event,'sekme3')">√áalƒ±≈üma S√ºreci</button>
            <button onclick="openTab(event,'sekme4')">Deƒüerlendirme</button>
        </div>

        <div id="sekme2" class="tab-content">
            <div id="listeEkrani">
                <div class="button-group">
                    <button onclick="arsivModalAc()" class="action orange">üìÇ Ar≈üivden √áalƒ±≈üma Ekle</button>
                    <button id="btnYeni" class="action">Yeni √áalƒ±≈üma Ekle</button>
                    <button id="btnDuzenle" class="action blue">Se√ßileni D√ºzenle</button>
                    <button id="btnSilDosya" class="action red">Se√ßileni Sil</button>
                </div>
                <ul id="calismaListesi"></ul>
            </div>
            <div id="editorEkrani"
                style="display:none; border: 1px solid #d1c4e9; padding: 20px; border-radius: 10px; background: white; max-width: 1200px; width: 95%; box-sizing: border-box; margin: 0 auto;">
                <h3 id="editorBaslik" style="color: #673AB7; text-align: center; margin-top:0;"></h3>
                <textarea id="calismaAciklama"
                    style="width: 100%; height: 80px; padding: 12px; border: 1px solid #d1c4e9; border-radius: 8px; display: block; margin: 10px auto; box-sizing: border-box;"
                    placeholder="Y√∂nergeleri buraya yazƒ±n..."></textarea>
                <div id="soruAlani"></div>
                <div class="button-group">
                    <button id="btnSoruEkle" class="action blue">+ Yeni Soru</button>
                    <label class="chk-container"
                        style="background:#f0f0f0; padding:8px 12px; border-radius:6px; cursor:pointer;"
                        title="Yeni eklenecek sorunun √ßoktan se√ßmeli (test) olmasƒ±nƒ± saƒülar."><input type="checkbox"
                            id="chkCoktanSecmeli"> √áoktan Se√ßmeli</label>
                    <button id="btnKaydet" class="action">üíæ Kaydet</button>
                    <button onclick="location.reload()" class="action red">ƒ∞ptal</button>
                </div>
            </div>
        </div>

        <div id="sekme1" class="tab-content">
            <div style="text-align: center;">
                <div style="display:inline-block; text-align:left; margin-bottom:10px;">
                    <div><strong>1. Sƒ±nƒ±f Se√ßin:</strong></div>
                    <select id="sinifSec" style="width: 200px;">
                        <option value="">-- Sƒ±nƒ±f Se√ßin --</option>
                    </select>
                </div>

                <div style="display:inline-block; text-align:left; margin-left:20px; margin-bottom:10px;">
                    <div><strong>2. √áalƒ±≈üma Se√ßin:</strong></div>
                    <select id="sinifCalismaSec" style="width: 250px;">
                        <option value="">-- √áalƒ±≈üma Se√ßin --</option>
                    </select>
                </div>

                <div class="button-group">
                    <button id="btnGrupla" class="action">Sƒ±nƒ±fƒ± Gruplara B√∂l</button>
                    <button id="btnSil" class="action red">Mevcut Gruplarƒ± Sil</button>
                </div>
            </div>
            <div id="tablo" class="grup-container"></div>
        </div>

        <div id="sekme3" class="tab-content active">
            <div class="atama-panel">
                <div>Sƒ±nƒ±f:<br><select id="s3SinifSec" style="width:140px;">
                        <option value="">-- Se√ßin --</option>
                    </select></div>
                <div>√áalƒ±≈üma:<br><select id="s3CalismaSec" style="width:140px;">
                        <option value="">-- Se√ßin --</option>
                    </select></div>
                <div>Y√∂ntem:<br><select id="s3YontemSec" style="width:110px;">
                        <option value="">-- Se√ßin --</option>
                        <option value="Grup">Grup</option>
                        <option value="Tek">Tek</option>
                    </select></div>
                <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                    <label class="chk-container" title="Sorularƒ± her √∂ƒürenciye farklƒ± sƒ±rada g√∂sterir."><input
                            type="checkbox" id="chkKarisikSoru"> Karƒ±≈üƒ±k Soru</label>
                </div>
                <button id="btnS3Olustur" class="action blue" style="min-width:100px;">Olu≈ütur</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th onclick="toggleS3Sort('sinif')" style="cursor:pointer;" title="Sƒ±nƒ±fa g√∂re sƒ±rala">Sƒ±nƒ±f ‚Üï
                        </th>
                        <th onclick="toggleS3Sort('calisma')" style="cursor:pointer;" title="√áalƒ±≈ümaya g√∂re sƒ±rala">
                            √áalƒ±≈üma Adƒ± ‚Üï</th>
                        <th>Y√∂ntem</th>
                        <th>G√∂rme</th>
                        <th>Yapma</th>
                        <th>Deƒüerl.</th>
                        <th>S√ºre</th>
                        <th>Kalan</th>
                        <th>ƒ∞≈ülem</th>
                    </tr>
                </thead>
                <tbody id="atamaBody"></tbody>
            </table>
        </div>

        <div id="sekme4" class="tab-content">
            <div class="yonetim-cerceve" id="degSecimPaneli">
                <div class="yonetim-toolbar" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
                    <!-- Action Buttons -->
                    <div style="display:flex; gap:5px;">
                        <button id="btnPuanTablosu" class="action orange"
                            style="font-size:12px; padding:6px 15px; display:none;">üìä PUAN TABLOSU</button>
                        <button id="btnTumCevaplariSifirla" class="action red"
                            style="font-size:12px; padding:6px 15px; display:none;">‚ö†Ô∏è CEVAPLARI SIFIRLA</button>
                    </div>

                    <!-- Permissions Checkboxes Inline -->
                    <div
                        style="display:flex; gap:15px; border:1px solid #ccc; padding:5px 10px; border-radius:4px; background:#f9f9f9;">
                        <label class="chk-container" style="margin:0;"><input type="checkbox" id="chkDegerlendirmeIzin"
                                disabled> √ñƒürenci ƒ∞zni</label>
                        <label class="chk-container" style="margin:0;"><input type="checkbox" id="chkIzin" disabled>
                            √ñƒüretmen ƒ∞zni</label>
                    </div>

                    <!-- Selection Dropdowns -->
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div><strong>√áalƒ±≈üma:</strong> <select id="s4DosyaSec" class="kucuk-select"></select></div>
                        <div><strong>Sƒ±nƒ±f:</strong> <select id="s4SinifSec" class="kucuk-select"></select></div>
                    </div>

                    <button id="btnDegerlendirmeBaslat" class="action blue"
                        style="font-size:12px; padding:6px 15px;">BA≈ûLAT</button>
                    <button id="btnDegerlendirmeSifirla" class="action red"
                        style="font-size:12px; padding:6px 15px; display:none;">Sƒ±nƒ±fƒ± Sƒ±fƒ±rla (Bitti Kaldƒ±r)</button>
                </div>
                <script>
                    document.getElementById('btnTumCevaplariSifirla').onclick = async function () {
                        const calisma = document.getElementById("s4DosyaSec").value;
                        if (!calisma) return alert("L√ºtfen √ßalƒ±≈üma se√ßin.");

                        const kod = prompt("T√úM √ñƒûRENCƒ∞ CEVAPLARINI Sƒ∞LMEK ƒ∞√áƒ∞N KOD Gƒ∞Rƒ∞N (1234):");
                        if (kod === "1234") {
                            if (confirm(`"${calisma}" √ßalƒ±≈ümasƒ±na ait T√úM √ñƒûRENCƒ∞ CEVAPLARI silinecek! Emin misiniz?`)) {
                                try {
                                    const res = await fetch("/tumCevaplariTemizle", {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify({ calismaIsmi: `www_${calisma}` })
                                    });
                                    const json = await res.json();
                                    if (json.status === "ok") {
                                        alert("T√ºm cevaplar ba≈üarƒ±yla silindi.");
                                        // Refresh to reflect changes (e.g. re-fetch data)
                                        document.getElementById("s4DosyaSec").onchange();
                                    } else {
                                        alert("Hata: " + json.message);
                                    }
                                } catch (e) {
                                    alert("ƒ∞≈ülem hatasƒ±: " + e);
                                }
                            }
                        } else if (kod !== null) {
                            alert("Hatalƒ± kod!");
                        }
                    };

                    document.getElementById('btnPuanTablosu').onclick = async function () {
                        const calisma = document.getElementById("s4DosyaSec").value;
                        if (!calisma) return alert("L√ºtfen √ßalƒ±≈üma se√ßin.");

                        try {
                            const [qwx, www] = await Promise.all([
                                fetch(`/calismaGetir?isim=qwx${calisma}`).then(r => r.json()),
                                fetch(`/calismaGetir?isim=www_${calisma}`).then(r => r.json())
                            ]);

                            const sorular = qwx.sorular || [];
                            const cevaplar = www.filter(x => x.ogrenciNo !== "AYARLAR");

                            // CSV ƒ∞√ßeriƒüi Hazƒ±rla (Excel i√ßin BOM ekle)
                            let csvContent = "\uFEFF"; // UTF-8 BOM

                            // Kontrol Et: Bu √ßalƒ±≈ümada √ßoktan se√ßmeli soru var mƒ±?
                            const hasMCQ = sorular.some(s => typeof s === 'object' && s.type === 'coktan_secmeli');

                            // Ba≈ülƒ±k Satƒ±rƒ±
                            csvContent += `Sƒ±nƒ±f;√ñƒürenci No;Ad Soyad;Toplam Puan${hasMCQ ? ';Doƒüru;Yanlƒ±≈ü;Bo≈ü;Net Puan' : ''}`;
                            sorular.forEach((s, i) => csvContent += `;Soru ${i + 1}`);
                            csvContent += "\n";

                            // Veri Satƒ±rlarƒ±
                            // Sƒ±nƒ±fa g√∂re sƒ±rala
                            cevaplar.sort((a, b) => (a.sinif || "").localeCompare(b.sinif || ""));

                            cevaplar.forEach(row => {
                                let numericSum = 0;
                                let toplamPuan = "G"; // Final display variable
                                let dogruCevaplar = 0;
                                let yanlisCevaplar = 0;
                                let bosCevaplar = 0;
                                let netPuanStr = "";

                                let soruPuanlari = [];
                                let hasSpecialCode = false;
                                let specialCodeVal = "";

                                // Puan Hesapla
                                let puanObj = row.puanlar || {};

                                // --- EXPORT FALLBACK: AUTO-CALCULATE FROM OA IF PUAN IS MISSING OR TO OVERRIDE ---
                                // If student has an OA note but might not have been 'saved' with new scores yet.
                                if (row.degerlendirme && row.degerlendirme.OA) {
                                    const oa = row.degerlendirme.OA.toLowerCase().trim();
                                    let autoInit = null;
                                    if (oa.includes("girmedi") || oa.includes("gelmedi")) autoInit = "G";
                                    else if (oa.includes("mazeretli")) autoInit = "M";
                                    else if (oa.includes("√ßalƒ±≈ümadƒ±") || oa.includes("calismadi")) autoInit = "0";

                                    if (autoInit) {
                                        // Override local puanObj for export purposes
                                        // We treat this as if the teacher gave this grade to ALL questions
                                        // This ensures the table reflects the OA status even if DB scores are empty

                                        // Caution: Only override if puanObj is empty? 
                                        // User request: "OA a√ßƒ±klamsƒ± varsa... D0/G/M puan olarak girilmeli".
                                        // This implies OA determines the score. Let's prioritize it or fill gaps.
                                        // Since these are "status" codes, they usually apply to the whole study.
                                        // Let's FORCE override for export to match user expectation.

                                        // Mock a puanObj structure for the loop below
                                        // We need to know how many questions? 'sorular' array length is available.
                                        puanObj = {};
                                        sorular.forEach((_, qIdx) => {
                                            puanObj[qIdx] = [autoInit];
                                        });
                                    }
                                }

                                const rawAnswers = row.cevaplar || [];
                                const normalizedAnswers = Array.isArray(rawAnswers) && rawAnswers.length > 0 && typeof rawAnswers[0] === 'object' && rawAnswers[0].cevaplar ? rawAnswers :
                                    (Array.isArray(rawAnswers) && rawAnswers.answers ? rawAnswers.answers : rawAnswers);


                                sorular.forEach((soru, sIdx) => {
                                    const pArr = puanObj[sIdx];
                                    let sPuan = 0; // Default numeric 0
                                    let sVal = "0"; // Display value
                                    const isTest = typeof soru === 'object' && soru.type === 'coktan_secmeli';

                                    // Blank check via answers if it's a test
                                    let isBlank = false;
                                    if (isTest) {
                                        const sAnsObj = normalizedAnswers.find(c => c.soruIndex === sIdx);
                                        isBlank = (!sAnsObj || !sAnsObj.cevaplar || sAnsObj.cevaplar.length === 0 || sAnsObj.cevaplar[0] === "");
                                        if (isBlank) bosCevaplar++;
                                    }

                                    if (Array.isArray(pArr)) {
                                        // Check if any value is a special code string
                                        const rawVal = pArr.find(v => v !== undefined && v !== null);
                                        if (rawVal === "G" || rawVal === "M") {
                                            sVal = rawVal;
                                            hasSpecialCode = true;
                                            specialCodeVal = rawVal;
                                        } else {
                                            // Normal numeric sum
                                            let rawPuan = pArr.reduce((a, b) => a + (Number(b) || 0), 0);

                                            if (isTest) {
                                                if (isBlank) {
                                                    sPuan = 0;
                                                } else if (rawPuan > 0) {
                                                    sPuan = 1;
                                                    dogruCevaplar++;
                                                } else {
                                                    // NET PENALTY: Apply 1/(N-1) deduction
                                                    const secenekSayisi = (soru.secenekler || []).length;
                                                    sPuan = (secenekSayisi > 1) ? -(1 / (secenekSayisi - 1)) : 0;
                                                    yanlisCevaplar++;
                                                }
                                            } else {
                                                sPuan = rawPuan;
                                            }

                                            sVal = sPuan.toFixed(2).replace('.', ',').replace(/,00$/, "");
                                            numericSum += sPuan;
                                        }
                                    } else if (typeof pArr === 'string') {
                                        // Handle legacy/buggy case where pArr is direct string "G"/"M"
                                        if (pArr === "G" || pArr === "M") {
                                            sVal = pArr;
                                            hasSpecialCode = true;
                                            specialCodeVal = pArr;
                                        } else {
                                            let n = Number(pArr);
                                            if (!isNaN(n)) {
                                                if (isTest) {
                                                    if (isBlank) {
                                                        sPuan = 0;
                                                    } else if (n > 0) {
                                                        sPuan = 1;
                                                        dogruCevaplar++;
                                                    } else {
                                                        const secenekSayisi = (soru.secenekler || []).length;
                                                        sPuan = (secenekSayisi > 1) ? -(1 / (secenekSayisi - 1)) : 0;
                                                        yanlisCevaplar++;
                                                    }
                                                } else {
                                                    sPuan = n;
                                                }
                                                sVal = sPuan.toFixed(2).replace('.', ',').replace(/,00$/, "");
                                                numericSum += sPuan;
                                            } else {
                                                sVal = pArr;
                                            }
                                        }
                                    } else if (isTest && !isBlank) {
                                        // No score found but answer exists -> Wrong
                                        const secenekSayisi = (soru.secenekler || []).length;
                                        sPuan = (secenekSayisi > 1) ? -(1 / (secenekSayisi - 1)) : 0;
                                        yanlisCevaplar++;
                                        sVal = sPuan.toFixed(2).replace('.', ',').replace(/,00$/, "");
                                        numericSum += sPuan;
                                    }

                                    soruPuanlari.push(sVal);
                                });

                                // √ñzel durum: Eƒüer deƒüerlendirme "G" ise veya hi√ß deƒüerlendirilmemi≈üse toplam puan "G" olsun
                                if (row.degerlendirme && row.degerlendirme.toplam === "G") {
                                    toplamPuan = "G";
                                } else if (row.degerlendirme && row.degerlendirme.degerlendirildi === true) {
                                    // SADECE deƒüerlendirildiyse sayƒ±sal puana izin ver
                                    toplamPuan = Math.max(0, numericSum).toFixed(2).replace('.', ',').replace(/,00$/, "");
                                    if (hasSpecialCode && numericSum === 0) {
                                        toplamPuan = specialCodeVal;
                                    }
                                } else {
                                    toplamPuan = "G";
                                }

                                if (hasMCQ) {
                                    // Individual net values are already in columns and sub-totaled
                                    // For the extra summary columns (Doƒüru;Yanlƒ±≈ü;Bo≈ü;Net Puan):
                                    const summaryNet = (toplamPuan !== "G" && toplamPuan !== "M") ? toplamPuan : specialCodeVal || "-";
                                    netPuanStr = `;${dogruCevaplar};${yanlisCevaplar};${bosCevaplar};${summaryNet}`;
                                }

                                csvContent += `${row.sinif || ""};${row.ogrenciNo};${row.adSoyad || ""};${toplamPuan}${netPuanStr}`;
                                soruPuanlari.forEach(p => csvContent += `;${p}`);
                                csvContent += "\n";
                            });

                            // ƒ∞ndirme
                            const bloom = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                            const link = document.createElement("a");
                            const url = URL.createObjectURL(bloom);
                            link.setAttribute("href", url);
                            link.setAttribute("download", `Puan_Tablosu_${calisma}.csv`);
                            link.style.visibility = 'hidden';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);

                        } catch (e) {
                            console.error(e);
                            alert("Puan tablosu olu≈üturulurken hata: " + e);
                        }
                    };
                </script>
            </div>
            <div id="degerlendirmeContainer">
                <div class="deg-header">
                    <div class="deg-header-left" id="degOgrenciBaslik">--</div>
                    <div class="deg-header-center" id="degBilgiUst">--</div>
                    <div class="deg-header-right">PUAN: <span id="degPuanGosterge">0</span></div>
                </div>
                <div class="deg-card">
                    <div id="degNormalPanel" style="display:flex; width:100%; height:100%;">
                        <div class="deg-soru-bolumu"><span id="degSoruNo" style="font-weight:bold;">1</span>. Soru<div
                                id="degSoruMetin" style="font-weight:600;"></div>
                        </div>
                        <div class="deg-cevap-bolumu">
                            <div id="degCevapListesi"></div>
                        </div>
                    </div>
                </div>
                <div class="deg-controls">
                    <button class="action red" onclick="DegerlendirmeApp.nav(-1)" style="background:#9e9e9e">‚ùÆ
                        Geri</button>
                    <button class="action blue" id="btnDegIleri" onclick="DegerlendirmeApp.nav(1)">ƒ∞leri ‚ùØ</button>
                    <button class="action red" id="btnDegBitir" style="display:none;"
                        onclick="DegerlendirmeApp.sonrakiKisi()">üíæ Kaydet / Sonraki</button>
                </div>
                <div style="text-align:right; margin-top:10px;"><button onclick="location.reload()" class="action red"
                        style="background:#9e9e9e">Kapat</button></div>
            </div>
        </div>
    </div>

    <div id="arsivModal" class="modal">
        <div class="modal-content">
            <div
                style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding-bottom:10px;">
                <h3 style="margin:0; color:#673AB7;">Ar≈üiv</h3><span
                    onclick="document.getElementById('arsivModal').style.display='none'"
                    style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <ul id="arsivDosyaListesi" style="list-style:none; padding:0; max-height:300px; overflow-y:auto;"></ul>
        </div>
    </div>

    <div id="bitmisUyariModal" class="modal" style="z-index: 2000;">
        <div class="modal-content">
            <h3 style="color:#f44336;">‚ö†Ô∏è Deƒüerlendirme Tamamlanmƒ±≈ü</h3>
            <p>Bu sƒ±nƒ±f i√ßin bu √ßalƒ±≈üma daha √∂nce tamamlanmƒ±≈ü (Bitti) olarak g√∂r√ºn√ºyor.</p>
            <p>Puanlarƒ± sƒ±fƒ±rlayƒ±p (cevaplarƒ± koruyarak) tekrar deƒüerlendirmek ister misiniz?</p>
            <div style="margin-top:20px; display:flex; justify-content:center; gap:10px;">
                <button class="action red" onclick="DegerlendirmeApp.modalSifirla()">Evet, Puanlarƒ± Sƒ±fƒ±rla</button>
                <button class="action" onclick="location.reload()" style="background:#999;">ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <script>
        let globalData, secilenSinif, seciliDosyaAdi = "", aktifAtamalar = [];
        let s3SortKey = 'id', s3SortDir = 1;

        function linkleriDonustur(text) {
            if (!text) return "";
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, function (url) {
                const cleanUrl = url.trim();
                const urlNoParams = cleanUrl.split('?')[0];
                const ext = urlNoParams.split('.').pop().toLowerCase();

                if (cleanUrl.includes('drive.google.com') || cleanUrl.includes('docs.google.com')) {
                    let id = null;
                    const parts = cleanUrl.split(/\/d\//);
                    if (parts.length > 1) { id = parts[1].split('/')[0]; }
                    else { const match = cleanUrl.match(/[?&]id=([a-zA-Z0-9_-]+)/); if (match) id = match[1]; }

                    if (id) {
                        let embedUrl = `https://drive.google.com/file/d/${id}/preview`;
                        if (cleanUrl.includes('/document/')) embedUrl = `https://docs.google.com/document/d/${id}/preview`;
                        else if (cleanUrl.includes('/spreadsheets/')) embedUrl = `https://docs.google.com/spreadsheets/d/${id}/preview`;
                        else if (cleanUrl.includes('/presentation/')) embedUrl = `https://docs.google.com/presentation/d/${id}/preview`;
                        return `<div class="embedded-wrapper"><iframe src="${embedUrl}" class="embedded-iframe" allow="autoplay"></iframe><div class="embed-fallback"><a href="${cleanUrl}" target="_blank">üìÑ Dosyayƒ± Yeni Sekmede A√ß</a></div></div>`;
                    }
                }
                if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) { return `<img src="${cleanUrl}" class="embedded-img" onclick="this.classList.toggle('fullscreen')" title="B√ºy√ºtmek i√ßin tƒ±kla">`; }
                if (['mp3', 'wav', 'ogg'].includes(ext)) { return `<div class="embedded-wrapper"><audio controls src="${cleanUrl}" class="embedded-audio"></audio></div>`; }
                if (['mp4', 'webm', 'mov'].includes(ext)) { return `<div class="embedded-wrapper"><video controls src="${cleanUrl}" class="embedded-video"></video></div>`; }
                if (cleanUrl.includes('youtube.com') || cleanUrl.includes('youtu.be')) {
                    let embedUrl = cleanUrl;
                    if (cleanUrl.includes('watch?v=')) embedUrl = cleanUrl.replace('watch?v=', 'embed/');
                    else if (cleanUrl.includes('youtu.be/')) embedUrl = cleanUrl.replace('youtu.be/', 'youtube.com/embed/');
                    if (embedUrl.includes('&')) embedUrl = embedUrl.split('&')[0];
                    return `<div class="embedded-wrapper"><iframe src="${embedUrl}" class="embedded-iframe" allowfullscreen></iframe></div>`;
                }
                return `<div class="embedded-wrapper"><iframe src="${cleanUrl}" class="embedded-iframe" loading="lazy"></iframe><div class="embed-fallback"><a href="${cleanUrl}" target="_blank">üåê Baƒülantƒ±yƒ± Yeni Sekmede A√ß</a></div></div>`;
            });
        }

        window.onload = () => {
            veritabaniniYukle().then(() => {
                s3DropdownYukle();
                s3AtamalariCek();
                s4DosyaListesiYukle();
                const sonSekme = sessionStorage.getItem('aktifSekme');
                if (sonSekme) { openTab(null, sonSekme); }
            });
        };

        function openTab(evt, tabId) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if (evt) { evt.currentTarget.classList.add('active'); }
            else {
                const buttons = document.querySelectorAll('.tab-buttons button');
                buttons.forEach(btn => { if (btn.getAttribute('onclick').includes(tabId)) btn.classList.add('active'); });
            }
            sessionStorage.setItem('aktifSekme', tabId);
            if (tabId === 'sekme3') { s3DropdownYukle(); s3AtamalariCek(); }
            if (tabId === 'sekme2') listeyiYukle();
            if (tabId === 'sekme4') s4DosyaListesiYukle();
        }

        async function veritabaniniYukle() {
            const res = await fetch("veritabani.json");
            const data = await res.json();
            // Data is grouped by class: { "9A": [...], "9B": [...] }
            // Flatten to get all students
            globalData = Object.values(data).flat().map(ogrenci => {
                if (ogrenci["Adƒ±nƒ±z Soyadƒ±nƒ±z"]) ogrenci["Adƒ±nƒ±z Soyadƒ±nƒ±z"] = ogrenci["Adƒ±nƒ±z Soyadƒ±nƒ±z"].toLocaleUpperCase("tr-TR");
                return ogrenci;
            });
            const siniflar = [...new Set(globalData.map(k => k["Sƒ±nƒ±fƒ±nƒ±z"]))];
            siniflar.forEach(s => {
                document.getElementById("sinifSec").appendChild(new Option(s, s));
                document.getElementById("s3SinifSec").appendChild(new Option(s, s));
            });
        }

        function listeyiYukle() {
            fetch("/listeCalismalar").then(res => res.json()).then(dosyalar => {
                const liste = document.getElementById("calismaListesi"); liste.innerHTML = "";
                dosyalar.filter(d => d.startsWith("qwx")).forEach(d => {
                    const li = document.createElement("li");
                    li.innerHTML = `<span>${d.replace("qwx", "").replace(".json", "")}</span><button onclick="calismaArsivle('${d}')" class="btn-archive-small">Ar≈üivle</button>`;
                    li.onclick = () => { document.querySelectorAll("#calismaListesi li").forEach(x => x.classList.remove("selected")); li.classList.add("selected"); seciliDosyaAdi = d; };
                    liste.appendChild(li);
                });
            });
        }
        function calismaArsivle(tamDosyaAdi) {
            if (!confirm("Ar≈üivlenecek?")) return;
            fetch("/arsivle", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dosyaIsmi: tamDosyaAdi.replace(".json", "") }) })
                .then(res => res.json()).then(data => { if (data.status === "ok") listeyiYukle(); });
        }
        function arsivModalAc() {
            document.getElementById("arsivModal").style.display = "block";
            const liste = document.getElementById("arsivDosyaListesi");
            fetch("/arsivListesi").then(res => res.json()).then(dosyalar => {
                liste.innerHTML = "";
                dosyalar.forEach(d => {
                    const li = document.createElement("li"); li.style.padding = "10px"; li.style.borderBottom = "1px solid #eee"; li.style.display = "flex"; li.style.justifyContent = "space-between";
                    li.innerHTML = `<span>${d.replace(".json", "").replace("qwx", "")}</span> <button class="action blue" onclick="arsivdenGeriYukle('${d}')">Geri Y√ºkle</button>`;
                    liste.appendChild(li);
                });
            });
        }
        function arsivdenGeriYukle(dosyaAdi) {
            if (!confirm("Geri y√ºklensin mi?")) return;
            fetch("/arsivdenGeriYukle", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dosyaIsmi: dosyaAdi }) })
                .then(res => res.json()).then(data => { if (data.status === "ok") { document.getElementById("arsivModal").style.display = "none"; listeyiYukle(); } });
        }

        function soruEkle(payload = "") {
            const div = document.createElement("div"); div.className = "soru-item";
            div.style.marginBottom = "15px"; div.style.padding = "10px"; div.style.border = "1px solid #ddd"; div.style.borderRadius = "8px"; div.style.background = "#fafafa";

            let isTest = false;
            let secenekler = ["", "", "", "", ""];
            let dogruCevap = 0;
            let soruMetni = "";
            let uid = "q_" + Date.now() + Math.floor(Math.random() * 1000);

            if (typeof payload === 'object') {
                isTest = payload.type === 'coktan_secmeli';
                soruMetni = payload.soru || "";
                if (isTest) {
                    secenekler = payload.secenekler || ["", "", "", "", ""];
                    dogruCevap = payload.dogruCevap || 0;
                }
            } else {
                // Determine structure based on checkbox if adding new
                isTest = document.getElementById("chkCoktanSecmeli") && document.getElementById("chkCoktanSecmeli").checked;
                soruMetni = payload;
            }

            let html = `<div style="display:flex; align-items:flex-start; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #ddd; width:100%; flex:1; box-sizing:border-box;">
                <span class="soru-no" style="font-weight:bold; margin-right:15px; width:60px; margin-top:12px; font-size:1.1rem; color:#333; flex-shrink:0;"></span>
                <div class="soru-content" style="flex:1; display:flex; flex-direction:column; gap:10px;">
                    <textarea class="soru-input" style="width:100%; padding:15px; border-radius:8px; border:1px solid #ccc; resize:vertical; min-height:80px; font-size:1.05rem; box-sizing:border-box; box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);" placeholder="Soru Metni">${soruMetni}</textarea>
                    <input type="hidden" class="soru-type" value="${isTest ? 'coktan_secmeli' : 'text'}">`;

            if (!isTest) {
                // Determine predefined answer state for text questions
                let cevabiVar = false;
                let kesinCevap = "";
                if (typeof payload === 'object' && payload.cevabiVar) {
                    cevabiVar = true;
                    kesinCevap = payload.dogruCevap || "";
                }

                html += `
                <div style="background:#f1f8e9; padding:10px 15px; border-radius:8px; border:1px solid #c5e1a5;">
                    <label style="display:flex; align-items:center; cursor:pointer; font-weight:bold; color:#33691e; font-size:0.95rem;">
                        <input type="checkbox" class="chk-cevabi-var" style="margin-right:8px; transform:scale(1.2);" ${cevabiVar ? 'checked' : ''} onchange="this.parentElement.nextElementSibling.style.display = this.checked ? 'block' : 'none';"> 
                        Cevabƒ± Gir (Otomatik Puanlama ƒ∞√ßin)
                    </label>
                    <div style="margin-top:10px; display:${cevabiVar ? 'block' : 'none'};">
                        <input type="text" class="kesin-cevap-input" value="${kesinCevap}" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:1rem; box-sizing:border-box;" placeholder="√ñƒürencinin girmesi beklenen tam metin (√ñrn: Ankara)">
                    </div>
                </div>`;
            }

            if (isTest) {
                let optionsHtml = `<div class="secenek-container" id="opts_${uid}" style="width:100%; padding:15px 20px; background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px; box-sizing:border-box;">`;
                optionsHtml += `<div style="font-weight:bold; color:#512DA8; margin-bottom:12px; font-size:0.95rem;">Doƒüru cevabƒ± i≈üaretleyin:</div>`;
                optionsHtml += `<div class="opts-list">`;

                secenekler.forEach((sec, idx) => {
                    const char = String.fromCharCode(65 + idx); // A, B, C...
                    optionsHtml += `
                    <div class="opt-row" style="display:flex; align-items:center; margin-bottom:10px;">
                        <input type="radio" name="correct_${uid}" value="${idx}" class="opt-radio" ${idx === dogruCevap ? 'checked' : ''} style="margin-right:15px; transform:scale(1.4); cursor:pointer; flex-shrink:0;">
                        <span style="font-weight:bold; margin-right:10px; width:24px; font-size:1.05rem; color:#444; flex-shrink:0;">${char})</span>
                        <input type="text" class="opt-text" value="${sec}" style="flex:1; padding:12px 15px; border:1px solid #ccc; border-radius:6px; font-size:1rem; box-sizing:border-box;" placeholder="${char} se√ßeneƒüi">
                        ${idx > 1 ? `<button onclick="this.parentElement.remove();" class="action red" style="padding:8px 12px; font-size:12px; margin-left:12px; border-radius:6px; min-width:40px; flex-shrink:0;" title="Se√ßeneƒüi Sil">X</button>` : `<span style="width:52px; margin-left:12px; flex-shrink:0;"></span>`}
                    </div>`;
                });
                optionsHtml += `</div>`;
                optionsHtml += `<button onclick="addOptionTo('${uid}')" class="action blue" style="padding:8px 15px; font-size:13px; margin-top:10px; border-radius:6px;">+ Se√ßenek Ekle</button>`;
                optionsHtml += `</div>`;
                html += optionsHtml;
            }

            html += `</div>
                <button onclick="this.parentElement.remove(); yenileSoruNumaralari();" class="action red" style="min-width:44px; padding:12px; margin-left:15px; border-radius:6px; flex-shrink:0;" title="Soruyu Sil">X</button>
            </div>`;

            div.innerHTML = html;
            // The previous code had div.style.padding etc. Remove it so we rely on the internal flex.
            div.style.padding = "0";
            div.style.border = "none";
            div.style.background = "transparent";

            document.getElementById("soruAlani").appendChild(div);
            yenileSoruNumaralari();
        }
        function yenileSoruNumaralari() {
            document.querySelectorAll("#soruAlani .soru-item").forEach((item, index) => { item.querySelector(".soru-no").textContent = (index + 1) + "."; });
        }

        function addOptionTo(uid) {
            const container = document.querySelector(`#opts_${uid} .opts-list`);
            const count = container.querySelectorAll('.opt-row').length;
            if (count >= 10) return alert("Maksimum 10 ≈üƒ±k eklenebilir.");
            const char = String.fromCharCode(65 + count);
            const div = document.createElement('div');
            div.className = "opt-row";
            div.style.display = "flex"; div.style.alignItems = "center"; div.style.marginBottom = "10px";
            div.innerHTML = `
                <input type="radio" name="correct_${uid}" value="${count}" class="opt-radio" style="margin-right:15px; transform:scale(1.4); cursor:pointer; flex-shrink:0;">
                <span style="font-weight:bold; margin-right:10px; width:24px; font-size:1.05rem; color:#444; flex-shrink:0;">${char})</span>
                <input type="text" class="opt-text" value="" style="flex:1; padding:12px 15px; border:1px solid #ccc; border-radius:6px; font-size:1rem; box-sizing:border-box;" placeholder="${char} se√ßeneƒüi">
                <button onclick="this.parentElement.remove(); updateOptionLabels('${uid}');" class="action red" style="padding:8px 12px; font-size:12px; margin-left:12px; border-radius:6px; min-width:40px; flex-shrink:0;" title="Se√ßeneƒüi Sil">X</button>`;
            container.appendChild(div);
            updateOptionLabels(uid);
        }

        function updateOptionLabels(uid) {
            const rows = document.querySelectorAll(`#opts_${uid} .opts-list .opt-row`);
            rows.forEach((row, idx) => {
                const char = String.fromCharCode(65 + idx);
                row.querySelector('span').textContent = char + ")";
                row.querySelector('.opt-radio').value = idx;
                row.querySelector('.opt-text').placeholder = char + " se√ßeneƒüi";
            });
        }

        document.getElementById("btnSoruEkle").onclick = () => soruEkle();

        document.getElementById("btnYeni").onclick = () => {
            let isim = prompt("Ad?"); if (isim) { seciliDosyaAdi = "qwx" + isim; document.getElementById("listeEkrani").style.display = "none"; document.getElementById("editorEkrani").style.display = "block"; document.getElementById("editorBaslik").textContent = isim.toUpperCase(); document.getElementById("calismaAciklama").value = ""; document.getElementById("soruAlani").innerHTML = ""; soruEkle(); }
        };
        document.getElementById("btnDuzenle").onclick = () => {
            if (!seciliDosyaAdi) return alert("Se√ßin!");
            fetch(`/calismaGetir?isim=${encodeURIComponent(seciliDosyaAdi.replace(".json", ""))}`).then(r => r.json()).then(data => {
                document.getElementById("listeEkrani").style.display = "none"; document.getElementById("editorEkrani").style.display = "block";
                document.getElementById("editorBaslik").textContent = seciliDosyaAdi.replace("qwx", "").replace(".json", "").toUpperCase();
                document.getElementById("soruAlani").innerHTML = "";
                let sorular = Array.isArray(data) ? data : (data.sorular || []);
                document.getElementById("calismaAciklama").value = data.aciklama || "";
                sorular.forEach(s => soruEkle(s));
            });
        };
        document.getElementById("btnKaydet").onclick = () => {
            const sorularArr = [];
            document.querySelectorAll("#soruAlani .soru-item").forEach(item => {
                const type = item.querySelector('.soru-type').value;
                const soruMetni = item.querySelector('.soru-input').value.trim();
                if (!soruMetni) return;

                if (type === 'coktan_secmeli') {
                    const secenekler = Array.from(item.querySelectorAll('.opt-text')).map(inp => inp.value).filter(v => v.trim() !== "");
                    // Get the selected radio button for this specific question
                    const radioName = item.querySelector('.opt-radio') ? item.querySelector('.opt-radio').name : null;
                    const checkedRadio = radioName ? document.querySelector(`input[name="${radioName}"]:checked`) : null;
                    const dogruCevap = checkedRadio ? parseInt(checkedRadio.value) : 0;

                    sorularArr.push({
                        type: 'coktan_secmeli',
                        soru: soruMetni,
                        secenekler: secenekler,
                        dogruCevap: dogruCevap
                    });
                } else {
                    const chk = item.querySelector('.chk-cevabi-var');
                    if (chk && chk.checked) {
                        const kesinCevap = item.querySelector('.kesin-cevap-input').value.trim();
                        sorularArr.push({
                            type: 'text',
                            soru: soruMetni,
                            cevabiVar: true,
                            dogruCevap: kesinCevap
                        });
                    } else {
                        sorularArr.push(soruMetni); // Legacy simple string format
                    }
                }
            });

            const v = {
                aciklama: document.getElementById("calismaAciklama").value,
                sorular: sorularArr
            };
            fetch("/calismaKaydet", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ calismaIsmi: seciliDosyaAdi.replace(".json", ""), sorular: v }) }).then(() => location.reload());
        };
        document.getElementById("btnSilDosya").onclick = () => { if (seciliDosyaAdi && confirm("Sil?")) fetch("/calismaSil", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ calismaIsmi: seciliDosyaAdi.replace(".json", "") }) }).then(() => listeyiYukle()); };

        document.getElementById("sinifSec").onchange = function () {
            secilenSinif = this.value;
            tabloCiz();
        };

        document.getElementById("sinifCalismaSec").onchange = function () {
            secilenCalismaGrupIcin = this.value;
            tabloCiz();
        };

        async function tabloCiz() {
            if (!secilenSinif) {
                document.getElementById('tablo').innerHTML = "";
                return;
            }

            try {
                let gruplar = [];
                const url = `/grupListesiGetir?sinif=${encodeURIComponent(secilenSinif)}${secilenCalismaGrupIcin ? `&calisma=${encodeURIComponent(secilenCalismaGrupIcin)}` : ''}`;

                // 1. Fetch groups
                const res = await fetch(url);
                if (res.ok) gruplar = await res.json();
                else gruplar = [];

                if (!gruplar || gruplar.length === 0) {
                    // FALLBACK: Load full class list from globalData if valid
                    if (globalData && secilenSinif) {
                        const sinifMevcudu = globalData.filter(x => x['Sƒ±nƒ±fƒ±nƒ±z'] === secilenSinif);
                        if (sinifMevcudu.length > 0) {
                            gruplar = [sinifMevcudu]; // Treat as one single group
                        }
                    }
                }

                if (!gruplar || gruplar.length === 0) {
                    document.getElementById('tablo').innerHTML = `<div style="text-align:center; padding:20px; color:#666;">
                        ${secilenCalismaGrupIcin ? `"${secilenCalismaGrupIcin}" √ßalƒ±≈ümasƒ± i√ßin ${secilenSinif} sƒ±nƒ±fƒ±na ait grup bulunamadƒ±.` : `"${secilenSinif}" sƒ±nƒ±fƒ± i√ßin genel grup bulunamadƒ±.`}
                        <br>Gruba ayƒ±rmak i√ßin yukarƒ±daki butonu kullanƒ±n.
                    </div>`;
                    return;
                }

                // 2. Fetch study data for OA highlighting (only if study is selected)
                let oaMap = {};
                if (secilenCalismaGrupIcin) {
                    const calismaAdi = secilenCalismaGrupIcin.replace("qwx", "").replace(".json", "");
                    try {
                        const resOA = await fetch(`/calismaGetir?isim=www_${calismaAdi}`);
                        if (resOA.ok) {
                            const data = await resOA.json();
                            if (Array.isArray(data)) {
                                data.forEach(s => {
                                    if (s.degerlendirme && s.degerlendirme.OA) {
                                        oaMap[String(s.ogrenciNo)] = true;
                                    }
                                });
                            }
                        }
                    } catch (e) {
                        console.warn("OA fetch warning (rendering will continue):", e);
                    }
                }

                let html = "";
                gruplar.forEach((grup, i) => {
                    // Sort students by Number (ascending)
                    grup.sort((a, b) => {
                        const noA = parseInt(a['Okul Numaranƒ±z']) || 0;
                        const noB = parseInt(b['Okul Numaranƒ±z']) || 0;
                        return noA - noB;
                    });

                    html += `<div class="grup"><h3>${(gruplar.length === 1 && grup.length > 10) ? "SINIF Lƒ∞STESƒ∞" : (i + 1) + ". GRUP"}</h3><ul>`;
                    grup.forEach(ogr => {
                        const hasOA = oaMap[String(ogr['Okul Numaranƒ±z'])];
                        const style = hasOA ? 'background-color: #ffebee;' : '';

                        html += `<li style="${style}"><span class="no">${ogr['Okul Numaranƒ±z']}</span> <span class="ad">${ogr['Adƒ±nƒ±z Soyadƒ±nƒ±z']}</span> <span onclick="s3OAGiris('${ogr['Okul Numaranƒ±z']}')" style="cursor:pointer; margin-left:5px;" title="Not Girmek ƒ∞√ßin Tƒ±klayƒ±n">üìù</span></li>`;
                    });
                    html += "</ul></div>";
                });
                document.getElementById('tablo').innerHTML = html;

            } catch (error) {
                console.error("Tablo Ciz Error:", error);
                document.getElementById('tablo').innerHTML = "Gruplar y√ºklenirken hata olu≈ütu: " + error.message;
            }
        }

        async function s3OAGiris(ogrNo) {
            if (!secilenCalismaGrupIcin) return alert("L√ºtfen √∂nce yukarƒ±dan bir √ßalƒ±≈üma se√ßin. (Notlar √ßalƒ±≈ümaya √∂zeldir)");

            const calismaAdi = secilenCalismaGrupIcin.replace("qwx", "").replace(".json", ""); // Normalize
            try {
                // 1. Fetch current data
                const res = await fetch(`/calismaGetir?isim=www_${calismaAdi}`);
                let data = [];
                if (res.ok) data = await res.json();

                const student = data.find(x => String(x.ogrenciNo) === String(ogrNo)) || { ogrenciNo: ogrNo, degerlendirme: {} };
                const currentOA = (student.degerlendirme && student.degerlendirme.OA) ? student.degerlendirme.OA : "";

                const newOA = prompt(`√ñƒürenci Notu (OA) - ${ogrNo}:`, currentOA);
                if (newOA === null) return; // Cancelled

                // 2. Prepare update
                const newEval = { ...(student.degerlendirme || {}), OA: newOA };

                // 3. Save
                // Only sending degerlendirme to update just that column/field in DB/File
                const payload = {
                    dosyaAdi: "www_" + calismaAdi,
                    veri: {
                        ogrenciNo: ogrNo,
                        degerlendirme: newEval,
                        // Add class/name if creating new record, good practice
                        sinif: secilenSinif
                    }
                };

                const saveRes = await fetch("/kaydet", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (saveRes.ok) {
                    alert("Not kaydedildi: " + newOA);
                } else {
                    alert("Kaydedilemedi.");
                }
            } catch (e) {
                alert("Hata: " + e.message);
            }
        }

        document.getElementById('btnGrupla').onclick = async function () {
            if (!secilenSinif) return alert("Sƒ±nƒ±f se√ßin!");
            if (!secilenCalismaGrupIcin) {
                if (!confirm("Bir √ßalƒ±≈üma se√ßmediniz. Gruplar GENEL sƒ±nƒ±f gruplarƒ± olarak kaydedilecek. Devam etmek istiyor musunuz?")) return;
            }

            const grupSayisiStr = prompt("Sƒ±nƒ±f KA√á ADET gruba b√∂l√ºns√ºn?");
            if (!grupSayisiStr) return;

            const grupSayisi = parseInt(grupSayisiStr);
            if (isNaN(grupSayisi) || grupSayisi < 1) return alert("Ge√ßersiz sayƒ±!");

            // 1. Sƒ±nƒ±f listesini √ßek (veritabani.json veya DB)
            const sinifListesi = globalData.filter(x => x['Sƒ±nƒ±fƒ±nƒ±z'] === secilenSinif);
            if (sinifListesi.length === 0) return alert("Sƒ±nƒ±f bo≈ü!");

            if (grupSayisi > sinifListesi.length) return alert(`Grup sayƒ±sƒ± (${grupSayisi}) √∂ƒürenci sayƒ±sƒ±ndan (${sinifListesi.length}) fazla olamaz!`);

            // Karƒ±≈ütƒ±r
            const karisik = sinifListesi.sort(() => 0.5 - Math.random());

            // Gruplarƒ± olu≈ütur
            const gruplar = Array.from({ length: grupSayisi }, () => []);

            // Daƒüƒ±t (Round-robin distribution to ensure evenness)
            karisik.forEach((ogr, index) => {
                const grupIndex = index % grupSayisi;
                gruplar[grupIndex].push(ogr);
            });

            // Kaydet
            // Send 'calisma' param if selected
            const payload = { sinif: secilenSinif, gruplar: gruplar };
            if (secilenCalismaGrupIcin) payload.calisma = secilenCalismaGrupIcin;

            try {
                const res = await fetch('/kaydet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                if (json.status === "ok") {
                    alert(`${gruplar.length} grup olu≈üturuldu ve kaydedildi!`);
                    tabloCiz();
                } else {
                    alert("Hata: " + json.message);
                }
            } catch (e) { alert("Hata: " + e); }
        };

        document.getElementById('btnSil').onclick = async function () {
            if (!secilenSinif) return alert("Sƒ±nƒ±f se√ßin!");

            let dosyaIsmi = "";
            let msg = "";
            if (secilenCalismaGrupIcin) {
                dosyaIsmi = `ggg${secilenCalismaGrupIcin}${secilenSinif}`; // .json added in server or here? server strips it.
                msg = `"${secilenCalismaGrupIcin}" √ßalƒ±≈ümasƒ± i√ßin "${secilenSinif}" gruplarƒ± silinecek. Emin misiniz?`;
            } else {
                dosyaIsmi = `${secilenSinif}Gruplarƒ±`;
                msg = `"${secilenSinif}" i√ßin GENEL gruplar silinecek. Emin misiniz?`;
            }

            if (!confirm(msg)) return;

            await fetch('/calismaSil', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ calismaIsmi: dosyaIsmi })
            });
            alert("Silindi (Sunucu destekliyorsa).");
            tabloCiz();
        };
        function s3DropdownYukle() {
            const cS = document.getElementById("s3CalismaSec");
            fetch("/listeCalismalar").then(r => r.json()).then(dosyalar => {
                cS.innerHTML = '<option value="">-- Se√ßin --</option>';
                dosyalar.filter(d => d.startsWith("qwx")).forEach(d => { const n = d.replace("qwx", "").replace(".json", ""); cS.appendChild(new Option(n.replace("qwx", ""), n)); });
            });
        }
        function s3AtamalariCek() {
            fetch("/listeCalismalar").then(res => res.json()).then(dosyalar => {
                const qFiles = dosyalar.filter(d => d.startsWith("qqq"));
                aktifAtamalar = []; let count = 0; if (qFiles.length === 0) return s3TabloCiz();
                qFiles.forEach(f => {
                    fetch(`/calismaGetir?isim=${encodeURIComponent(f.replace(".json", ""))}`).then(r => r.json()).then(data => { aktifAtamalar.push(data); count++; if (count === qFiles.length) s3TabloCiz(); })
                        .catch(() => { count++; if (count === qFiles.length) s3TabloCiz(); });
                });
            });
        }
        document.getElementById("btnS3Olustur").onclick = () => {
            const sn = document.getElementById("s3SinifSec").value, cl = document.getElementById("s3CalismaSec").value, yn = document.getElementById("s3YontemSec").value;
            const karisik = document.getElementById("chkKarisikSoru").checked;
            if (!sn || !cl || !yn) return alert("Eksik se√ßim!");
            const dId = "qqq" + sn.replace(/\s/g, '') + cl.replace("qwx", "");
            // Initializing new permissions
            const obj = { id: dId, sinif: sn, calisma: cl.replace("qwx", ""), yontem: yn, gorme: false, aciklamaIzni: false, soruIzni: false, yapma: false, degerl: false, sure: 0, bitis: null, karisikSoru: karisik, odakModu: false };
            fetch("/calismaKaydet", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ calismaIsmi: dId, sorular: obj }) }).then(() => {
                document.getElementById("chkKarisikSoru").checked = false; // Reset checkbox after apply
                setTimeout(s3AtamalariCek, 300);
            });
        };
        function toggleS3Sort(key) {
            if (s3SortKey === key) s3SortDir *= -1;
            else { s3SortKey = key; s3SortDir = 1; }
            s3TabloCiz();
        }
        function s3TabloCiz() {
            const b = document.getElementById("atamaBody"); b.innerHTML = "";
            aktifAtamalar.sort((a, b) => {
                let valA = a[s3SortKey] || "";
                let valB = b[s3SortKey] || "";
                if (typeof valA === 'string') valA = valA.toLocaleLowerCase("tr-TR");
                if (typeof valB === 'string') valB = valB.toLocaleLowerCase("tr-TR");
                if (valA < valB) return -1 * s3SortDir;
                if (valA > valB) return 1 * s3SortDir;
                return 0;
            }).forEach(a => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${a.sinif}</td><td>${a.calisma}</td><td><b>${a.yontem}</b></td>
                <td style="font-size:0.85em; white-space:nowrap;">
                    <div style="display:flex; flex-direction:row; gap:8px; align-items:center;">
                        <label style="cursor:pointer;" title="A√ßƒ±klama metnini ve Grup listesini g√∂ster"><input type="checkbox" ${a.aciklamaIzni ? 'checked' : ''} onchange="s3Upd('${a.id}','aciklamaIzni',this.checked)"> A√ßƒ±klama</label>
                        <label style="cursor:pointer;" title="Sorularƒ± ve √∂ƒürenci cavaplarƒ±nƒ± g√∂ster (Salt Okunur)"><input type="checkbox" ${a.soruIzni ? 'checked' : ''} onchange="s3Upd('${a.id}','soruIzni',this.checked)"> Sorular</label>
                        <label style="cursor:pointer; color:#d32f2f; font-weight:bold;" title="√ñƒürenci sorulara √ßalƒ±≈üƒ±rken sorularƒ±n sƒ±rasƒ±nƒ± karƒ±≈ütƒ±r"><input type="checkbox" ${a.karisikSoru ? 'checked' : ''} onchange="s3Upd('${a.id}','karisikSoru',this.checked)"> Karƒ±≈üƒ±k</label>
                    </div>
                </td>
                <td style="white-space:nowrap;">
                    <div style="display:flex; flex-direction:row; gap:10px; align-items:center;">
                        <label style="cursor:pointer;" title="√ñƒürencinin √ßalƒ±≈ümayƒ± yapmasƒ±na izin ver"><input type="checkbox" id="chk_${a.id}" ${a.yapma ? 'checked' : ''} onchange="s3Upd('${a.id}','yapma',this.checked)"> ƒ∞zin</label>
                        <label style="cursor:pointer; color:#1976d2; font-size:0.85em; font-weight:bold; background:#e3f2fd; padding:3px 6px; border-radius:4px;" title="Sƒ±nav esnasƒ±nda sekme deƒüi≈üimini engelle (Kopya Korumasƒ±)"><input type="checkbox" ${a.odakModu ? 'checked' : ''} onchange="s3Upd('${a.id}','odakModu',this.checked)"> Odak</label>
                    </div>
                </td>
                <td><input type="checkbox" ${a.degerl ? 'checked' : ''} onchange="s3Upd('${a.id}','degerl',this.checked)"></td>
                <td style="white-space:nowrap;"><input type="number" id="inp_${a.id}" value="${a.sure || 0}" style="width:40px" min="0"><button onclick="s3Start('${a.id}')" class="action blue" style="min-width:auto; padding:5px; margin-left:2px;">OK</button></td>
                <td><span class="timer-text" id="t_${a.id}">${(!a.yapma && a.sure > 0) ? "Bƒ∞TTƒ∞" : "--:--"}</span></td>
                <td><button onclick="s3Del('${a.id}')" class="action red" style="min-width:auto; padding:5px;">Sil</button></td>`;
                b.appendChild(tr);
            });
        }
        async function s3Upd(id, k, v) {
            const a = aktifAtamalar.find(x => x.id === id);
            if (a) {
                a[k] = v;
                // If setting granular permissions, clear legacy 'gorme' to avoid override
                if (k === 'aciklamaIzni' || k === 'soruIzni') a.gorme = false;

                // Immediate UI update for 'yapma'
                if (k === 'yapma') {
                    const el = document.getElementById("t_" + id);
                    if (el) el.textContent = v ? "--:--" : (a.sure > 0 ? "Bƒ∞TTƒ∞" : "--:--");
                }

                try {
                    const res = await fetch("/calismaKaydet", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ calismaIsmi: id, sorular: a })
                    });
                    if (!res.ok) throw new Error("Kaydedilemedi");
                } catch (e) {
                    alert("Ayar kaydedilirken hata olu≈ütu: " + e.message);
                    // Revert visual change? maybe too complex for now, but at least alert.
                }
            }
        }
        function s3Start(id) {
            const a = aktifAtamalar.find(x => x.id === id);
            let s = parseInt(document.getElementById("inp_" + id).value) || 0;

            // Prevent negative
            if (s < 0) {
                s = 0;
                document.getElementById("inp_" + id).value = 0;
            }

            if (a) {
                a.sure = s;

                if (s > 0) {
                    // Timer set -> Grant Permission
                    a.yapma = true;
                    a.bitis = Date.now() + (s * 60 * 1000);
                } else {
                    // 0 Duration -> Revoke Permission (Stop)
                    a.yapma = false;
                    a.bitis = null;
                }

                s3Upd(id, 'bitis', a.bitis);
                s3Upd(id, 'yapma', a.yapma);
                s3Upd(id, 'sure', s);
                s3TabloCiz();
            }
        }
        function s3Del(id) { if (confirm("Sil?")) fetch("/calismaSil", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ calismaIsmi: id }) }).then(() => s3AtamalariCek()); }

        setInterval(() => {
            aktifAtamalar.forEach(a => {
                const el = document.getElementById("t_" + a.id);
                if (!el) return;

                // Priority: If yapma is false -> Bƒ∞TTƒ∞ (only if duration > 0)
                if (!a.yapma) {
                    el.textContent = (a.sure > 0) ? "Bƒ∞TTƒ∞" : "--:--";
                    return;
                }

                if (!a.bitis) return;

                const diff = a.bitis - Date.now();
                if (diff > 0) { el.textContent = `${Math.floor(diff / 60000).toString().padStart(2, '0')}:${Math.floor((diff % 60000) / 1000).toString().padStart(2, '0')} `; }
                else { el.textContent = "Bƒ∞TTƒ∞"; if (a.yapma) { a.yapma = false; s3Upd(a.id, 'yapma', false); } }
            });
        }, 1000);

        function s4DosyaListesiYukle() {
            fetch("/listeCalismalar").then(r => r.json()).then(dosyalar => {
                // Populate Study Selects
                document.getElementById("s3CalismaSec").innerHTML = '<option value="">-- Se√ßin --</option>';
                document.getElementById("s4DosyaSec").innerHTML = '<option value="">-- Se√ß --</option>';
                document.getElementById("sinifCalismaSec").innerHTML = '<option value="">-- √áalƒ±≈üma Se√ßin --</option>';

                dosyalar.filter(d => d.startsWith("qwx")).forEach(d => {
                    const name = d.replace("qwx", "").replace(".json", "");
                    // S3
                    const opt3 = document.createElement("option"); opt3.value = name; opt3.textContent = name;
                    document.getElementById("s3CalismaSec").appendChild(opt3);
                    // S4
                    const opt4 = document.createElement("option"); opt4.value = name; opt4.textContent = name;
                    document.getElementById("s4DosyaSec").appendChild(opt4);
                    // Group Creation
                    const optG = document.createElement("option"); optG.value = name; optG.textContent = name;
                    document.getElementById("sinifCalismaSec").appendChild(optG);
                });
            });
        }

        document.getElementById("s4DosyaSec").onchange = async function () {
            const calisma = this.value;
            const sinifSel = document.getElementById("s4SinifSec");
            document.getElementById("btnDegerlendirmeSifirla").style.display = "none";
            const chkOgr = document.getElementById("chkDegerlendirmeIzin");
            const chkOgrt = document.getElementById("chkIzin");

            sinifSel.innerHTML = '<option value="">...</option>';
            const btnPuan = document.getElementById('btnPuanTablosu');
            const btnSifirla = document.getElementById('btnTumCevaplariSifirla');

            if (!calisma) {
                chkOgr.disabled = true; chkOgrt.disabled = true;
                btnPuan.style.display = 'none';
                btnSifirla.style.display = 'none';
                return;
            }

            btnPuan.style.display = 'inline-block';
            btnSifirla.style.display = 'inline-block';

            chkOgr.disabled = false; chkOgrt.disabled = false;

            try {
                const [dosyalar, rW] = await Promise.all([
                    (await fetch("/listeCalismalar")).json(),
                    fetch(`/calismaGetir?isim=www_${calisma}`).catch(() => null)
                ]);

                let wwwData = [];
                if (rW && rW.ok) wwwData = await rW.json();

                const ayar = wwwData.find(x => x.ogrenciNo === "AYARLAR");
                chkOgr.checked = ayar ? ayar.degerlendirmeIzni : false;
                chkOgrt.checked = ayar ? ayar.izin : false;

                const atananlar = dosyalar.filter(f => f.startsWith("qqq") && f.replace(".json", "").endsWith(calisma));

                sinifSel.innerHTML = '<option value="">-- Se√ß --</option>';

                for (let f of atananlar) {
                    const data = await (await fetch(`/calismaGetir?isim=${f.replace(".json", "")}`)).json();
                    if (data.sinif) {
                        const buSinifinTumCevaplari = wwwData.filter(r => r.sinif === data.sinif && r.ogrenciNo !== "AYARLAR");
                        const buSinifinBitmisCevaplari = buSinifinTumCevaplari.filter(r => r.degerlendirme && (r.degerlendirme.degerlendirildi || typeof r.degerlendirme.toplam !== "undefined"));

                        // User: "sƒ±nava girenler deƒüerlendiyse bitmi≈ütir"
                        const cevapVerenKayitlar = buSinifinTumCevaplari.filter(r => (r.cevaplar && r.cevaplar.length > 0));
                        const hepsiBittiMi = (cevapVerenKayitlar.length > 0 && cevapVerenKayitlar.every(r => r.degerlendirme && (r.degerlendirme.degerlendirildi || typeof r.degerlendirme.toplam !== "undefined")));

                        sinifSel.appendChild(new Option(data.sinif + (hepsiBittiMi ? " (Bitti)" : ""), data.sinif));
                    }
                }
            } catch (e) { console.error("Hata:", e); }
        };

        document.getElementById("s4SinifSec").onchange = function () {
            const btn = document.getElementById("btnDegerlendirmeSifirla");
            if (this.selectedIndex >= 0) {
                const text = this.options[this.selectedIndex].text;
                if (text.includes("(Bitti)")) {
                    btn.style.display = "inline-block";
                } else {
                    btn.style.display = "none";
                }
            } else {
                btn.style.display = "none";
            }
        };

        document.getElementById("btnDegerlendirmeSifirla").onclick = function () {
            DegerlendirmeApp.modalSifirla();
        };

        document.getElementById("chkDegerlendirmeIzin").onchange = function () {
            if (this.checked) document.getElementById("chkIzin").checked = false;
            izinKaydet();
        };
        document.getElementById("chkIzin").onchange = function () {
            if (this.checked) document.getElementById("chkDegerlendirmeIzin").checked = false;
            izinKaydet();
        };

        function izinKaydet() {
            const val = document.getElementById("s4DosyaSec").value; if (!val) return;
            const isDegIzni = document.getElementById("chkDegerlendirmeIzin").checked;
            const ayar = { ogrenciNo: "AYARLAR", sinif: "SISTEM", degerlendirmeIzni: isDegIzni, izin: document.getElementById("chkIzin").checked, tarih: new Date().toLocaleString() };
            fetch("/kaydet", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dosyaAdi: "www_" + val, veri: ayar }) })
                .then(async () => {
                    // Propagate to Tab 3 (Assignments)
                    const promises = aktifAtamalar.filter(a => a.calisma === val).map(a => {
                        a.degerl = isDegIzni;
                        return fetch("/calismaKaydet", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ calismaIsmi: a.id, sorular: a })
                        });
                    });
                    await Promise.all(promises);
                    setTimeout(s3AtamalariCek, 200);
                });
        }

        document.getElementById("btnDegerlendirmeBaslat").onclick = () => {
            DegerlendirmeApp.baslat();
        };

        const DegerlendirmeApp = {
            kuyruk: [], kuyrukIndex: 0, activeVeri: null, sorular: [], sIdx: 0, anlikPuanlar: {}, seciliSinif: "", seciliCalisma: "",
            baslat: async function () {
                this.seciliCalisma = document.getElementById("s4DosyaSec").value;
                this.seciliSinif = document.getElementById("s4SinifSec").value.replace(" (Bitti)", "");
                if (!this.seciliCalisma || !this.seciliSinif) return alert("Se√ßim yapƒ±n.");
                try {
                    const rW = await fetch(`/calismaGetir?isim=www_${this.seciliCalisma}`);
                    if (!rW.ok) throw new Error("Dosya Yok");
                    const tumCevaplar = await rW.json();
                    const sinifKaydiVarMi = tumCevaplar.some(x => x.sinif === this.seciliSinif);
                    if (!sinifKaydiVarMi) throw new Error("Sƒ±nƒ±f Kaydƒ± Yok");

                    // CHECK: Hi√ß cevap var mƒ±?
                    const buSinifCevaplari = tumCevaplar.filter(x => x.sinif === this.seciliSinif);
                    const cevapVarMi = buSinifCevaplari.some(x => {
                        // Check for valid un-evaluated answers or just any answers
                        // User said: "Hi√ß cevap yoksa" -> so check if any student has submitted answers
                        if (x.cevaplar && x.cevaplar.length > 0) return true;
                        if (x.answers && x.answers.length > 0) return true; // Legacy fallback
                        return false;
                    });

                    if (!cevapVarMi) {
                        if (!confirm("‚ö†Ô∏è UYARI: Bu sƒ±nƒ±f i√ßin hen√ºz kaydedilmi≈ü cevap g√∂r√ºnm√ºyor.\n\nEƒüer √∂ƒürenciler cevaplarƒ± g√∂nderdiyse senkronizasyon tamamlanmamƒ±≈ü olabilir.\nYine de deƒüerlendirmeyi ba≈ülatmak istiyor musunuz?")) {
                            // Reset selection or UI?
                            document.getElementById("degSecimPaneli").style.display = "block";
                            document.getElementById("degerlendirmeContainer").style.display = "none";
                            return;
                        }
                    }

                } catch (e) { alert("≈ûu an bu √áalƒ±≈ümayƒ± Deƒüerlendiremezsiniz (Kayƒ±t yok veya Hata)."); return; }

                const qName = "qqq" + this.seciliSinif.replace(/\s/g, '') + this.seciliCalisma;
                const dQ = await (await fetch(`/calismaGetir?isim=${qName}`)).json();
                document.getElementById("degSecimPaneli").style.display = "none"; document.getElementById("degerlendirmeContainer").style.display = "block";
                document.getElementById("degBilgiUst").textContent = this.seciliCalisma;
                this.sorular = (await (await fetch(`/calismaGetir?isim=qwx${this.seciliCalisma}`)).json()).sorular || [];
                const cevaplarVerisi = await (await fetch(`/calismaGetir?isim=www_${this.seciliCalisma}`)).json();
                this.kuyruk = [];

                if (dQ.yontem === "Grup") {
                    const gruplar = await (await fetch(`/grupListesiGetir?sinif=${encodeURIComponent(this.seciliSinif)}&calisma=${encodeURIComponent(this.seciliCalisma)}`)).json();
                    gruplar.forEach((grp, idx) => {
                        const kayit = cevaplarVerisi.find(tv => grp.some(u => String(tv.ogrenciNo) === String(u["Okul Numaranƒ±z"])));
                        if (kayit && kayit.degerlendirme && (kayit.degerlendirme.degerlendirildi || typeof kayit.degerlendirme.toplam !== "undefined")) return;

                        // Cevap olmasa bile listeye ekle (Sƒ±fƒ±rlandƒ±ktan sonra eri≈üim i√ßin)
                        const safeKayit = kayit || { ogrenciNo: grp[0]["Okul Numaranƒ±z"], cevaplar: [], puanlar: {} };
                        this.kuyruk.push({ baslik: `${this.seciliSinif} - ${idx + 1}.GRUP`, kayit: safeKayit, katilmadi: false, members: grp.map(u => String(u["Okul Numaranƒ±z"])) });
                    });
                } else {
                    globalData.filter(u => u["Sƒ±nƒ±fƒ±nƒ±z"] === this.seciliSinif).forEach(ogr => {
                        const no = String(ogr["Okul Numaranƒ±z"]);
                        const kayit = cevaplarVerisi.find(x => String(x.ogrenciNo) === no);
                        if (kayit && kayit.degerlendirme && (kayit.degerlendirme.degerlendirildi || typeof kayit.degerlendirme.toplam !== "undefined")) return;

                        // Robustly handle kayit structure
                        let safeKayit = { ogrenciNo: no, cevaplar: [], puanlar: {} };

                        if (kayit) {
                            let cevaplarListesi = [];
                            if (Array.isArray(kayit)) {
                                cevaplarListesi = kayit;
                            } else if (Array.isArray(kayit.cevaplar)) {
                                cevaplarListesi = kayit.cevaplar;
                            } else if (kayit.answers && Array.isArray(kayit.answers)) { // Handle raw SQL fallback if any
                                cevaplarListesi = kayit.answers;
                            }

                            safeKayit = {
                                ogrenciNo: no,
                                cevaplar: cevaplarListesi,
                                puanlar: kayit.puanlar || {},
                                degerlendirme: kayit.degerlendirme
                            };
                        }

                        this.kuyruk.push({ baslik: `${no} - ${ogr["Adƒ±nƒ±z Soyadƒ±nƒ±z"]} `, kayit: safeKayit, katilmadi: false, members: [no] });
                    });
                }
                this.kuyrukIndex = 0;

                if (this.kuyruk.length === 0) {
                    document.getElementById('degerlendirmeContainer').style.display = 'none';
                    document.getElementById('bitmisUyariModal').style.display = 'block';
                    return;
                }
                this.yukle();
            },
            modalSifirla: async function () {
                // YENƒ∞LENEN SIFIRLAMA MANTIƒûI: Verileri √ßek, puanƒ± temizle, geri y√ºkle.
                const calisma = document.getElementById("s4DosyaSec").value;
                const sinif = document.getElementById("s4SinifSec").value.replace(" (Bitti)", "");

                try {
                    // 1. Mevcut cevaplarƒ± √ßek
                    const res = await fetch(`/calismaGetir?isim=www_${calisma}`);
                    const data = await res.json();

                    const syncPromises = [];
                    // 2. ƒ∞lgili sƒ±nƒ±fƒ±n kayƒ±tlarƒ±nƒ± bul ve g√ºncelle
                    data.forEach(student => {
                        if (String(student.sinif).trim() === String(sinif).trim()) {
                            student.puanlar = {}; // Puanlarƒ± sil
                            if (student.degerlendirme) {
                                delete student.degerlendirme.degerlendirildi;
                                delete student.degerlendirme.toplam;
                                delete student.degerlendirme.OA;
                            }

                            // 3. G√ºncellenmi≈ü veriyi sunucuya geri y√ºkle (Cevaplar korunur)
                            syncPromises.push(fetch("/kaydet", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    dosyaAdi: "www_" + calisma,
                                    veri: student
                                })
                            }));
                        }
                    });

                    // 3. SQL Tablosunu da sƒ±fƒ±rla
                    syncPromises.push(fetch(`/degerlendirmeSifirla?sinif=${encodeURIComponent(sinif)}&calisma=${encodeURIComponent(calisma)}`));

                    await Promise.all(syncPromises);
                    alert("Puanlar sƒ±fƒ±rlandƒ±! Sƒ±nƒ±f listesi g√ºncelleniyor.");
                    location.reload();
                } catch (e) {
                    alert("Sƒ±fƒ±rlama sƒ±rasƒ±nda hata olu≈ütu: " + e);
                }
            },
            yukle: async function () {
                if (this.kuyrukIndex >= this.kuyruk.length) { alert("Bitti!"); location.reload(); return; }
                const item = this.kuyruk[this.kuyrukIndex];

                // --- OTOMATƒ∞K "G" (Gƒ∞RMEDƒ∞/KATILMADI) ƒ∞≈ûLEME ---
                // Eƒüer cevap yoksa (katilmadi) veya bo≈ü cevap dizisi varsa
                const cevapYok = !item.kayit || !item.kayit.cevaplar || item.kayit.cevaplar.length === 0;

                if (cevapYok) {
                    const promises = [];
                    item.members.forEach(ogrNo => {
                        promises.push(fetch("/degerlendirmeBitir", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                dosyaAdi: `www_${this.seciliCalisma}`,
                                ogrenciNo: ogrNo,
                                sinif: this.seciliSinif,
                                toplam: "G",
                                degerlendirildi: true
                            })
                        }));
                    });
                    await Promise.all(promises);
                    this.kuyrukIndex++;
                    this.yukle();
                    return;
                }

                document.getElementById("degOgrenciBaslik").textContent = item.baslik;
                this.anlikPuanlar = (item.kayit && item.kayit.puanlar) ? item.kayit.puanlar : {};

                // --- OA AUTO-EVALUATE LOGIC ---
                if (item.kayit && item.kayit.degerlendirme && item.kayit.degerlendirme.OA) {
                    const oa = item.kayit.degerlendirme.OA.toLowerCase().trim();
                    let autoCode = null;
                    if (oa.includes("girmedi") || oa.includes("gelmedi")) autoCode = "G";
                    else if (oa.includes("mazeretli")) autoCode = "M";
                    else if (oa.includes("√ßalƒ±≈ümadƒ±") || oa.includes("calismadi")) autoCode = "0";

                    if (autoCode) {
                        this.sorular.forEach((_, i) => {
                            this.anlikPuanlar[i] = [autoCode];
                        });
                    }
                }

                // --- AUTO-EVALUATE MULTIPLE CHOICE AND TEXT QUESTIONS ---
                const rawAnswers = item.kayit.cevaplar || [];
                const normalizedAnswers = Array.isArray(rawAnswers) && rawAnswers.length > 0 && typeof rawAnswers[0] === 'object' && rawAnswers[0].cevaplar ? rawAnswers :
                    (Array.isArray(rawAnswers) && rawAnswers.answers ? rawAnswers.answers : rawAnswers);

                this.activeVeri = item.kayit;
                this.activeVeri.cevaplar = normalizedAnswers;

                this.sorular.forEach((soru, sIdx) => {
                    const sAnsObj = normalizedAnswers.find(c => Number(c.soruIndex) === Number(sIdx));
                    if (!sAnsObj || !sAnsObj.cevaplar || sAnsObj.cevaplar.length === 0) return;

                    const studentAnsStr = sAnsObj.cevaplar[0];
                    if (studentAnsStr === undefined || studentAnsStr === "") return;

                    if (typeof soru === 'object' && soru.type === 'coktan_secmeli') {
                        if (!this.anlikPuanlar[sIdx]) this.anlikPuanlar[sIdx] = [];
                        if (this.anlikPuanlar[sIdx][0] === undefined) {
                            const isCorrect = String(studentAnsStr) === String(soru.dogruCevap);
                            this.anlikPuanlar[sIdx][0] = isCorrect ? 1 : 0;
                        }
                    } else if (typeof soru === 'object' && soru.type === 'text' && soru.cevabiVar) {
                        if (!this.anlikPuanlar[sIdx]) this.anlikPuanlar[sIdx] = [];
                        if (this.anlikPuanlar[sIdx][0] === undefined) {
                            const isCorrect = String(studentAnsStr).trim().toLowerCase() === String(soru.dogruCevap || "").trim().toLowerCase();
                            this.anlikPuanlar[sIdx][0] = isCorrect ? 1 : 0;
                        }
                    }
                });

                document.getElementById("degNormalPanel").style.display = "flex";
                this.sIdx = 0;
                this.soruKontrolEtVeRender(1);
            },
            soruKontrolEtVeRender: function (direction) {
                if (this.sIdx >= this.sorular.length) { this.sonrakiKisi(); return; }
                if (this.sIdx < 0) { this.sIdx = 0; }
                this.renderSoru();
            },
            renderSoru: function () {
                const sObj = this.sorular[this.sIdx];
                const soruMetni = (typeof sObj === 'object') ? sObj.soru : sObj;
                const isMCQ = (typeof sObj === 'object' && sObj.type === 'coktan_secmeli');

                document.getElementById("degSoruNo").textContent = this.sIdx + 1;
                document.getElementById("degSoruMetin").innerHTML = linkleriDonustur(soruMetni);

                const cevapObj = (this.activeVeri.cevaplar || []).find(c => Number(c.soruIndex) === Number(this.sIdx));

                // Robust handling for answers structure in frontend
                let cevaplar = [];
                if (cevapObj) {
                    if (Array.isArray(cevapObj)) {
                        cevaplar = cevapObj;
                    } else if (cevapObj.cevaplar && Array.isArray(cevapObj.cevaplar)) {
                        cevaplar = cevapObj.cevaplar;
                    } else if (Array.isArray(cevapObj.cevaplar)) {
                        // Fallback, should be covered above but explicitly checking property
                        cevaplar = cevapObj.cevaplar;
                    }
                }

                const puanlar = this.anlikPuanlar[this.sIdx] || [];
                let h = "";

                if (isMCQ) {
                    const studentChoiceIndex = (cevaplar && cevaplar.length > 0) ? parseInt(cevaplar[0]) : -1;
                    const p = puanlar[0];

                    h += `<div style="display:flex; flex-direction:column; gap:8px; margin-bottom:15px; width:100%;">`;
                    (sObj.secenekler || []).forEach((sec, idx) => {
                        const char = String.fromCharCode(65 + idx);
                        const isSelected = (idx === studentChoiceIndex);
                        const isCorrectAnswer = (idx === sObj.dogruCevap);

                        let optStyle = `padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: #f9f9f9; display: flex; align-items: center;`;

                        // Highlight student's choice
                        if (isSelected) {
                            optStyle = `padding: 12px; border: 2px solid ${Number(p) === 1 ? '#4CAF50' : '#F44336'}; border-radius: 8px; background: ${Number(p) === 1 ? '#e8f5e9' : '#ffebee'}; display: flex; align-items: center; box-shadow: 0 2px 8px ${Number(p) === 1 ? 'rgba(76, 175, 80, 0.3)' : 'rgba(244, 67, 54, 0.3)'};`;
                        }

                        h += `<div style="${optStyle}">
                            <strong style="margin-right:15px; font-size:1.1rem; color:#555;">${char})</strong>
                            <span style="flex:1; font-size:1rem; color:#333;">${sec}</span>
                            ${isSelected ? `<span style="font-size:0.8rem; font-weight:bold; color:white; background:${Number(p) === 1 ? '#4CAF50' : '#F44336'}; padding:3px 8px; border-radius:12px; margin-left:10px;">√ñƒürenci Se√ßimi</span>` : ''}
                            ${(!isSelected && isCorrectAnswer && Number(p) === 0) ? `<span style="font-size:0.8rem; font-weight:bold; color:#4CAF50; border:1px solid #4CAF50; padding:2px 8px; border-radius:12px; margin-left:10px;">Doƒüru Cevap</span>` : ''}
                        </div>`;
                    });
                    h += `</div>`;

                    if (studentChoiceIndex === -1 && cevaplar.length === 0) {
                        h += `<div style="padding:20px; color:#999; font-style:italic; text-align:center;">√ñƒürenci bu soruyu bo≈ü bƒ±rakmƒ±≈ü.</div>`;
                    }

                    const btnDClass = (Number(p) === 1) ? 'aktif' : '';
                    const btnYClass = (Number(p) === 0 || p === "G" || p === "M") ? 'aktif' : '';
                    const yTitle = (p === "G" ? "Girmedi" : (p === "M" ? "Mazeretli" : "Yanlƒ±≈ü"));
                    const yText = (p === "G" || p === "M") ? p : "Y";

                    h += `<div class="deg-cevap-item" style="justify-content:center; background:none; border:none; box-shadow:none; padding-top:10px;">
                    <div class="deg-buton-grubu">
                        <button class="deg-btn-puan deg-dogru ${btnDClass}" onclick="DegerlendirmeApp.puanla(0,1)">D</button>
                        <button class="deg-btn-puan deg-yanlis ${btnYClass}" onclick="DegerlendirmeApp.puanla(0,0)" title="${yTitle}">${yText}</button>
                    </div>
                    </div>`;
                } else {
                    if (cevaplar.length === 0) {
                        h = "<div style='padding:20px; color:#999; font-style:italic;'>Bu soruya cevap verilmemi≈ü.</div>";
                    } else {
                        cevaplar.forEach((txt, i) => {
                            if (txt && txt.trim() !== "") {
                                const p = puanlar[i];
                                const convertedTxt = linkleriDonustur(txt);
                                const btnDClass = (Number(p) === 1) ? 'aktif' : '';
                                const btnYClass = (Number(p) === 0 || p === "G" || p === "M") ? 'aktif' : '';
                                const yTitle = (p === "G" ? "Girmedi" : (p === "M" ? "Mazeretli" : "Yanlƒ±≈ü"));
                                const yText = (p === "G" || p === "M") ? p : "Y";

                                h += `<div class="deg-cevap-item" ondblclick="DegerlendirmeApp.hizliGecBos(event, '${txt || ''}')">
                                    <div class="deg-cevap-metin">${convertedTxt}</div>
                                    <div class="deg-buton-grubu">
                                        <button class="deg-btn-puan deg-dogru ${btnDClass}" onclick="event.stopPropagation(); DegerlendirmeApp.puanla(${i},1)" ondblclick="event.stopPropagation(); DegerlendirmeApp.hizliGec(${i},1)">D</button>
                                        <button class="deg-btn-puan deg-yanlis ${btnYClass}" onclick="event.stopPropagation(); DegerlendirmeApp.puanla(${i},0)" ondblclick="event.stopPropagation(); DegerlendirmeApp.hizliGec(${i},0)" title="${yTitle}">${yText}</button>
                                    </div></div>`;
                            }
                        });
                    }
                }

                document.getElementById("degCevapListesi").innerHTML = h;
                const son = (this.sIdx === this.sorular.length - 1);
                document.getElementById("btnDegIleri").style.display = son ? "none" : "block"; document.getElementById("btnDegBitir").style.display = son ? "block" : "none";
                this.guncellePuan();
            },
            puanla: function (cIdx, p) { if (!this.anlikPuanlar[this.sIdx]) this.anlikPuanlar[this.sIdx] = []; this.anlikPuanlar[this.sIdx][cIdx] = p; this.renderSoru(); },
            hizliGec: function (cIdx, p) { this.puanla(cIdx, p); if (this.sIdx < this.sorular.length - 1) this.nav(1); },
            hizliGecBos: function (e, metin) { if (!metin || metin.trim() === "" || e.offsetX > (e.currentTarget.offsetWidth * 0.6)) { if (this.sIdx < this.sorular.length - 1) this.nav(1); } },
            guncellePuan: function () {
                let t = 0;
                Object.entries(this.anlikPuanlar).forEach(([sIx, arr]) => {
                    const soru = this.sorular[sIx];
                    const isMCQ = (typeof soru === 'object' && soru.type === 'coktan_secmeli');

                    if (Array.isArray(arr)) {
                        if (isMCQ) {
                            const p = arr[0];
                            if (Number(p) === 1) {
                                t += 1;
                            } else if (Number(p) === 0) {
                                const secenekSayisi = (soru.secenekler || []).length;
                                if (secenekSayisi > 1) {
                                    t -= 1 / (secenekSayisi - 1);
                                }
                            }
                        } else {
                            arr.forEach(p => { if (Number(p) === 1) t++; });
                        }
                    }
                });
                const scoreDisp = Math.max(0, t).toFixed(2).replace(/\.00$/, "");
                document.getElementById("degPuanGosterge").textContent = scoreDisp;
            },
            nav: function (n) { let nextIdx = this.sIdx + n; if (nextIdx < 0) return; this.sIdx = nextIdx; this.soruKontrolEtVeRender(n); },
            sonrakiKisi: async function () {
                const item = this.kuyruk[this.kuyrukIndex];
                if (!item.katilmadi) {
                    // Toplam Puanƒ± Hesapla
                    let toplamPuan = parseFloat(document.getElementById("degPuanGosterge").textContent) || 0;

                    const bitirPromises = [];
                    for (const ogrNo of item.members) {
                        // Batch optimization: Send both evaluation metadata AND all scores in one request
                        bitirPromises.push(fetch("/degerlendirmeBitir", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                dosyaAdi: `www_${this.seciliCalisma}`,
                                ogrenciNo: ogrNo,
                                sinif: this.seciliSinif,
                                toplam: toplamPuan,
                                degerlendirildi: true,
                                puanlar: this.anlikPuanlar // SEND ALL SCORES AT ONCE
                            })
                        }));
                    }
                    await Promise.all(bitirPromises);
                }
                this.kuyrukIndex++; this.yukle();
            }
        };
    </script>
</body>

</html>