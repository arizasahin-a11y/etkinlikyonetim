<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Etkinlik Y√∂netim Paneli</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* GENEL STƒ∞LLER */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            font-size: 14px;
        }

        h1 {
            text-align: center;
            padding: 15px;
            background: #673AB7;
            color: white;
            margin: 0;
            font-size: 1.2rem;
        }

        .tab-container {
            display: flex;
            flex-direction: column;
        }

        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            background: #ede7f6;
            border-bottom: 1px solid #d1c4e9;
        }

        .tab-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: bold;
            color: #5e35b1;
            transition: 0.3s;
        }

        .tab-buttons button.active {
            background: #673AB7;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 15px;
        }

        .tab-content.active {
            display: block;
        }

        /* BUTONLAR */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }

        button.action {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        button.blue {
            background-color: #2196F3;
        }

        button.red {
            background-color: #f44336;
        }

        button.orange {
            background-color: #FF9800;
        }

        select,
        input[type="number"],
        input[type="text"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #d1c4e9;
            outline: none;
            background: white;
        }

        .grup-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 25px;
            justify-content: center;
        }

        .grup {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            background: white;
            width: 300px;
        }

        .grup h3 {
            margin-top: 0;
            color: #673AB7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: center;
        }

        th {
            background-color: #f5f5f5;
            color: #333;
        }

        #calismaListesi {
            list-style-type: none;
            padding: 0;
            margin-top: 15px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        #calismaListesi li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            border: 1px solid #e0e0e0;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            background: #fff;
        }

        #calismaListesi li.selected {
            background-color: #ede7f6;
            border: 2px solid #673AB7;
            color: #5e35b1;
            font-weight: bold;
        }

        .btn-archive-small {
            background: #FF9800;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .atama-panel {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #d1c4e9;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            justify-content: center;
        }

        .timer-text {
            font-family: monospace;
            font-weight: bold;
            color: #d32f2f;
            font-size: 1.1em;
        }

        .yonetim-cerceve {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #d1c4e9;
            margin-bottom: 15px;
        }

        .yonetim-toolbar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .chk-container {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            margin: 0;
        }

        .kucuk-select {
            padding: 6px;
            font-size: 12px;
            min-width: 140px;
        }

        #degerlendirmeContainer {
            display: none;
            margin-top: 15px;
            border-top: 2px solid #673AB7;
            padding-top: 15px;
        }

        .deg-card {
            background: white;
            width: 100%;
            border-radius: 8px;
            display: flex;
            flex-direction: row;
            height: 450px;
            border: 1px solid #bbb;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .deg-soru-bolumu {
            background: #e8f5e9;
            padding: 20px;
            border-right: 1px solid #c8e6c9;
            color: #1b5e20;
            overflow-y: auto;
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            font-size: 0.95rem;
        }

        .deg-cevap-bolumu {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            background: #fff;
            font-size: 0.95rem;
        }

        .deg-cevap-item {
            position: relative;
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 12px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 6px;
            min-height: 60px;
            cursor: pointer;
        }

        .deg-cevap-metin {
            flex: 1;
            min-height: 40px;
            padding-right: 70px;
            word-wrap: break-word;
        }

        .deg-buton-grubu {
            position: absolute;
            bottom: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            z-index: 5;
        }

        .deg-btn-puan {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            color: #666;
        }

        .deg-dogru.aktif {
            background: #2e7d32 !important;
            color: white !important;
        }

        .deg-yanlis.aktif {
            background: #d32f2f !important;
            color: white !important;
        }

        .deg-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #eee;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 8px;
            position: relative;
            min-height: 40px;
        }

        .deg-header-left {
            text-align: left;
            font-weight: bold;
            color: #d32f2f;
            font-size: 1.1rem;
            text-transform: uppercase;
            z-index: 2;
            flex: 1;
        }

        .deg-header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-weight: bold;
            color: #000;
            font-size: 1.1rem;
            z-index: 1;
            white-space: nowrap;
        }

        .deg-header-right {
            text-align: right;
            font-weight: bold;
            color: #673AB7;
            font-size: 1.1rem;
            z-index: 2;
            flex: 1;
        }

        .deg-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .soru-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            background: #fdfdfd;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .soru-no {
            font-weight: bold;
            color: #673AB7;
            min-width: 70px;
        }

        /* MEDYA G√ñMME STƒ∞LLERƒ∞ */
        .embedded-wrapper {
            width: 100%;
            margin-top: 10px;
            margin-bottom: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 5px;
            background: #fff;
        }

        .embedded-img {
            max-height: 200px;
            max-width: 100%;
            cursor: pointer;
            transition: transform 0.2s;
            display: block;
            margin: 0 auto;
        }

        .embedded-img.hover {
            transform: scale(1.02);
        }

        .embedded-img.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-height: 100vh;
            object-fit: contain;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            box-sizing: border-box;
        }

        .embedded-video {
            max-width: 100%;
            height: auto;
            max-height: 300px;
            display: block;
            margin: 0 auto;
        }

        .embedded-audio {
            width: 100%;
        }

        .embedded-iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .embed-fallback {
            text-align: center;
            font-size: 12px;
            margin-top: 5px;
            background: #f1f1f1;
            padding: 5px;
            border-radius: 4px;
        }

        .embed-fallback a {
            color: #1976D2;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>Etkinlik Y√∂netim Paneli</h1>
    <div class="tab-container">
        <div class="tab-buttons">
            <button onclick="openTab(event,'sekme1')">√áalƒ±≈üma ≈ûekli</button>
            <button onclick="openTab(event,'sekme2')">√áalƒ±≈üma ƒ∞√ßeriƒüi</button>
            <button class="active" onclick="openTab(event,'sekme3')">√áalƒ±≈üma S√ºreci</button>
            <button onclick="openTab(event,'sekme4')">Deƒüerlendirme</button>
        </div>

        <div id="sekme1" class="tab-content">
            <div style="text-align: center;">
                <select id="sinifSec" style="width: 250px;">
                    <option value="">-- Sƒ±nƒ±f Se√ßin --</option>
                </select>
                <div class="button-group">
                    <button id="btnGrupla" class="action">Sƒ±nƒ±fƒ± Gruplara B√∂l</button>
                    <button id="btnSil" class="action red">Mevcut Gruplarƒ± Sil</button>
                </div>
            </div>
            <div id="tablo" class="grup-container"></div>
        </div>

        <div id="sekme2" class="tab-content">
            <div id="listeEkrani">
                <div class="button-group">
                    <button onclick="arsivModalAc()" class="action orange">üìÇ Ar≈üivden √áalƒ±≈üma Ekle</button>
                    <button id="btnYeni" class="action">Yeni √áalƒ±≈üma Ekle</button>
                    <button id="btnDuzenle" class="action blue">Se√ßileni D√ºzenle</button>
                    <button id="btnSilDosya" class="action red">Se√ßileni Sil</button>
                </div>
                <ul id="calismaListesi"></ul>
            </div>
            <div id="editorEkrani"
                style="display:none; border: 1px solid #d1c4e9; padding: 20px; border-radius: 10px; background: white; max-width: 800px; margin: 0 auto;">
                <h3 id="editorBaslik" style="color: #673AB7; text-align: center; margin-top:0;"></h3>
                <textarea id="calismaAciklama"
                    style="width: 95%; height: 80px; padding: 12px; border: 1px solid #d1c4e9; border-radius: 8px; display: block; margin: 10px auto;"
                    placeholder="Y√∂nergeleri buraya yazƒ±n..."></textarea>
                <div id="soruAlani"></div>
                <div class="button-group">
                    <button id="btnSoruEkle" class="action blue">+ Yeni Soru</button>
                    <button id="btnKaydet" class="action">üíæ Kaydet</button>
                    <button onclick="location.reload()" class="action red">ƒ∞ptal</button>
                </div>
            </div>
        </div>

        <div id="sekme3" class="tab-content active">
            <div class="atama-panel">
                <div>Sƒ±nƒ±f:<br><select id="s3SinifSec" style="width:140px;">
                        <option value="">-- Se√ßin --</option>
                    </select></div>
                <div>√áalƒ±≈üma:<br><select id="s3CalismaSec" style="width:140px;">
                        <option value="">-- Se√ßin --</option>
                    </select></div>
                <div>Y√∂ntem:<br><select id="s3YontemSec" style="width:110px;">
                        <option value="">-- Se√ßin --</option>
                        <option value="Grup">Grup</option>
                        <option value="Tek">Tek</option>
                    </select></div>
                <button id="btnS3Olustur" class="action blue" style="min-width:100px;">Olu≈ütur</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Sƒ±nƒ±f</th>
                        <th>√áalƒ±≈üma Adƒ±</th>
                        <th>Y√∂ntem</th>
                        <th>G√∂rme</th>
                        <th>Yapma</th>
                        <th>Deƒüerl.</th>
                        <th>S√ºre</th>
                        <th>Kalan</th>
                        <th>ƒ∞≈ülem</th>
                    </tr>
                </thead>
                <tbody id="atamaBody"></tbody>
            </table>
        </div>

        <div id="sekme4" class="tab-content">
            <div class="yonetim-cerceve" id="degSecimPaneli">
                <div class="yonetim-toolbar">
                    <button id="btnPuanTablosu" class="action orange"
                        style="font-size:12px; padding:6px 15px; display:none;">üìä PUAN TABLOSU</button>
                    <button id="btnTumCevaplariSifirla" class="action red"
                        style="font-size:12px; padding:6px 15px; display:none; margin-left:5px;">‚ö†Ô∏è CEVAPLARI
                        SIFIRLA</button>
                    <label class="chk-container"><input type="checkbox" id="chkDegerlendirmeIzin" disabled> √ñƒürenci
                        ƒ∞zni</label>
                    <label class="chk-container"><input type="checkbox" id="chkIzin" disabled> √ñƒüretmen ƒ∞zni</label>
                    <div><strong>√áalƒ±≈üma:</strong> <select id="s4DosyaSec" class="kucuk-select"></select></div>
                    <div><strong>Sƒ±nƒ±f:</strong> <select id="s4SinifSec" class="kucuk-select"></select></div>
                    <button id="btnDegerlendirmeBaslat" class="action blue"
                        style="font-size:12px; padding:6px 15px;">BA≈ûLAT</button>
                    <button id="btnDegerlendirmeSifirla" class="action red"
                        style="font-size:12px; padding:6px 15px; display:none;">Sƒ±nƒ±fƒ± Sƒ±fƒ±rla (Bitti Kaldƒ±r)</button>
                </div>
                <script>
                    document.getElementById('btnTumCevaplariSifirla').onclick = async function () {
                        const calisma = document.getElementById("s4DosyaSec").value;
                        if (!calisma) return alert("L√ºtfen √ßalƒ±≈üma se√ßin.");

                        const kod = prompt("T√úM √ñƒûRENCƒ∞ CEVAPLARINI Sƒ∞LMEK ƒ∞√áƒ∞N KOD Gƒ∞Rƒ∞N (1234):");
                        if (kod === "1234") {
                            if (confirm(`"${calisma}" √ßalƒ±≈ümasƒ±na ait T√úM √ñƒûRENCƒ∞ CEVAPLARI silinecek! Emin misiniz?`)) {
                                try {
                                    const res = await fetch("/tumCevaplariTemizle", {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify({ calismaIsmi: `www_${calisma}` })
                                    });
                                    const json = await res.json();
                                    if (json.status === "ok") {
                                        alert("T√ºm cevaplar ba≈üarƒ±yla silindi.");
                                        // Refresh to reflect changes (e.g. re-fetch data)
                                        document.getElementById("s4DosyaSec").onchange();
                                    } else {
                                        alert("Hata: " + json.message);
                                    }
                                } catch (e) {
                                    alert("ƒ∞≈ülem hatasƒ±: " + e);
                                }
                            }
                        } else if (kod !== null) {
                            alert("Hatalƒ± kod!");
                        }
                    };

                    document.getElementById('btnPuanTablosu').onclick = async function () {
                        const calisma = document.getElementById("s4DosyaSec").value;
                        if (!calisma) return alert("L√ºtfen √ßalƒ±≈üma se√ßin.");

                        try {
                            const [qwx, www] = await Promise.all([
                                fetch(`/calismaGetir?isim=qwx${calisma}`).then(r => r.json()),
                                fetch(`/calismaGetir?isim=www_${calisma}`).then(r => r.json())
                            ]);

                            const sorular = qwx.sorular || [];
                            const cevaplar = www.filter(x => x.ogrenciNo !== "AYARLAR");

                            // CSV ƒ∞√ßeriƒüi Hazƒ±rla (Excel i√ßin BOM ekle)
                            let csvContent = "\uFEFF"; // UTF-8 BOM

                            // Ba≈ülƒ±k Satƒ±rƒ±
                            csvContent += "Sƒ±nƒ±f;√ñƒürenci No;Ad Soyad;Toplam Puan";
                            sorular.forEach((s, i) => csvContent += `;Soru ${i + 1}`);
                            csvContent += "\n";

                            // Veri Satƒ±rlarƒ±
                            // Sƒ±nƒ±fa g√∂re sƒ±rala
                            cevaplar.sort((a, b) => (a.sinif || "").localeCompare(b.sinif || ""));

                            cevaplar.forEach(row => {
                                let toplamPuan = 0;
                                let soruPuanlari = [];

                                // Puan Hesapla
                                const puanObj = row.puanlar || {};

                                sorular.forEach((_, sIdx) => {
                                    const pArr = puanObj[sIdx];
                                    let sPuan = 0;
                                    if (Array.isArray(pArr)) {
                                        sPuan = pArr.reduce((a, b) => a + (Number(b) || 0), 0);
                                    }
                                    soruPuanlari.push(sPuan);
                                    toplamPuan += sPuan;
                                });

                                // √ñzel durum: Eƒüer deƒüerlendirme "G" ise toplam puan "G" olsun
                                if (row.degerlendirme && row.degerlendirme.toplam === "G") toplamPuan = "G";

                                csvContent += `${row.sinif || ""};${row.ogrenciNo};${row.adSoyad || ""};${toplamPuan}`;
                                soruPuanlari.forEach(p => csvContent += `;${p}`);
                                csvContent += "\n";
                            });

                            // ƒ∞ndirme
                            const bloom = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                            const link = document.createElement("a");
                            const url = URL.createObjectURL(bloom);
                            link.setAttribute("href", url);
                            link.setAttribute("download", `Puan_Tablosu_${calisma}.csv`);
                            link.style.visibility = 'hidden';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);

                        } catch (e) {
                            console.error(e);
                            alert("Puan tablosu olu≈üturulurken hata: " + e);
                        }
                    };
                </script>
            </div>
            <div id="degerlendirmeContainer">
                <div class="deg-header">
                    <div class="deg-header-left" id="degOgrenciBaslik">--</div>
                    <div class="deg-header-center" id="degBilgiUst">--</div>
                    <div class="deg-header-right">PUAN: <span id="degPuanGosterge">0</span></div>
                </div>
                <div class="deg-card">
                    <div id="degNormalPanel" style="display:flex; width:100%; height:100%;">
                        <div class="deg-soru-bolumu"><span id="degSoruNo" style="font-weight:bold;">1</span>. Soru<div
                                id="degSoruMetin" style="font-weight:600;"></div>
                        </div>
                        <div class="deg-cevap-bolumu">
                            <div id="degCevapListesi"></div>
                        </div>
                    </div>
                </div>
                <div class="deg-controls">
                    <button class="action red" onclick="DegerlendirmeApp.nav(-1)" style="background:#9e9e9e">‚ùÆ
                        Geri</button>
                    <button class="action blue" id="btnDegIleri" onclick="DegerlendirmeApp.nav(1)">ƒ∞leri ‚ùØ</button>
                    <button class="action red" id="btnDegBitir" style="display:none;"
                        onclick="DegerlendirmeApp.sonrakiKisi()">üíæ Kaydet / Sonraki</button>
                </div>
                <div style="text-align:right; margin-top:10px;"><button onclick="location.reload()" class="action red"
                        style="background:#9e9e9e">Kapat</button></div>
            </div>
        </div>
    </div>

    <div id="arsivModal" class="modal">
        <div class="modal-content">
            <div
                style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding-bottom:10px;">
                <h3 style="margin:0; color:#673AB7;">Ar≈üiv</h3><span
                    onclick="document.getElementById('arsivModal').style.display='none'"
                    style="cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <ul id="arsivDosyaListesi" style="list-style:none; padding:0; max-height:300px; overflow-y:auto;"></ul>
        </div>
    </div>

    <div id="bitmisUyariModal" class="modal" style="z-index: 2000;">
        <div class="modal-content">
            <h3 style="color:#f44336;">‚ö†Ô∏è Deƒüerlendirme Tamamlanmƒ±≈ü</h3>
            <p>Bu sƒ±nƒ±f i√ßin bu √ßalƒ±≈üma daha √∂nce tamamlanmƒ±≈ü (Bitti) olarak g√∂r√ºn√ºyor.</p>
            <p>Puanlarƒ± sƒ±fƒ±rlayƒ±p (cevaplarƒ± koruyarak) tekrar deƒüerlendirmek ister misiniz?</p>
            <div style="margin-top:20px; display:flex; justify-content:center; gap:10px;">
                <button class="action red" onclick="DegerlendirmeApp.modalSifirla()">Evet, Puanlarƒ± Sƒ±fƒ±rla</button>
                <button class="action" onclick="location.reload()" style="background:#999;">ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <script>
        let globalData, secilenSinif, seciliDosyaAdi = "", aktifAtamalar = [];

        function linkleriDonustur(text) {
            if (!text) return "";
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, function (url) {
                const cleanUrl = url.trim();
                const urlNoParams = cleanUrl.split('?')[0];
                const ext = urlNoParams.split('.').pop().toLowerCase();

                if (cleanUrl.includes('drive.google.com') || cleanUrl.includes('docs.google.com')) {
                    let id = null;
                    const parts = cleanUrl.split(/\/d\//);
                    if (parts.length > 1) { id = parts[1].split('/')[0]; }
                    else { const match = cleanUrl.match(/[?&]id=([a-zA-Z0-9_-]+)/); if (match) id = match[1]; }

                    if (id) {
                        let embedUrl = `https://drive.google.com/file/d/${id}/preview`;
                        if (cleanUrl.includes('/document/')) embedUrl = `https://docs.google.com/document/d/${id}/preview`;
                        else if (cleanUrl.includes('/spreadsheets/')) embedUrl = `https://docs.google.com/spreadsheets/d/${id}/preview`;
                        else if (cleanUrl.includes('/presentation/')) embedUrl = `https://docs.google.com/presentation/d/${id}/preview`;
                        return `<div class="embedded-wrapper"><iframe src="${embedUrl}" class="embedded-iframe" allow="autoplay"></iframe><div class="embed-fallback"><a href="${cleanUrl}" target="_blank">üìÑ Dosyayƒ± Yeni Sekmede A√ß</a></div></div>`;
                    }
                }
                if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) { return `<img src="${cleanUrl}" class="embedded-img" onclick="this.classList.toggle('fullscreen')" title="B√ºy√ºtmek i√ßin tƒ±kla">`; }
                if (['mp3', 'wav', 'ogg'].includes(ext)) { return `<div class="embedded-wrapper"><audio controls src="${cleanUrl}" class="embedded-audio"></audio></div>`; }
                if (['mp4', 'webm', 'mov'].includes(ext)) { return `<div class="embedded-wrapper"><video controls src="${cleanUrl}" class="embedded-video"></video></div>`; }
                if (cleanUrl.includes('youtube.com') || cleanUrl.includes('youtu.be')) {
                    let embedUrl = cleanUrl;
                    if (cleanUrl.includes('watch?v=')) embedUrl = cleanUrl.replace('watch?v=', 'embed/');
                    else if (cleanUrl.includes('youtu.be/')) embedUrl = cleanUrl.replace('youtu.be/', 'youtube.com/embed/');
                    if (embedUrl.includes('&')) embedUrl = embedUrl.split('&')[0];
                    return `<div class="embedded-wrapper"><iframe src="${embedUrl}" class="embedded-iframe" allowfullscreen></iframe></div>`;
                }
                return `<div class="embedded-wrapper"><iframe src="${cleanUrl}" class="embedded-iframe" loading="lazy"></iframe><div class="embed-fallback"><a href="${cleanUrl}" target="_blank">üåê Baƒülantƒ±yƒ± Yeni Sekmede A√ß</a></div></div>`;
            });
        }

        window.onload = () => {
            veritabaniniYukle().then(() => {
                s3DropdownYukle();
                s3AtamalariCek();
                s4DosyaListesiYukle();
                const sonSekme = sessionStorage.getItem('aktifSekme');
                if (sonSekme) { openTab(null, sonSekme); }
            });
        };

        function openTab(evt, tabId) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if (evt) { evt.currentTarget.classList.add('active'); }
            else {
                const buttons = document.querySelectorAll('.tab-buttons button');
                buttons.forEach(btn => { if (btn.getAttribute('onclick').includes(tabId)) btn.classList.add('active'); });
            }
            sessionStorage.setItem('aktifSekme', tabId);
            if (tabId === 'sekme3') { s3DropdownYukle(); s3AtamalariCek(); }
            if (tabId === 'sekme2') listeyiYukle();
            if (tabId === 'sekme4') s4DosyaListesiYukle();
        }

        async function veritabaniniYukle() {
            const res = await fetch("veritabani.json");
            const data = await res.json();
            globalData = Object.values(data)[0].map(ogrenci => {
                if (ogrenci["Adƒ±nƒ±z Soyadƒ±nƒ±z"]) ogrenci["Adƒ±nƒ±z Soyadƒ±nƒ±z"] = ogrenci["Adƒ±nƒ±z Soyadƒ±nƒ±z"].toLocaleUpperCase("tr-TR");
                return ogrenci;
            });
            const siniflar = [...new Set(globalData.map(k => k["Sƒ±nƒ±fƒ±nƒ±z"]))];
            siniflar.forEach(s => {
                document.getElementById("sinifSec").appendChild(new Option(s, s));
                document.getElementById("s3SinifSec").appendChild(new Option(s, s));
            });
        }

        function listeyiYukle() {
            fetch("/listeCalismalar").then(res => res.json()).then(dosyalar => {
                const liste = document.getElementById("calismaListesi"); liste.innerHTML = "";
                dosyalar.filter(d => d.startsWith("qwx")).forEach(d => {
                    const li = document.createElement("li");
                    li.innerHTML = `<span>${d.replace("qwx", "").replace(".json", "")}</span><button onclick="calismaArsivle('${d}')" class="btn-archive-small">Ar≈üivle</button>`;
                    li.onclick = () => { document.querySelectorAll("#calismaListesi li").forEach(x => x.classList.remove("selected")); li.classList.add("selected"); seciliDosyaAdi = d; };
                    liste.appendChild(li);
                });
            });
        }
        function calismaArsivle(tamDosyaAdi) {
            if (!confirm("Ar≈üivlenecek?")) return;
            fetch("/arsivle", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dosyaIsmi: tamDosyaAdi.replace(".json", "") }) })
                .then(res => res.json()).then(data => { if (data.status === "ok") listeyiYukle(); });
        }
        function arsivModalAc() {
            document.getElementById("arsivModal").style.display = "block";
            const liste = document.getElementById("arsivDosyaListesi");
            fetch("/arsivListesi").then(res => res.json()).then(dosyalar => {
                liste.innerHTML = "";
                dosyalar.forEach(d => {
                    const li = document.createElement("li"); li.style.padding = "10px"; li.style.borderBottom = "1px solid #eee"; li.style.display = "flex"; li.style.justifyContent = "space-between";
                    li.innerHTML = `<span>${d.replace(".json", "").replace("qwx", "")}</span> <button class="action blue" onclick="arsivdenGeriYukle('${d}')">Geri Y√ºkle</button>`;
                    liste.appendChild(li);
                });
            });
        }
        function arsivdenGeriYukle(dosyaAdi) {
            if (!confirm("Geri y√ºklensin mi?")) return;
            fetch("/arsivdenGeriYukle", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dosyaIsmi: dosyaAdi }) })
                .then(res => res.json()).then(data => { if (data.status === "ok") { document.getElementById("arsivModal").style.display = "none"; listeyiYukle(); } });
        }

        function soruEkle(val = "") {
            const div = document.createElement("div"); div.className = "soru-item";
            div.innerHTML = `<span class="soru-no"></span><input type="text" style="flex:1; padding:10px;" value="${val}"><button onclick="this.parentElement.remove(); yenileSoruNumaralari();" class="action red" style="min-width:40px; padding:5px;">X</button>`;
            document.getElementById("soruAlani").appendChild(div); yenileSoruNumaralari();
        }
        function yenileSoruNumaralari() {
            document.querySelectorAll("#soruAlani .soru-item").forEach((item, index) => { item.querySelector(".soru-no").textContent = (index + 1) + ". Soru:"; });
        }

        document.getElementById("btnSoruEkle").onclick = () => soruEkle();

        document.getElementById("btnYeni").onclick = () => {
            let isim = prompt("Ad?"); if (isim) { seciliDosyaAdi = "qwx" + isim; document.getElementById("listeEkrani").style.display = "none"; document.getElementById("editorEkrani").style.display = "block"; document.getElementById("editorBaslik").textContent = isim.toUpperCase(); document.getElementById("calismaAciklama").value = ""; document.getElementById("soruAlani").innerHTML = ""; soruEkle(); }
        };
        document.getElementById("btnDuzenle").onclick = () => {
            if (!seciliDosyaAdi) return alert("Se√ßin!");
            fetch(`/calismaGetir?isim=${encodeURIComponent(seciliDosyaAdi.replace(".json", ""))}`).then(r => r.json()).then(data => {
                document.getElementById("listeEkrani").style.display = "none"; document.getElementById("editorEkrani").style.display = "block";
                document.getElementById("editorBaslik").textContent = seciliDosyaAdi.replace("qwx", "").replace(".json", "").toUpperCase();
                document.getElementById("soruAlani").innerHTML = "";
                let sorular = Array.isArray(data) ? data : (data.sorular || []);
                document.getElementById("calismaAciklama").value = data.aciklama || "";
                sorular.forEach(s => soruEkle(s));
            });
        };
        document.getElementById("btnKaydet").onclick = () => {
            const v = { aciklama: document.getElementById("calismaAciklama").value, sorular: Array.from(document.querySelectorAll("#soruAlani input")).map(i => i.value).filter(x => x.trim()) };
            fetch("/calismaKaydet", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ calismaIsmi: seciliDosyaAdi.replace(".json", ""), sorular: v }) }).then(() => location.reload());
        };
        document.getElementById("btnSilDosya").onclick = () => { if (seciliDosyaAdi && confirm("Sil?")) fetch("/calismaSil", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ calismaIsmi: seciliDosyaAdi.replace(".json", "") }) }).then(() => listeyiYukle()); };

        document.getElementById("sinifSec").onchange = function () {
            secilenSinif = this.value;
            if (secilenSinif) fetch(secilenSinif + "Gruplarƒ±.json").then(r => r.json()).then(g => gruplariGoster(g)).catch(() => document.getElementById("tablo").innerHTML = "");
        };
        function gruplariGoster(gruplar) {
            const container = document.getElementById("tablo"); container.innerHTML = "";
            gruplar.forEach((grup, idx) => {
                const div = document.createElement("div"); div.className = "grup";
                div.innerHTML = `<h3>Grup ${idx + 1}</h3>`;
                const table = document.createElement("table");
                const keys = Object.keys(grup[0]).slice(2, 4);
                table.innerHTML = `<thead><tr>${keys.map(k => `<th>${k}</th>`).join("")}</tr></thead><tbody>${grup.map(r => `<tr>${keys.map(k => `<td>${r[k] || ""}</td>`).join("")}</tr>`).join("")}</tbody>`;
                div.appendChild(table); container.appendChild(div);
            });
        }

        document.getElementById("btnGrupla").onclick = () => {
            if (!secilenSinif) return alert("Sƒ±nƒ±f se√ßin!");
            const n = prompt("Grup sayƒ±sƒ±?"); if (!n) return;

            const ogrenciler = globalData.filter(k => k["Sƒ±nƒ±fƒ±nƒ±z"] === secilenSinif);
            ogrenciler.sort((a, b) => parseInt(a["Okul Numaranƒ±z"]) - parseInt(b["Okul Numaranƒ±z"]));

            const gruplar = [];
            const perGroup = Math.ceil(ogrenciler.length / n);

            for (let i = 0; i < n; i++) {
                const start = i * perGroup;
                const end = start + perGroup;
                const dilim = ogrenciler.slice(start, end);
                if (dilim.length) gruplar.push(dilim);
            }

            gruplariGoster(gruplar);

            fetch("/kaydet", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sinif: secilenSinif, gruplar })
            }).then(() => alert("Gruplar olu≈üturuldu ve otomatik kaydedildi!"));
        };

        document.getElementById("btnSil").onclick = () => { if (secilenSinif && confirm("Sil?")) fetch("/calismaSil", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ calismaIsmi: secilenSinif + "Gruplarƒ±" }) }).then(() => document.getElementById("tablo").innerHTML = ""); };

        function s3DropdownYukle() {
            const cS = document.getElementById("s3CalismaSec");
            fetch("/listeCalismalar").then(r => r.json()).then(dosyalar => {
                cS.innerHTML = '<option value="">-- Se√ßin --</option>';
                dosyalar.filter(d => d.startsWith("qwx")).forEach(d => { const n = d.replace("qwx", "").replace(".json", ""); cS.appendChild(new Option(n.replace("qwx", ""), n)); });
            });
        }
        function s3AtamalariCek() {
            fetch("/listeCalismalar").then(res => res.json()).then(dosyalar => {
                const qFiles = dosyalar.filter(d => d.startsWith("qqq"));
                aktifAtamalar = []; let count = 0; if (qFiles.length === 0) return s3TabloCiz();
                qFiles.forEach(f => {
                    fetch(`/calismaGetir?isim=${encodeURIComponent(f.replace(".json", ""))}`).then(r => r.json()).then(data => { aktifAtamalar.push(data); count++; if (count === qFiles.length) s3TabloCiz(); })
                        .catch(() => { count++; if (count === qFiles.length) s3TabloCiz(); });
                });
            });
        }
        document.getElementById("btnS3Olustur").onclick = () => {
            const sn = document.getElementById("s3SinifSec").value, cl = document.getElementById("s3CalismaSec").value, yn = document.getElementById("s3YontemSec").value;
            if (!sn || !cl || !yn) return alert("Eksik se√ßim!");
            const dId = "qqq" + sn.replace(/\s/g, '') + cl.replace("qwx", "");
            // Initializing new permissions
            const obj = { id: dId, sinif: sn, calisma: cl.replace("qwx", ""), yontem: yn, gorme: false, aciklamaIzni: false, soruIzni: false, yapma: false, degerl: false, sure: 0, bitis: null };
            fetch("/calismaKaydet", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ calismaIsmi: dId, sorular: obj }) }).then(() => setTimeout(s3AtamalariCek, 300));
        };
        function s3TabloCiz() {
            const b = document.getElementById("atamaBody"); b.innerHTML = "";
            aktifAtamalar.sort((a, b) => a.id.localeCompare(b.id)).forEach(a => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${a.sinif}</td><td>${a.calisma}</td><td><b>${a.yontem}</b></td>
                <td style="font-size:0.9em;">
                    <label><input type="checkbox" ${a.aciklamaIzni ? 'checked' : ''} onchange="s3Upd('${a.id}','aciklamaIzni',this.checked)"> A√ßƒ±klama</label><br>
                    <label><input type="checkbox" ${a.soruIzni ? 'checked' : ''} onchange="s3Upd('${a.id}','soruIzni',this.checked)"> Sorular</label>
                </td>
                <td><input type="checkbox" id="chk_${a.id}" ${a.yapma ? 'checked' : ''} onchange="s3Upd('${a.id}','yapma',this.checked)"></td>
                <td><input type="checkbox" ${a.degerl ? 'checked' : ''} onchange="s3Upd('${a.id}','degerl',this.checked)"></td>
                <td><input type="number" id="inp_${a.id}" value="${a.sure || 0}" style="width:40px"><button onclick="s3Start('${a.id}')" class="action blue" style="min-width:auto; padding:5px;">OK</button></td>
                <td><span class="timer-text" id="t_${a.id}">--:--</span></td>
                <td><button onclick="s3Del('${a.id}')" class="action red" style="min-width:auto; padding:5px;">Sil</button></td>`;
                b.appendChild(tr);
            });
        }
        function s3Upd(id, k, v) { const a = aktifAtamalar.find(x => x.id === id); if (a) { a[k] = v; fetch("/calismaKaydet", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ calismaIsmi: id, sorular: a }) }); } }
        function s3Start(id) {
            const a = aktifAtamalar.find(x => x.id === id); const s = parseInt(document.getElementById("inp_" + id).value) || 0;
            if (a && s > 0) { a.sure = s; a.yapma = true; a.bitis = Date.now() + (s * 60 * 1000); s3Upd(id, 'bitis', a.bitis); s3Upd(id, 'yapma', true); s3TabloCiz(); }
        }
        function s3Del(id) { if (confirm("Sil?")) fetch("/calismaSil", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ calismaIsmi: id }) }).then(() => s3AtamalariCek()); }

        setInterval(() => {
            aktifAtamalar.forEach(a => {
                const el = document.getElementById("t_" + a.id); if (!el || !a.bitis) return;
                const diff = a.bitis - Date.now();
                if (diff > 0) { el.textContent = `${Math.floor(diff / 60000).toString().padStart(2, '0')}:${Math.floor((diff % 60000) / 1000).toString().padStart(2, '0')}`; }
                else { el.textContent = "Bƒ∞TTƒ∞"; if (a.yapma) { a.yapma = false; s3Upd(a.id, 'yapma', false); } }
            });
        }, 1000);

        function s4DosyaListesiYukle() {
            fetch("/listeCalismalar").then(r => r.json()).then(dosyalar => {
                const sel = document.getElementById("s4DosyaSec"); sel.innerHTML = '<option value="">-- Se√ß --</option>';
                dosyalar.filter(d => d.startsWith("qwx")).forEach(d => { const n = d.replace("qwx", "").replace(".json", ""); sel.appendChild(new Option(n, n)); });
            });
        }

        document.getElementById("s4DosyaSec").onchange = async function () {
            const calisma = this.value;
            const sinifSel = document.getElementById("s4SinifSec");
            document.getElementById("btnDegerlendirmeSifirla").style.display = "none";
            const chkOgr = document.getElementById("chkDegerlendirmeIzin");
            const chkOgrt = document.getElementById("chkIzin");

            sinifSel.innerHTML = '<option value="">...</option>';
            const btnPuan = document.getElementById('btnPuanTablosu');
            const btnSifirla = document.getElementById('btnTumCevaplariSifirla');

            if (!calisma) {
                chkOgr.disabled = true; chkOgrt.disabled = true;
                btnPuan.style.display = 'none';
                btnSifirla.style.display = 'none';
                return;
            }

            btnPuan.style.display = 'inline-block';
            btnSifirla.style.display = 'inline-block';

            chkOgr.disabled = false; chkOgrt.disabled = false;

            try {
                const [dosyalar, rW] = await Promise.all([
                    (await fetch("/listeCalismalar")).json(),
                    fetch(`/calismaGetir?isim=www_${calisma}`).catch(() => null)
                ]);

                let wwwData = [];
                if (rW && rW.ok) wwwData = await rW.json();

                const ayar = wwwData.find(x => x.ogrenciNo === "AYARLAR");
                chkOgr.checked = ayar ? ayar.degerlendirmeIzni : false;
                chkOgrt.checked = ayar ? ayar.izin : false;

                const atananlar = dosyalar.filter(f => f.startsWith("qqq") && f.replace(".json", "").endsWith(calisma));

                sinifSel.innerHTML = '<option value="">-- Se√ß --</option>';

                for (let f of atananlar) {
                    const data = await (await fetch(`/calismaGetir?isim=${f.replace(".json", "")}`)).json();
                    if (data.sinif) {
                        const buSinifinTumCevaplari = wwwData.filter(r => r.sinif === data.sinif);
                        const buSinifinBitmisCevaplari = buSinifinTumCevaplari.filter(r => r.degerlendirme && r.degerlendirme.bitti);

                        let hepsiBittiMi = (buSinifinTumCevaplari.length > 0 && buSinifinBitmisCevaplari.length === buSinifinTumCevaplari.length);

                        sinifSel.appendChild(new Option(data.sinif + (hepsiBittiMi ? " (Bitti)" : ""), data.sinif));
                    }
                }
            } catch (e) { console.error("Hata:", e); }
        };

        document.getElementById("s4SinifSec").onchange = function () {
            const btn = document.getElementById("btnDegerlendirmeSifirla");
            if (this.selectedIndex >= 0) {
                const text = this.options[this.selectedIndex].text;
                if (text.includes("(Bitti)")) {
                    btn.style.display = "inline-block";
                } else {
                    btn.style.display = "none";
                }
            } else {
                btn.style.display = "none";
            }
        };

        document.getElementById("btnDegerlendirmeSifirla").onclick = function () {
            DegerlendirmeApp.modalSifirla();
        };

        document.getElementById("chkDegerlendirmeIzin").onchange = function () {
            if (this.checked) document.getElementById("chkIzin").checked = false;
            izinKaydet();
        };
        document.getElementById("chkIzin").onchange = function () {
            if (this.checked) document.getElementById("chkDegerlendirmeIzin").checked = false;
            izinKaydet();
        };

        function izinKaydet() {
            const val = document.getElementById("s4DosyaSec").value; if (!val) return;
            const ayar = { ogrenciNo: "AYARLAR", sinif: "SISTEM", degerlendirmeIzni: document.getElementById("chkDegerlendirmeIzin").checked, izin: document.getElementById("chkIzin").checked, tarih: new Date().toLocaleString() };
            fetch("/kaydet", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dosyaAdi: "www_" + val, veri: ayar }) });
        }

        document.getElementById("btnDegerlendirmeBaslat").onclick = () => {
            DegerlendirmeApp.baslat();
        };

        const DegerlendirmeApp = {
            kuyruk: [], kuyrukIndex: 0, activeVeri: null, sorular: [], sIdx: 0, anlikPuanlar: {}, seciliSinif: "", seciliCalisma: "",
            baslat: async function () {
                this.seciliCalisma = document.getElementById("s4DosyaSec").value;
                this.seciliSinif = document.getElementById("s4SinifSec").value.replace(" (Bitti)", "");
                if (!this.seciliCalisma || !this.seciliSinif) return alert("Se√ßim yapƒ±n.");
                try {
                    const rW = await fetch(`/calismaGetir?isim=www_${this.seciliCalisma}`);
                    if (!rW.ok) throw new Error("Dosya Yok");
                    const tumCevaplar = await rW.json();
                    const sinifKaydiVarMi = tumCevaplar.some(x => x.sinif === this.seciliSinif);
                    if (!sinifKaydiVarMi) throw new Error("Sƒ±nƒ±f Kaydƒ± Yok");
                } catch (e) { alert("≈ûu an bu √áalƒ±≈ümayƒ± Deƒüerlendiremezsiniz (Kayƒ±t yok)."); return; }

                const qName = "qqq" + this.seciliSinif.replace(/\s/g, '') + this.seciliCalisma;
                const dQ = await (await fetch(`/calismaGetir?isim=${qName}`)).json();
                document.getElementById("degSecimPaneli").style.display = "none"; document.getElementById("degerlendirmeContainer").style.display = "block";
                document.getElementById("degBilgiUst").textContent = this.seciliCalisma;
                this.sorular = (await (await fetch(`/calismaGetir?isim=qwx${this.seciliCalisma}`)).json()).sorular || [];
                const cevaplarVerisi = await (await fetch(`/calismaGetir?isim=www_${this.seciliCalisma}`)).json();
                this.kuyruk = [];

                if (dQ.yontem === "Grup") {
                    const gruplar = await (await fetch(`/grupListesiGetir?sinif=${this.seciliSinif}`)).json();
                    gruplar.forEach((grp, idx) => {
                        const kayit = cevaplarVerisi.find(tv => grp.some(u => String(tv.ogrenciNo) === String(u["Okul Numaranƒ±z"])));
                        if (kayit && kayit.degerlendirme && kayit.degerlendirme.bitti) return;

                        // Cevap olmasa bile listeye ekle (Sƒ±fƒ±rlandƒ±ktan sonra eri≈üim i√ßin)
                        const safeKayit = kayit || { ogrenciNo: grp[0]["Okul Numaranƒ±z"], cevaplar: [], puanlar: {} };
                        this.kuyruk.push({ baslik: `${this.seciliSinif} - ${idx + 1}. GRUP`, kayit: safeKayit, katilmadi: false, members: grp.map(u => String(u["Okul Numaranƒ±z"])) });
                    });
                } else {
                    globalData.filter(u => u["Sƒ±nƒ±fƒ±nƒ±z"] === this.seciliSinif).forEach(ogr => {
                        const no = String(ogr["Okul Numaranƒ±z"]);
                        const kayit = cevaplarVerisi.find(x => String(x.ogrenciNo) === no);
                        if (kayit && kayit.degerlendirme && kayit.degerlendirme.bitti) return;

                        // Robustly handle kayit structure
                        let safeKayit = { ogrenciNo: no, cevaplar: [], puanlar: {} };

                        if (kayit) {
                            let cevaplarListesi = [];
                            if (Array.isArray(kayit)) {
                                cevaplarListesi = kayit;
                            } else if (Array.isArray(kayit.cevaplar)) {
                                cevaplarListesi = kayit.cevaplar;
                            } else if (kayit.answers && Array.isArray(kayit.answers)) { // Handle raw SQL fallback if any
                                cevaplarListesi = kayit.answers;
                            }

                            safeKayit = {
                                ogrenciNo: no,
                                cevaplar: cevaplarListesi,
                                puanlar: kayit.puanlar || {},
                                degerlendirme: kayit.degerlendirme
                            };
                        }

                        this.kuyruk.push({ baslik: `${no} - ${ogr["Adƒ±nƒ±z Soyadƒ±nƒ±z"]}`, kayit: safeKayit, katilmadi: false, members: [no] });
                    });
                }
                this.kuyrukIndex = 0;

                if (this.kuyruk.length === 0) {
                    document.getElementById('degerlendirmeContainer').style.display = 'none';
                    document.getElementById('bitmisUyariModal').style.display = 'block';
                    return;
                }
                this.yukle();
            },
            modalSifirla: async function () {
                // YENƒ∞LENEN SIFIRLAMA MANTIƒûI: Verileri √ßek, puanƒ± temizle, geri y√ºkle.
                const calisma = document.getElementById("s4DosyaSec").value;
                const sinif = document.getElementById("s4SinifSec").value.replace(" (Bitti)", "");

                try {
                    // 1. Mevcut cevaplarƒ± √ßek
                    const res = await fetch(`/calismaGetir?isim=www_${calisma}`);
                    const data = await res.json();

                    const promises = [];
                    // 2. ƒ∞lgili sƒ±nƒ±fƒ±n kayƒ±tlarƒ±nƒ± bul ve g√ºncelle
                    data.forEach(student => {
                        if (student.sinif === sinif) {
                            student.puanlar = {}; // Puanlarƒ± sil
                            if (student.degerlendirme) student.degerlendirme.bitti = false; // Bitti i≈üaretini kaldƒ±r

                            // 3. G√ºncellenmi≈ü veriyi sunucuya geri y√ºkle (Cevaplar korunur)
                            promises.push(fetch("/kaydet", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    dosyaAdi: "www_" + calisma,
                                    veri: student
                                })
                            }));
                        }
                    });

                    await Promise.all(promises);
                    alert("Puanlar sƒ±fƒ±rlandƒ±, cevaplar korundu! Tekrar deƒüerlendirebilirsiniz.");
                    location.reload();
                } catch (e) {
                    alert("Sƒ±fƒ±rlama sƒ±rasƒ±nda hata olu≈ütu: " + e);
                }
            },
            yukle: async function () {
                if (this.kuyrukIndex >= this.kuyruk.length) { alert("Bitti!"); location.reload(); return; }
                const item = this.kuyruk[this.kuyrukIndex];

                // --- OTOMATƒ∞K "G" (Gƒ∞RMEDƒ∞/KATILMADI) ƒ∞≈ûLEME ---
                // Eƒüer cevap yoksa (katilmadi) veya bo≈ü cevap dizisi varsa
                const cevapYok = !item.kayit || !item.kayit.cevaplar || item.kayit.cevaplar.length === 0;

                if (cevapYok) {
                    // Otomatik olarak G olarak i≈üaretle ve ge√ß
                    // Kullanƒ±cƒ±ya hissettirmeden arkada kaydet
                    const promises = [];
                    item.members.forEach(ogrNo => {
                        // Puanlarƒ± "G" olarak kaydet (tek bir G yeterli genel durum i√ßin ama biz puanlar objesine de i≈üleyelim)
                        // Not: Puanlama yapƒ±sƒ± soru bazlƒ± olduƒüu i√ßin, 'G' genel bir durumdur.
                        // Ancak veritabanƒ± yapƒ±mƒ±zda 'scores' jsonb tutuluyor.
                        // Biz burada 'degerlendirme' alanƒ±na not d√º≈üelim ve puanlarƒ± bo≈ü bƒ±rakalƒ±m ya da √∂zel bir kodla i≈üaretleyelim.
                        // ƒ∞stenen: "G" olarak girilsin.

                        // 1. Deƒüerlendirme bitir (Puan: 0, Durum: G)
                        promises.push(fetch("/degerlendirmeBitir", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                dosyaAdi: `www_${this.seciliCalisma}`,
                                ogrenciNo: ogrNo,
                                sinif: this.seciliSinif,
                                puan: "G" // Server bunu 'evaluation' i√ßine 'toplam: "G"' olarak kaydedecek ≈üekilde g√ºncellenmeli veya server zaten toplam'ƒ± alƒ±yor mu?
                                // Server.js /degerlendirmeBitir endpoint'i: const { toplam } = req.body; ... evaluation = { toplam: toplam, bitti: true }
                                // Evet, server direk ne g√∂nderirsek onu kaydediyor.
                            })
                        }));
                    });

                    await Promise.all(promises);

                    // Sonraki ki≈üiye ge√ß
                    this.kuyrukIndex++;
                    this.yukle();
                    return;
                }

                document.getElementById("degOgrenciBaslik").textContent = item.baslik;
                this.anlikPuanlar = (item.kayit && item.kayit.puanlar) ? item.kayit.puanlar : {};
                document.getElementById("degNormalPanel").style.display = "flex";
                this.activeVeri = item.kayit;
                this.sIdx = 0;
                this.soruKontrolEtVeRender(1);
            },
            soruKontrolEtVeRender: function (direction) {
                if (this.sIdx >= this.sorular.length) { this.sonrakiKisi(); return; }
                if (this.sIdx < 0) { this.sIdx = 0; }
                this.renderSoru();
            },
            renderSoru: function () {
                document.getElementById("degSoruNo").textContent = this.sIdx + 1;
                document.getElementById("degSoruMetin").innerHTML = linkleriDonustur(this.sorular[this.sIdx]);

                const cevapObj = (this.activeVeri.cevaplar || []).find(c => c.soruIndex === this.sIdx);

                // Robust handling for answers structure in frontend
                let cevaplar = [];
                if (cevapObj) {
                    if (Array.isArray(cevapObj)) {
                        cevaplar = cevapObj;
                    } else if (cevapObj.cevaplar && Array.isArray(cevapObj.cevaplar)) {
                        cevaplar = cevapObj.cevaplar;
                    } else if (Array.isArray(cevapObj.cevaplar)) {
                        // Fallback, should be covered above but explicitly checking property
                        cevaplar = cevapObj.cevaplar;
                    }
                }

                const puanlar = this.anlikPuanlar[this.sIdx] || [];
                let h = "";

                if (cevaplar.length === 0) {
                    h = "<div style='padding:20px; color:#999; font-style:italic;'>Bu soruya cevap verilmemi≈ü.</div>";
                } else {
                    cevaplar.forEach((txt, i) => {
                        if (txt && txt.trim() !== "") {
                            const convertedTxt = linkleriDonustur(txt);
                            h += `<div class="deg-cevap-item" ondblclick="DegerlendirmeApp.hizliGecBos(event, '${txt || ''}')">
                                <div class="deg-cevap-metin">${convertedTxt}</div>
                                <div class="deg-buton-grubu">
                                    <button class="deg-btn-puan deg-dogru ${puanlar[i] === 1 ? 'aktif' : ''}" onclick="event.stopPropagation(); DegerlendirmeApp.puanla(${i},1)" ondblclick="event.stopPropagation(); DegerlendirmeApp.hizliGec(${i},1)">D</button>
                                    <button class="deg-btn-puan deg-yanlis ${puanlar[i] === 0 ? 'aktif' : ''}" onclick="event.stopPropagation(); DegerlendirmeApp.puanla(${i},0)" ondblclick="event.stopPropagation(); DegerlendirmeApp.hizliGec(${i},0)">Y</button>
                                </div></div>`;
                        }
                    });
                }

                document.getElementById("degCevapListesi").innerHTML = h;
                const son = (this.sIdx === this.sorular.length - 1);
                document.getElementById("btnDegIleri").style.display = son ? "none" : "block"; document.getElementById("btnDegBitir").style.display = son ? "block" : "none";
                this.guncellePuan();
            },
            puanla: function (cIdx, p) { if (!this.anlikPuanlar[this.sIdx]) this.anlikPuanlar[this.sIdx] = []; this.anlikPuanlar[this.sIdx][cIdx] = p; this.renderSoru(); },
            hizliGec: function (cIdx, p) { this.puanla(cIdx, p); if (this.sIdx < this.sorular.length - 1) this.nav(1); },
            hizliGecBos: function (e, metin) { if (!metin || metin.trim() === "" || e.offsetX > (e.currentTarget.offsetWidth * 0.6)) { if (this.sIdx < this.sorular.length - 1) this.nav(1); } },
            guncellePuan: function () { let t = 0; Object.values(this.anlikPuanlar).forEach(arr => { if (Array.isArray(arr)) t += arr.reduce((a, b) => a + (b || 0), 0) }); document.getElementById("degPuanGosterge").textContent = t; },
            nav: function (n) { let nextIdx = this.sIdx + n; if (nextIdx < 0) return; this.sIdx = nextIdx; this.soruKontrolEtVeRender(n); },
            sonrakiKisi: async function () {
                const item = this.kuyruk[this.kuyrukIndex];
                if (!item.katilmadi) {
                    // Toplam Puanƒ± Hesapla
                    let toplamPuan = 0;
                    Object.values(this.anlikPuanlar).forEach(arr => {
                        if (Array.isArray(arr)) toplamPuan += arr.reduce((a, b) => a + (b || 0), 0)
                    });

                    const puanPromises = [];
                    for (const ogrNo of item.members) {
                        Object.keys(this.anlikPuanlar).forEach(sIx => {
                            const cevaplar = this.anlikPuanlar[sIx];
                            if (cevaplar) {
                                cevaplar.forEach((p, cIx) => {
                                    if (p !== undefined && p !== null) {
                                        puanPromises.push(fetch("/puanKaydet", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dosyaAdi: `www_${this.seciliCalisma}`, ogrenciNo: ogrNo, sinif: this.seciliSinif, soruIndex: parseInt(sIx), cevapIndex: cIx, puan: p }) }));
                                    }
                                });
                            }
                        });
                    }
                    await Promise.all(puanPromises);

                    const bitirPromises = [];
                    for (const ogrNo of item.members) {
                        // Toplam puanƒ± g√∂nder
                        bitirPromises.push(fetch("/degerlendirmeBitir", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ dosyaAdi: `www_${this.seciliCalisma}`, ogrenciNo: ogrNo, sinif: this.seciliSinif, toplam: toplamPuan }) }));
                    }
                    await Promise.all(bitirPromises);
                }
                this.kuyrukIndex++; this.yukle();
            }
        };
    </script>
</body>

</html>