<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Etkinlik YÃ¶netim Paneli</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* GENEL STÄ°LLER */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            font-size: 14px;
        }

        h1 {
            text-align: center;
            padding: 15px;
            background: #673AB7;
            color: white;
            margin: 0;
            font-size: 1.2rem;
        }

        .tab-container {
            display: flex;
            flex-direction: column;
        }

        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            background: #ede7f6;
            border-bottom: 1px solid #d1c4e9;
        }

        .tab-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: bold;
            color: #5e35b1;
            transition: 0.3s;
        }

        .tab-buttons button.active {
            background: #673AB7;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 15px;
        }

        .tab-content.active {
            display: block;
        }

        /* BUTONLAR */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }

        button.action {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        button.blue {
            background-color: #2196F3;
        }

        button.red {
            background-color: #f44336;
        }

        button.orange {
            background-color: #FF9800;
        }

        select,
        input[type="number"],
        input[type="text"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #d1c4e9;
            outline: none;
            background: white;
        }

        .grup-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 25px;
            justify-content: center;
        }

        .grup {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            background: white;
            width: 320px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .grup h3 {
            margin-top: 0;
            color: #673AB7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            text-align: center;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
        }

        th,
        td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f5f5f5;
            color: #333;
            text-align: center;
            font-weight: bold;
        }

        /* Liste ve DiÄŸer Stiller */
        #calismaListesi {
            list-style-type: none;
            padding: 0;
            margin-top: 15px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        #calismaListesi li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            border: 1px solid #e0e0e0;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            background: #fff;
        }

        #calismaListesi li.selected {
            background-color: #ede7f6;
            border: 2px solid #673AB7;
            color: #5e35b1;
            font-weight: bold;
        }

        .atama-panel {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #d1c4e9;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            justify-content: center;
        }
        
        /* Modal Stilleri */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.5); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>

<body>
    <h1>Etkinlik YÃ¶netim Paneli</h1>
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="active" onclick="openTab(event,'sekme1')">Ã‡alÄ±ÅŸma Åžekli (Gruplar)</button>
            <button onclick="openTab(event,'sekme2')">Ã‡alÄ±ÅŸma Ä°Ã§eriÄŸi</button>
            <button onclick="openTab(event,'sekme3')">Ã‡alÄ±ÅŸma SÃ¼reci</button>
            <button onclick="openTab(event,'sekme4')">DeÄŸerlendirme</button>
        </div>

        <div id="sekme1" class="tab-content active">
            <div style="text-align: center;">
                <select id="sinifSec" style="width: 250px;">
                    <option value="">-- SÄ±nÄ±f SeÃ§in --</option>
                </select>
                <div class="button-group">
                    <button id="btnGrupla" class="action" onclick="sinifiGrupla()">SÄ±nÄ±fÄ± Gruplara BÃ¶l</button>
                    <button id="btnSil" class="action red" onclick="gruplariSil()">Mevcut GruplarÄ± Sil</button>
                    <button id="btnKaydetGruplar" class="action blue" onclick="gruplariKaydet()">GruplarÄ± Kaydet</button>
                </div>
            </div>
            <div id="tablo" class="grup-container"></div>
        </div>

        <div id="sekme2" class="tab-content">
            <div id="listeEkrani">
                <div class="button-group">
                    <button onclick="arsivModalAc()" class="action orange">ðŸ“‚ ArÅŸivden Ã‡alÄ±ÅŸma Ekle</button>
                    <button id="btnYeni" class="action" onclick="yeniCalisma()">Yeni Ã‡alÄ±ÅŸma Ekle</button>
                    <button id="btnDuzenle" class="action blue" onclick="calismaDuzenle()">SeÃ§ileni DÃ¼zenle</button>
                    <button id="btnSilDosya" class="action red" onclick="calismaSil()">SeÃ§ileni Sil</button>
                </div>
                <ul id="calismaListesi"></ul>
            </div>
            <div id="editorEkrani" style="display:none; border: 1px solid #d1c4e9; padding: 20px; border-radius: 10px; background: white; max-width: 800px; margin: 0 auto;">
                <h3 id="editorBaslik" style="color: #673AB7; text-align: center; margin-top:0;"></h3>
                <label>Ã‡alÄ±ÅŸma AdÄ±:</label>
                <input type="text" id="calismaAdiInput" style="width: 100%; margin-bottom: 10px;">
                <textarea id="calismaAciklama" style="width: 95%; height: 60px; padding: 12px; border: 1px solid #d1c4e9; border-radius: 8px; display: block; margin: 10px auto;" placeholder="YÃ¶nergeleri buraya yazÄ±n..."></textarea>
                <div id="soruAlani"></div>
                <div class="button-group">
                    <button id="btnSoruEkle" class="action blue" onclick="soruEkleUI()">+ Yeni Soru</button>
                    <button id="btnKaydet" class="action" onclick="calismaKaydet()">ðŸ’¾ Kaydet</button>
                    <button onclick="editorKapat()" class="action red">Ä°ptal</button>
                </div>
            </div>
        </div>

        <div id="sekme3" class="tab-content">
            <div class="atama-panel">
                <div>SÄ±nÄ±f:<br><select id="s3SinifSec" style="width:140px;"><option value="">-- SeÃ§in --</option></select></div>
                <div>Ã‡alÄ±ÅŸma:<br><select id="s3CalismaSec" style="width:140px;"><option value="">-- SeÃ§in --</option></select></div>
                <div>YÃ¶ntem:<br><select id="s3YontemSec" style="width:110px;">
                        <option value="">-- SeÃ§in --</option>
                        <option value="Grup">Grup</option>
                        <option value="Tek">Tek</option>
                    </select></div>
                <button id="btnS3Olustur" class="action blue" onclick="atamaYap()">OluÅŸtur</button>
            </div>
            <div style="text-align: center; color: #666; font-style: italic;">Atanan Ã§alÄ±ÅŸmalar burada listelenir (Admin Paneli Ã¼zerinden yÃ¶netilebilir).</div>
            <ul id="atananListesi" style="list-style: none; padding: 0; max-width: 600px; margin: 20px auto;"></ul>
        </div>

        <div id="sekme4" class="tab-content">
            <div style="text-align:center;">
                 <h3>SonuÃ§larÄ± GÃ¶rÃ¼ntÃ¼le</h3>
                 <p>DetaylÄ± sonuÃ§lar iÃ§in "Admin" paneline veya ilgili sÄ±nÄ±fÄ±n sayfasÄ±na bakÄ±nÄ±z.</p>
            </div>
        </div>
    </div>

    <div id="arsivModal" class="modal">
        <div class="modal-content">
            <span onclick="document.getElementById('arsivModal').style.display='none'" style="float:right; cursor:pointer; font-size:20px;">&times;</span>
            <h3>ArÅŸivdeki Ã‡alÄ±ÅŸmalar</h3>
            <ul id="arsivListesiUl" style="list-style:none; padding:0;"></ul>
        </div>
    </div>

    <script>
        // GLOBAL DEÄžÄ°ÅžKENLER
        let veritabani = {};
        let mevcutGruplar = [];
        let seciliCalisma = null;

        // BAÅžLANGIÃ‡
        window.onload = async function() {
            await veritabaniYukle();
            await calismaListesiGetir();
        };

        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tabbuttons = document.getElementsByClassName("tab-buttons")[0].getElementsByTagName("button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.className += " active";
        }

        // --- VERÄ°TABANI VE GRUPLAMA Ä°ÅžLEMLERÄ° ---

        async function veritabaniYukle() {
            try {
                const res = await fetch('/veritabani.json');
                const hamVeri = await res.json();
                
                // DÃœZELTME: SÄ±nÄ±flarÄ± ayÄ±rma iÅŸlemi (9 -> 9A, 9B...)
                const duzenliVeri = {};
                
                Object.values(hamVeri).forEach(ogrenciListesi => {
                    if(Array.isArray(ogrenciListesi)){
                        ogrenciListesi.forEach(ogr => {
                            const sinifAdi = ogr["SÄ±nÄ±fÄ±nÄ±z"]; 
                            if(sinifAdi) {
                                if(!duzenliVeri[sinifAdi]) {
                                    duzenliVeri[sinifAdi] = [];
                                }
                                duzenliVeri[sinifAdi].push(ogr);
                            }
                        });
                    }
                });

                veritabani = duzenliVeri;
                siniflariDoldur();
            } catch (e) {
                console.error("VeritabanÄ± yÃ¼klenemedi:", e);
                alert("Ã–ÄŸrenci veritabanÄ± yÃ¼klenemedi!");
            }
        }

        function siniflariDoldur() {
            const siniflar = Object.keys(veritabani).sort();
            const sel1 = document.getElementById('sinifSec');
            const sel3 = document.getElementById('s3SinifSec');
            
            sel1.innerHTML = '<option value="">-- SÄ±nÄ±f SeÃ§in --</option>';
            sel3.innerHTML = '<option value="">-- SeÃ§in --</option>';

            siniflar.forEach(s => {
                sel1.innerHTML += `<option value="${s}">${s}</option>`;
                sel3.innerHTML += `<option value="${s}">${s}</option>`;
            });
            
            sel1.onchange = async function() {
                const sinif = this.value;
                if(sinif) {
                     const res = await fetch(`/grupListesiGetir?sinif=${sinif}`);
                     const kayitliGruplar = await res.json();
                     if(kayitliGruplar && kayitliGruplar.length > 0) {
                         mevcutGruplar = kayitliGruplar;
                         gruplariCiz();
                     } else {
                         document.getElementById('tablo').innerHTML = "";
                         mevcutGruplar = [];
                     }
                }
            };
        }

        function sinifiGrupla() {
            const sinif = document.getElementById('sinifSec').value;
            if (!sinif) return alert("LÃ¼tfen bir sÄ±nÄ±f seÃ§in!");
            if (!veritabani[sinif]) return alert("Bu sÄ±nÄ±fa ait veri bulunamadÄ±.");

            let ogrenciler = [...veritabani[sinif]];

            // Okul NumarasÄ±na gÃ¶re sÄ±ralama (Ä°stediÄŸiniz DÃ¼zeltme)
            ogrenciler.sort((a, b) => parseInt(a["Okul NumaranÄ±z"]) - parseInt(b["Okul NumaranÄ±z"]));

            const grupSayisi = prompt(`${sinif} sÄ±nÄ±fÄ±nda ${ogrenciler.length} Ã¶ÄŸrenci var.\nKaÃ§ grup oluÅŸturulsun?`, "6");
            if (!grupSayisi || isNaN(grupSayisi)) return;

            const n = parseInt(grupSayisi);
            mevcutGruplar = [];

            const perGroup = Math.ceil(ogrenciler.length / n);
            
            for (let i = 0; i < n; i++) {
                const start = i * perGroup;
                const end = start + perGroup;
                const grupUyeleri = ogrenciler.slice(start, end);
                
                if (grupUyeleri.length > 0) {
                    mevcutGruplar.push({
                        ad: `Grup ${i + 1}`,
                        uyeler: grupUyeleri
                    });
                }
            }
            
            gruplariCiz();
        }

        function gruplariCiz() {
            const div = document.getElementById('tablo');
            div.innerHTML = "";
            
            mevcutGruplar.forEach(g => {
                let html = `
                <div class="grup">
                    <h3>${g.ad}</h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%;">Okul No</th>
                                <th>AdÄ± SoyadÄ±</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                g.uyeler.forEach(u => {
                    let adSoyad = u["AdÄ±nÄ±z SoyadÄ±nÄ±z"] || "";
                    adSoyad = adSoyad.toLocaleUpperCase('tr-TR');

                    html += `
                        <tr>
                            <td style="text-align: center;"><b>${u["Okul NumaranÄ±z"]}</b></td>
                            <td>${adSoyad}</td>
                        </tr>`;
                });

                html += `</tbody></table></div>`;
                div.innerHTML += html;
            });
        }

        async function gruplariKaydet() {
            const sinif = document.getElementById('sinifSec').value;
            if (!sinif || mevcutGruplar.length === 0) return alert("Kaydedilecek grup yok!");

            try {
                const res = await fetch('/kaydet', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sinif: sinif,
                        gruplar: mevcutGruplar
                    })
                });
                const result = await res.json();
                if(result.status === "ok") alert("Gruplar baÅŸarÄ±yla kaydedildi!");
                else alert("Hata oluÅŸtu.");
            } catch(e) { console.error(e); alert("Sunucu hatasÄ±."); }
        }
        
        async function gruplariSil() {
             const sinif = document.getElementById('sinifSec').value;
             if(!sinif) return;
             if(!confirm("Bu sÄ±nÄ±fa ait kayÄ±tlÄ± gruplarÄ± silmek istediÄŸinize emin misiniz?")) return;
             
             try {
                await fetch('/calismaSil', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({ calismaIsmi: sinif + "GruplarÄ±" })
                });
                document.getElementById('tablo').innerHTML = "";
                mevcutGruplar = [];
                alert("Silindi.");
             } catch(e) { alert("Hata"); }
        }

        // --- Ã‡ALIÅžMA Ä°Ã‡ERÄ°ÄžÄ° (SEKME 2) ---
        
        let calismalar = [];

        async function calismaListesiGetir() {
            try {
                const res = await fetch('/listeCalismalar');
                const dosyalar = await res.json();
                calismalar = dosyalar.filter(d => d.startsWith("qwx")).map(d => d.replace("qwx","").replace(".json",""));
                
                const ul = document.getElementById('calismaListesi');
                const sel3 = document.getElementById('s3CalismaSec');
                ul.innerHTML = "";
                sel3.innerHTML = '<option value="">-- SeÃ§in --</option>';

                calismalar.forEach(c => {
                    ul.innerHTML += `<li onclick="calismaSec('${c}', this)">${c}</li>`;
                    sel3.innerHTML += `<option value="${c}">${c}</option>`;
                });
            } catch(e) { console.error("Liste hatasÄ±:", e); }
        }

        function calismaSec(isim, el) {
            seciliCalisma = isim;
            const items = document.querySelectorAll('#calismaListesi li');
            items.forEach(i => i.classList.remove('selected'));
            if(el) el.classList.add('selected');
        }

        function yeniCalisma() {
            seciliCalisma = null;
            document.getElementById('listeEkrani').style.display = "none";
            document.getElementById('editorEkrani').style.display = "block";
            document.getElementById('editorBaslik').innerText = "Yeni Ã‡alÄ±ÅŸma OluÅŸtur";
            document.getElementById('calismaAdiInput').value = "";
            document.getElementById('calismaAciklama').value = "";
            document.getElementById('soruAlani').innerHTML = "";
        }

        async function calismaDuzenle() {
            if(!seciliCalisma) return alert("LÃ¼tfen listeden bir Ã§alÄ±ÅŸma seÃ§in.");
            
            try {
                const res = await fetch(`/calismaGetir?isim=qwx${seciliCalisma}.json`);
                if(!res.ok) throw new Error("Ã‡alÄ±ÅŸma alÄ±namadÄ±");
                const icerik = await res.json(); 

                document.getElementById('listeEkrani').style.display = "none";
                document.getElementById('editorEkrani').style.display = "block";
                document.getElementById('editorBaslik').innerText = "Ã‡alÄ±ÅŸmayÄ± DÃ¼zenle";
                document.getElementById('calismaAdiInput').value = seciliCalisma;
                document.getElementById('calismaAciklama').value = icerik.aciklama || "";
                document.getElementById('soruAlani').innerHTML = "";
                
                if(icerik.sorular) {
                    icerik.sorular.forEach(s => soruEkleUI(s));
                }
            } catch(e) { alert("Hata: " + e.message); }
        }

        function editorKapat() {
            document.getElementById('editorEkrani').style.display = "none";
            document.getElementById('listeEkrani').style.display = "block";
            calismaListesiGetir();
        }
        
        function soruEkleUI(veri = null) {
            const div = document.createElement('div');
            div.className = "soru-item";
            div.style.marginBottom = "15px";
            div.style.padding = "10px";
            div.style.border = "1px solid #eee";
            div.style.background = "#f9f9f9";
            
            const valSoru = veri ? veri.soru : "";
            const valCevaplar = veri ? (veri.cevaplar || []).join("\n") : "";
            const valDogru = veri ? veri.dogru : "";
            const valMedya = veri ? (veri.medya || "") : "";

            div.innerHTML = `
                <div><b>Soru Metni:</b> <input type="text" class="inp-soru" value="${valSoru}" style="width:100%"></div>
                <div style="margin-top:5px;"><b>Medya Link (Resim/Video opsiyonel):</b> <input type="text" class="inp-medya" value="${valMedya}" style="width:100%"></div>
                <div style="margin-top:5px;"><b>Cevap ÅžÄ±klarÄ± (Her satÄ±ra bir ÅŸÄ±k):</b><br>
                <textarea class="inp-cevaplar" style="width:100%; height:60px;">${valCevaplar}</textarea></div>
                <div style="margin-top:5px;"><b>DoÄŸru Cevap (ÅžÄ±kkÄ±n aynÄ±sÄ±):</b> <input type="text" class="inp-dogru" value="${valDogru}" style="width:100%"></div>
                <button onclick="this.parentElement.remove()" style="margin-top:5px;" class="btn-archive-small red">Soruyu Sil</button>
            `;
            document.getElementById('soruAlani').appendChild(div);
        }

        async function calismaKaydet() {
            const ad = document.getElementById('calismaAdiInput').value.trim();
            if(!ad) return alert("Ã‡alÄ±ÅŸma adÄ± giriniz.");
            
            const aciklama = document.getElementById('calismaAciklama').value;
            const soruDivs = document.querySelectorAll('.soru-item');
            const sorular = [];
            
            soruDivs.forEach(div => {
                const s = div.querySelector('.inp-soru').value;
                const m = div.querySelector('.inp-medya').value;
                const cText = div.querySelector('.inp-cevaplar').value;
                const d = div.querySelector('.inp-dogru').value;
                
                if(s) {
                    sorular.push({
                        soru: s,
                        medya: m,
                        cevaplar: cText.split('\n').filter(x=>x.trim()!==""),
                        dogru: d
                    });
                }
            });

            const payload = {
                calismaIsmi: "qwx" + ad,
                sorular: {
                    aciklama: aciklama,
                    sorular: sorular
                }
            };

            await fetch('/calismaKaydet', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            alert("Kaydedildi!");
            editorKapat();
        }

        async function calismaSil() {
            if(!seciliCalisma) return;
            if(!confirm("Silmek istediÄŸinize emin misiniz?")) return;
            await fetch('/calismaSil', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ calismaIsmi: "qwx" + seciliCalisma })
            });
            calismaListesiGetir();
        }
        
        async function arsivModalAc() {
             const res = await fetch('/arsivListesi');
             const list = await res.json();
             const ul = document.getElementById('arsivListesiUl');
             ul.innerHTML = "";
             list.forEach(isim => {
                 const temiz = isim.replace("qwx","").replace(".json","");
                 ul.innerHTML += `<li>${temiz} <button onclick="arsivdenCikar('${isim}')" class="btn-archive-small">Geri YÃ¼kle</button></li>`;
             });
             document.getElementById('arsivModal').style.display = "block";
        }
        
        async function arsivdenCikar(isim) {
            await fetch('/arsivdenGeriYukle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ dosyaIsmi: isim })
            });
            document.getElementById('arsivModal').style.display = "none";
            calismaListesiGetir();
        }

        // --- ATAMA (SEKME 3: ORÄ°JÄ°NAL HALÄ°) ---
        async function atamaYap() {
            const sinif = document.getElementById('s3SinifSec').value;
            const calisma = document.getElementById('s3CalismaSec').value;
            const yontem = document.getElementById('s3YontemSec').value;
            
            if(!sinif || !calisma) return alert("SeÃ§im yapÄ±nÄ±z.");
            
            const payload = {
                calismaIsmi: "qqq" + sinif.replace(/\s/g,'') + calisma,
                sorular: { 
                    sinif: sinif,
                    calisma: calisma,
                    yontem: yontem,
                    gorme: true,
                    yapma: true,
                    degerl: true,
                    sure: 0,
                    bitis: ""
                }
            };
            
            await fetch('/calismaKaydet', {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify(payload)
            });
            alert("Atama yapÄ±ldÄ±!");
            
            const ul = document.getElementById('atananListesi');
            ul.innerHTML += `<li>${sinif} - ${calisma} (${yontem})</li>`;
        }

    </script>
</body>
</html>